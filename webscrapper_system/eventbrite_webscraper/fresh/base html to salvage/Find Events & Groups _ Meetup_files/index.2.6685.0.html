<!DOCTYPE html>
<!-- saved from url=(0057)https://apps.rokt.com/wsdk/controller/index.2.6685.0.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="Content-Security-Policy" content="base-uri &#39;self&#39;; object-src &#39;none&#39;; script-src &#39;self&#39; https://apps.rokt.com &#39;sha256-IGV4fN1/8SMMMf78c8Uxj6uWhLfLAYr4EkP5JY5jXmY=&#39;; style-src &#39;self&#39;; default-src &#39;none&#39;; frame-src &#39;self&#39; https://apps.rokt.com; connect-src &#39;self&#39; https://apps.rokt.com https://apps-demo.rokt.com https://sourcemaps-wsdk.roktinternal.com; img-src &#39;self&#39; data:">
    
    <title>Rokt - Controller</title>
    <!--<base href="./">--><base href=".">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="data:;base64,=">
  </head>
  <body><script type="module">(()=>{var __webpack_modules__={616:module=>{self,module.exports=(()=>{"use strict";var e={d:(o,t)=>{for(var n in t)e.o(t,n)&&!e.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:t[n]})},o:(e,o)=>Object.prototype.hasOwnProperty.call(e,o),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},o={};e.r(o),e.d(o,{ERROR_LIMIT:()=>t,reportError:()=>a});const t=10;let n=0,r=!1;const a=async(e,o)=>{var a;if(e.handled)return;if(!e.bypassErrorLimit&&n>=t){if(r)return;e.code="ERROR_LIMIT_EXCEEDED",r=!0}n++;const i=(1e7*Math.random()).toFixed(0).toString(),d=function(e,o){var t;const n=new URLSearchParams;return n.append("error_id",o),n.append("use_sandbox",(null===(t=e.useSandbox)||void 0===t?void 0:t.toString())||"false"),n.append("partner_origin",window.location.origin),n.append("rokt_tag_id",e.tagId||""),n.append("severity",e.severity||"WARNING"),n.append("reporter",e.reporter?`frame-${e.reporter}`:"frame"),e.code&&n.append("code",e.code),e.integration&&n.append("integration",e.integration),e.stack&&n.append("stack",e.stack.substring(0,400)),e.additionalInformation=Object.assign({name:e.name,message:e.message},e.additionalInformation),n.append("additional_information",JSON.stringify(e.additionalInformation)),n}(e,i),p=document.createElement("iframe");p.src=`${o||"https://apps.rokt.com"}/wsdk/reporter/index.2.6685.0.html?${d.toString()}`,p.style.display="none";const s=new Promise((e=>{const o=t=>{var n,r,a;"Rokt.Reporter.Close"!==(null===(n=t.data)||void 0===n?void 0:n.action)&&(null===(a=null===(r=t.data)||void 0===r?void 0:r.payload)||void 0===a?void 0:a.errorId)!==i||(e(),window.removeEventListener("message",o))};window.addEventListener("message",o)}));(window.document.body||window.document.head).appendChild(p),await s,null===(a=p.parentElement)||void 0===a||a.removeChild(p)};return o})()}},__webpack_module_cache__={};function __webpack_require__(moduleId){var cachedModule=__webpack_module_cache__[moduleId];if(void 0!==cachedModule)return cachedModule.exports;var module=__webpack_module_cache__[moduleId]={exports:{}};return __webpack_modules__[moduleId](module,module.exports,__webpack_require__),module.exports}(()=>{"use strict";const SameSite_Lax="lax",SameSite_None="none",SameSite_Strict="strict";class CookieService{constructor(window){this.window=window}getCookie(name){try{const match=this.window.document.cookie.match(new RegExp("(^| )"+name+"=([^;]+)"));if(match)return match[2]}catch(e){}}setCookie(c,useBaseDomain=!1){try{useBaseDomain&&(c.domain=this.getBaseDomain()),this.window.document.cookie=this.serialize(c)}catch(error){}}getBaseDomain(){const hostname=this.window.location.hostname,parts=hostname.split("."),tld=parts.pop(),domain=parts.pop();return domain&&tld?`.${domain}.${tld}`:hostname}serialize(cookie){const{name,path="/",sameSite,secure,value,domain}=cookie;let{expires}=cookie;if(!expires){const date=new Date;date.setTime(date.getTime()+31536e6),expires=date}let str=`${name}=${value};expires=${expires.toUTCString()};path=${path}`;return domain&&(str+=`;domain=${domain}`),secure&&(str+=";secure"),sameSite&&(str+=`;samesite=${sameSite}`),str}}const GetWindowError_NO_WINDOW="NO_WINDOW",getWindow=()=>{if("undefined"==typeof window)throw new Error(GetWindowError_NO_WINDOW);return window};class StorageService{constructor(window,type="local"){this.window=window,this._store="session"===type?"sessionStorage":"localStorage"}getItem(key){try{const value=this.window[this._store].getItem(key);if(null===value)return;return value}catch(error){return}}setItem(key,value){try{this.window[this._store].setItem(key,value)}catch(error){}}}class LocalStorageService extends StorageService{constructor(window){super(window,"local")}}class SessionStorageService extends StorageService{constructor(window){super(window,"session"),this.persistentMemoryMap=new Map}getItem(key){try{let value=super.getItem(key);return void 0!==value?value:(value=this.persistentMemoryMap.get(key),null!=value?(super.setItem(key,value),value):void 0)}catch(error){return}}setItem(key,value){try{this.persistentMemoryMap.set(key,value),super.setItem(key,value)}catch(error){}}}const wsdk_error_WSDKErrorSeverity={ERROR:"ERROR",INFO:"INFO",WARNING:"WARNING"};class ContextualError extends Error{constructor(context){var _a,_b;super(context.code),this.name=null!==(_a=context.name)&&void 0!==_a?_a:this.name,this.message=context.message||context.code||"",this.code=context.code,this.additionalInformation=context.additionalInformation,this.handled=null!==(_b=context.handled)&&void 0!==_b&&_b,this.severity=context.severity||wsdk_error_WSDKErrorSeverity.ERROR,this.integration=context.integration,this.reporter=context.reporter,context.stack&&(this.stack=context.stack)}}const error_codes_ErrorCodes={EVENT_RESPONSE:"EVENT_RESPONSE",TOKEN_NOT_FOUND:"TOKEN_NOT_FOUND",UNKNOWN_ERROR:"UNKNOWN_ERROR",UNHANDLED_EXCEPTION:"UNHANDLED_EXCEPTION",LOAD_EVENT_DATA_FAILED:"LOAD_EVENT_DATA_FAILED",SAVE_EVENT_DATA_FAILED:"SAVE_EVENT_DATA_FAILED",UPDATE_EVENT_DATA_FAILED:"UPDATE_EVENT_DATA_FAILED",GET_EVENT_DATA_FAILED:"GET_EVENT_DATA_FAILED",ERROR_LIMIT_EXCEEDED:"ERROR_LIMIT_EXCEEDED",WARNING_LIMIT_EXCEEDED:"WARNING_LIMIT_EXCEEDED",EXPERIENCES_CALL_FAILED:"EXPERIENCES_CALL_FAILED",SESSION_LIMIT_EXCEEDED:"SESSION_LIMIT_EXCEEDED",LAUNCHER_VERSION:"LAUNCHER_VERSION",LAYOUT_RECEIVED:"LAYOUT_RECEIVED",TERMINATE_FAILED:"TERMINATE_FAILED",CONTROLLER_CONNECTION_TIMEOUT:"CONTROLLER_CONNECTION_TIMEOUT",LATE_CONTROLLER_CONNECTION:"LATE_CONTROLLER_CONNECTION",PLUGIN_INITIALIZATION_TIMEOUT:"PLUGIN_INITIALIZATION_TIMEOUT",INVALID_METRICS:"INVALID_METRICS",REQUEST_FAILED:"REQUEST_FAILED",METRICS_REQUEST_FAILED:"METRICS_REQUEST_FAILED",TIMINGS_REQUEST_FAILED:"TIMINGS_REQUEST_FAILED",TIMINGS_EVENTS_REQUEST_FAILED:"TIMINGS_EVENTS_REQUEST_FAILED",SELECTION_MADE_FOR_CONVERSION:"SELECTION_MADE_FOR_CONVERSION",HASHING_FAILED:"HASHING_FAILED",PAGE_IDENTIFIER_DOES_NOT_EXIST:"PAGE_IDENTIFIER_DOES_NOT_EXIST",SELECTOR_ELEMENT_NOT_FOUND:"SELECTOR_ELEMENT_NOT_FOUND",ROKT_FIRST_TOUCH_NOT_SET:"ROKT_FIRST_TOUCH_NOT_SET",ROKT_COOKIES_FAILED:"ROKT_COOKIES_FAILED",ROKT_LOCALSTORAGE_FAILED:"ROKT_LOCALSTORAGE_FAILED",ROKT_LOCATION_BEGIN_FAILED:"ROKT_LOCATION_BEGIN_FAILED",ROKT_LOCATION_CHANGE_FAILED:"ROKT_LOCATION_CHANGE_FAILED",PLUGIN_ALREADY_APPENDED:"PLUGIN_ALREADY_APPENDED",EXTENSION_INITIALIZATION:"EXTENSION_INITIALIZATION",EXTENSION_SELECTION_ERROR:"EXTENSION_SELECTION_ERROR",PLUGIN_MISSIZED:"PLUGIN_MISSIZED",PLUGIN_COVERED:"PLUGIN_COVERED",PLUGIN_COVERED_FULL:"PLUGIN_COVERED_FULL",GET_PARTNER_LAUNCHER_EXTENSION:"GET_PARTNER_LAUNCHER_EXTENSION",DOMAIN_TRANSFER:"DOMAIN_TRANSFER",DUPLICATE_TIMING_METRICS:"DUPLICATE_TIMING_METRICS",PLUGIN_PRELOADED_IFRAME_NOT_FOUND:"PLUGIN_PRELOADED_IFRAME_NOT_FOUND",EXTERNAL_EVENT_ERROR:"EXTERNAL_EVENT_ERROR",DOMAIN_PATTERN_MAPPING_NOT_FOUND:"DOMAIN_PATTERN_MAPPING_NOT_FOUND",V2_METRICS_REQUEST_FAILED:"V2_METRICS_REQUEST_FAILED",V1_EVENT_RESPONSE_REQUEST_FAILED:"V1_EVENT_RESPONSE_REQUEST_FAILED",V1_METRICS_REQUEST_FAILED:"V1_METRICS_REQUEST_FAILED",V1_EXPERIENCES_REQUEST_FAILED:"V1_EXPERIENCES_REQUEST_FAILED",EXTENSION_INITIALIZATION_ERROR:"EXTENSION_INITIALIZATION_ERROR",EXTENSION_LOAD_ERROR:"EXTENSION_LOAD_ERROR",DOMAIN_EXTENSION_MAPPING_ERROR:"DOMAIN_EXTENSION_MAPPING_ERROR"},fallbackErrorContext={code:error_codes_ErrorCodes.UNKNOWN_ERROR,severity:wsdk_error_WSDKErrorSeverity.ERROR};function create_contextual_error_createContextualError(error,defaultContext={}){const context=Object.assign(Object.assign({},fallbackErrorContext),defaultContext);if((unknownObj=error)&&"object"==typeof unknownObj){const wsdkError=error;wsdkError.name&&(context.name=wsdkError.name),wsdkError.message&&(context.message=wsdkError.message),wsdkError.stack&&(context.stack=wsdkError.stack),wsdkError.code&&(context.code=wsdkError.code),wsdkError.reporter&&(context.reporter=wsdkError.reporter),wsdkError.integration&&(context.integration=wsdkError.integration),wsdkError.severity&&(context.severity=wsdkError.severity),void 0!==wsdkError.handled&&(context.handled=wsdkError.handled),wsdkError.additionalInformation&&(context.additionalInformation=Object.assign(Object.assign({},context.additionalInformation),wsdkError.additionalInformation))}var unknownObj;return new ContextualError(context)}const REFERRAL_ID_LEGACY_KEY="rtid",REFERRAL_ID_STORAGE_KEY="RoktTransactionId",PartnerEvent_DISPLAY_SETTINGS_SET="DISPLAY_SETTINGS_SET",constants_error_codes_ErrorCodes_CONTROLLER_FRAME_LOAD="CONTROLLER_FRAME_LOAD",constants_error_codes_ErrorCodes_INVALID_NEXT_JOURNEY_STAGE="INVALID_NEXT_JOURNEY_STAGE",constants_error_codes_ErrorCodes_JOURNEY_NOT_INITIALISED="JOURNEY_NOT_INITIALISED",constants_error_codes_ErrorCodes_PLACEMENT_NOT_FOUND="PLACEMENT_NOT_FOUND",constants_error_codes_ErrorCodes_PUT_STYLES="PUT_STYLES",constants_error_codes_ErrorCodes_RESIZE_DETECTION="RESIZE_DETECTION",constants_error_codes_ErrorCodes_SANDBOX_ATTRIBUTES="SANDBOX_ATTRIBUTES",constants_error_codes_ErrorCodes_SET_TITLE="SET_TITLE",constants_error_codes_ErrorCodes_V1_METRIC_FAILURE="V1_METRIC_FAILURE",constants_error_codes_ErrorCodes_URL_CHILD_PLUGIN_CREATED="URL_CHILD_PLUGIN_CREATED",constants_error_codes_ErrorCodes_ONS_EVENTS_WARNING_THRESHOLD_EXCEEDED="ONS_EVENTS_WARNING_THRESHOLD_EXCEEDED",constants_error_codes_ErrorCodes_INVALID_CONTROLLER_REMOTE_CALL="INVALID_CONTROLLER_REMOTE_CALL";var integration=__webpack_require__(616);const AttributeKeys_UserAgent="userAgent",AttributeKeys_ClientType="clientType",AttributeKeys_PassbackConversionId="passbackconversiontrackingid",IntegrationType_Preload="preload",IntegrationType_PreloadPersistent="preload_persistent",error_error_codes_ErrorCodes_SIMULTANEOUS_SELECTION="SIMULTANEOUS_SELECTION",error_error_codes_ErrorCodes_NO_ATTRIBUTES="NO_ATTRIBUTES",error_error_codes_ErrorCodes_EXTENSION_VX_ATTRIBUTE_TIMEOUT="EXTENSION_VX_ATTRIBUTE_TIMEOUT",event_type_EventType_AttributesCapture="ATTRIBUTES_CAPTURE",event_type_EventType_AttributesCaptureFailure="ATTRIBUTES_CAPTURE_FAILURE",event_type_EventType_PageIdUpdated="PAGE_ID_UPDATED",event_type_EventType_PageInstanceGuidUpdated="PAGE_INSTANCE_GUID_UPDATED",event_type_EventType_PageVariantNameUpdated="PAGE_VARIANT_NAME_UPDATED",event_type_EventType_SessionIdUpdated="SESSION_ID_UPDATED",event_type_EventType_SessionInformationUpdated="SESSION_INFORMATION_UPDATED";class Reporter{constructor(_window){this._window=_window,this._ignoredErrorCodes=["HASHING_FAILED"],this._integrationUrl=_window.location.origin,this._errorReporter=this._defaultReporter,this._window.onerror=(...args)=>{const error=args[Reporter._onErrorIndex];return this._reportError(error),!0},this._window.addEventListener("unhandledrejection",(({reason})=>{this._reportError(reason)}))}set(reporter){this._errorReporter=reporter}_reportError(err){let errReport=err;err&&(err instanceof Error||err.code)||(errReport=new ContextualError({message:JSON.stringify(err)})),this._shouldIgnoreReporting(errReport)||(errReport.code||(errReport.code=error_codes_ErrorCodes.UNHANDLED_EXCEPTION),errReport.reporter="global",this._errorReporter(errReport))}_shouldIgnoreReporting(err){return!!this._ignoredErrorCodes.includes(err.code)||err.integration===IntegrationType_Preload&&err.severity===wsdk_error_WSDKErrorSeverity.INFO}_defaultReporter(err){(0,integration.reportError)(Object.assign(Object.assign({},err),{message:err.message,name:err.name,tagId:"",stack:err.stack}),this._integrationUrl)}}function getIntegrationUrl(url){const pathname=url.pathname,wsdkControllerPattern=/\/wsdk\/controller\/index(\.[0-9a-zA-Z.]+)?\.html$/i;return wsdkControllerPattern.test(pathname)?url.href.replace(wsdkControllerPattern,""):`${url.protocol}//${url.host}`}Reporter._onErrorIndex=4;const global_reporter_main=()=>{const window=getWindow();"true"==="false".toLowerCase()&&(0,integration.reportError)({message:constants_error_codes_ErrorCodes_CONTROLLER_FRAME_LOAD,name:constants_error_codes_ErrorCodes_CONTROLLER_FRAME_LOAD,code:constants_error_codes_ErrorCodes_CONTROLLER_FRAME_LOAD,severity:wsdk_error_WSDKErrorSeverity.INFO,tagId:"",additionalInformation:{controllerFrameName:window.name}},getIntegrationUrl(new URL(window.location.href))),window.roktReporter=new Reporter(window)},error_codes_ExtensionErrorCodes_EXTENSION_NOT_OPTED_IN="EXTENSION_NOT_OPTED_IN",error_codes_ExtensionErrorCodes_EXTENSION_PLUGIN_EVENT_SETUP_ERROR="EXTENSION_PLUGIN_EVENT_SETUP_ERROR",events_EventSlots_onPartnerDataReceived="onPartnerDataReceived",events_EventSlots_onServiceContainerReady="onServiceContainerReady",events_EventSlots_onReceivedPluginEvent="onReceivedPluginEvent",events_EventSlots_onGetReferralId="onGetReferralId",noop=()=>{},normaliseToObserver=(next=noop,error=noop,complete=noop)=>"function"!=typeof next?next:{next,error,complete};class Subscription{constructor(){this._subscribers=[]}add(subscriber){this._subscribers.push(subscriber)}unsubscribe(){this._subscribers.forEach((s=>s.unsubscribe()))}}class Observable{constructor(setupFn){this._setupFn=setupFn}subscribe(callbackOrObserver,error,complete){const observer=normaliseToObserver(callbackOrObserver,error,complete);let teardown,active=!0;const internalObserver={next:v=>{active&&observer.next(v)},complete:()=>{active&&(teardown&&teardown(),observer.complete(),active=!1)},error:err=>{active&&(observer.error(err),active=!1)}};teardown=this._setupFn(internalObserver),active||teardown&&teardown();const subscription=new Subscription;return subscription.add({unsubscribe:()=>{teardown&&teardown(),active=!1}}),subscription}}class Subject extends Observable{constructor(){super((observer=>(this._isComplete&&observer.complete(),this._observers.push(observer),()=>this._observers=this._observers.filter((c=>c!==observer))))),this._observers=[],this._isComplete=!1}next(value){for(const observer of this._observers)observer.next(value)}error(error){for(const observer of this._observers)observer.error(error)}complete(){this._isComplete=!0;for(const observer of this._observers)observer.complete()}asObservable(){return new Observable((observer=>{const sub=this.subscribe(observer);return()=>sub.unsubscribe()}))}}class BehaviorSubject extends Subject{constructor(initialValue){super(),this._lastValue=initialValue}subscribe(callbackOrObserver,error,complete){const observer=normaliseToObserver(callbackOrObserver,error,complete);return observer.next(this._lastValue),super.subscribe(observer)}next(value){return this._lastValue=value,super.next(value)}getValue(){return this._lastValue}}class ReplaySubject extends Subject{constructor(bufferLength=-1){super(),this._buffer=[],this._error=null,this._bufferLength=bufferLength}subscribe(callbackOrObserver,error,complete){const observer=normaliseToObserver(callbackOrObserver,error,complete);let noError=!0;return this._buffer.filter((value=>(value===this._error&&(noError=!1),noError))).forEach((v=>observer.next(v))),this._error&&observer.error(this._error),observer.error=observedError=>{this._error=observedError,error(observedError)},super.subscribe(observer)}next(value){this._error||this._addToBuffer(value),super.next(value)}error(error){this._error=error,this._addToBuffer(error),super.error(error)}_addToBuffer(value){-1!==this._bufferLength&&this._buffer.length===this._bufferLength?(this._buffer.shift(),this._buffer.push(value)):this._buffer.push(value)}}const FirstValueFromError_CompletedBeforeEmit="CompletedBeforeEmit",first_value_from_firstValueFrom=(source,config)=>{let subscription;const hasDefaultValue="object"==typeof config;return new Promise(((resolve,reject)=>{subscription=source.subscribe(resolve,reject,(()=>{hasDefaultValue?resolve(config.defaultValue):reject(new Error(FirstValueFromError_CompletedBeforeEmit))}))})).then((v=>(subscription.unsubscribe(),v))).catch((error=>{throw subscription.unsubscribe(),error}))},from_event_fromEvent=(target,eventName)=>new Observable((observer=>{const listener=event=>observer.next(event);return target.addEventListener(eventName,listener),()=>target.removeEventListener(eventName,listener)})),merge=(...sources)=>new Observable((observer=>{const subscription=new Subscription;let totalComplete=0;for(const source of sources)subscription.add(source.subscribe((v=>observer.next(v)),(e=>observer.error(e)),(()=>{totalComplete+=1,totalComplete>=sources.length&&observer.complete()})));return()=>subscription.unsubscribe()})),combineLatest=(...sources)=>new Observable((observer=>{if(!sources.length)return observer.complete(),noop;const subscription=new Subscription,set=new Array(sources.length),buffer=new Array(sources.length),next=value=>!set.includes(void 0)&&observer.next(value);for(let i=0;i<sources.length;i++){const s=sources[i].subscribe((value=>{buffer[i]=value,set[i]=!0,next(buffer)}));subscription.add(s)}return()=>subscription.unsubscribe()}));const extensionSubject$=new ReplaySubject,setExtensionVNextData=(data,source="launcher")=>{const event={data,source,type:events_EventSlots_onPartnerDataReceived};extensionSubject$.next(event)},passPluginEvent$=event=>{const receivedEvent={data:event,type:events_EventSlots_onReceivedPluginEvent};extensionSubject$.next(receivedEvent)};class ExtensionVNextAPI{constructor(_reportError){this._reportError=_reportError,this._optedInExtensions=new Set}setExtensionData(partnerData){setExtensionVNextData(partnerData),Object.entries(partnerData).forEach((([extensionName])=>{this._optedInExtensions.has(extensionName)||this._reportError(create_contextual_error_createContextualError({code:error_codes_ExtensionErrorCodes_EXTENSION_NOT_OPTED_IN,severity:wsdk_error_WSDKErrorSeverity.WARNING,additionalInformation:{extensionName}}))}))}registerExtension(extension){this._optedInExtensions.add(extension)}}class Operation{constructor(value){this.value=value,this.complete=!1,this.skip=!1}}var pipe_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const pipe_pipe=target$=>(...ops)=>new Observable((observer=>{const sub=target$.subscribe((value=>pipe_awaiter(void 0,void 0,void 0,(function*(){try{let state=new Operation(value);for(const op of ops){const update=op(state);if(state=update.then?yield update:update,!0===state.skip||!0===state.complete)break}if(state.skip)return;observer.next(state.value),!0===state.complete&&observer.complete()}catch(error){observer.error(error)}}))),(error=>observer.error(error)),(()=>observer.complete()));return()=>sub.unsubscribe()})),filter_filter=predicate=>op=>(!1===predicate(op.value)&&(op.skip=!0),op),first=predicate=>op=>(predicate?!0===predicate(op.value)?op.complete=!0:op.skip=!0:op.complete=!0,op),map_map=cb=>op=>{const value=cb(op.value);return new Operation(value)},tap_tap=cb=>op=>(cb(op.value),op),TimingMetrics_timeOrigin="timeOrigin",TimingMetrics_lastLocationChange="lastLocationChange",TimingMetrics_pageVisible="pageVisible",TimingMetrics_launcherScriptRequestStart="launcherScriptRequestStart",TimingMetrics_launcherScriptRequestEnd="launcherScriptRequestEnd",TimingMetrics_controllerScriptRequestStart="controllerScriptRequestStart",TimingMetrics_controllerScriptRequestEnd="controllerScriptRequestEnd",TimingMetrics_frameworkStart="frameworkStart",TimingMetrics_frameworkEnd="frameworkEnd",TimingMetrics_partnerSelectPlacements="partnerSelectPlacements",TimingMetrics_selectionStart="selectionStart",TimingMetrics_experiencesRequestStart="experiencesRequestStart",TimingMetrics_experiencesRequestEnd="experiencesRequestEnd",TimingMetrics_selectionEnd="selectionEnd",TimingMetrics_pluginScriptRequestStart="pluginScriptRequestStart",TimingMetrics_pluginScriptRequestEnd="pluginScriptRequestEnd",TimingMetrics_pluginBootStrapStart="pluginBootStrapStart",TimingMetrics_pluginBootstrapEnd="pluginBootstrapEnd",TimingMetrics_placementInteractive="placementInteractive",TimingMetrics_confirmationPageLoad="confirmationPageLoad",TimingMetrics_domContentLoadedEventStart="domContentLoadedEventStart",SharedHeaderKey_ROKT_INTEGRATION_TYPE="rokt-integration-type",SharedHeaderKey_ROKT_PAGE_ID_HEADER_KEY="rokt-page-id",SharedHeaderKey_ROKT_PAGE_INSTANCE_GUID="rokt-page-instance-guid",SharedHeaderKey_ROKT_SDK_INTEGRATION="rokt-sdk-framework-type",SharedHeaderKey_ROKT_SDK_VERSION="rokt-sdk-version",SharedHeaderKey_ROKT_TAG_ID="rokt-tag-id",SharedHeaderKey_ROKT_TRACE_ID="x-rokt-trace-id",SharedHeaderKey_ROKT_SELECTION_CORRELATION_ID="rokt-selection-correlation-id";var event_types_event_type_EventType,event_type_TopicType;!function(EventType){EventType[EventType.Launcher=0]="Launcher",EventType[EventType.Controller=1]="Controller",EventType[EventType.Plugin=2]="Plugin",EventType[EventType.Result=3]="Result"}(event_types_event_type_EventType||(event_types_event_type_EventType={})),function(TopicType){TopicType.EventResult="EventResult",TopicType.Launcher_DataQuery="Launcher_DataQuery",TopicType.Launcher_ControllerNotification_Ready="Launcher_ControllerNotification_Ready",TopicType.Launcher_To_Controller_RemoteCall="Launcher_To_Controller_Remote_Call"}(event_type_TopicType||(event_type_TopicType={}));const ExtensionVNextProviderType_selectionAttribute="selectionAttribute",ExtensionVNextProviderType_controllerActivated="controllerActivated",ExtensionVNextSettings={["cos-extension-detection"]:{[ExtensionVNextProviderType_selectionAttribute]:!0},["sponsored-payments-apple-pay"]:{[ExtensionVNextProviderType_selectionAttribute]:!0},["realtime-conversion-promotion"]:{[ExtensionVNextProviderType_controllerActivated]:!0},["payment-trigger"]:{[ExtensionVNextProviderType_controllerActivated]:!0},["instant-purchase"]:{[ExtensionVNextProviderType_controllerActivated]:!0},["cart-service"]:{[ExtensionVNextProviderType_controllerActivated]:!0}},launcher_ControllerAwareSubject$=new Subject,launcher_ResultObservable$=(new Subject,new Subject);new Subject,new BehaviorSubject(null);function getCrypto(){return window.crypto||window.msCrypto}function toHex(hashBuffer){return Array.from(new Uint8Array(hashBuffer)).map((b=>b.toString(16).padStart(2,"0"))).join("")}function getSha256Hex(input){return new Promise(((resolve,reject)=>{const msgUint8=function(text){if(window.TextEncoder)return(new TextEncoder).encode(text);const utf8=unescape(encodeURIComponent(text)),result=new Uint8Array(utf8.length);for(let i=0;i<utf8.length;i++)result[i]=utf8.charCodeAt(i);return result}(input),hashResult=getCrypto().subtle.digest("SHA-256",msgUint8);hashResult.then?hashResult.then((hashBuffer=>{resolve(toHex(hashBuffer))}),reject):(hashResult.oncomplete=evt=>{const hashBuffer=evt.target.result;resolve(toHex(hashBuffer))},hashResult.onerror=evt=>{reject(evt)})}))}function guid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(c=>{return(("y"===c?8:0)^(arr=new Uint8Array(1),getCrypto().getRandomValues(arr))[0]&15>>("y"===c?2:0)).toString(16);var arr}))}const createRoktQueryEvent=(handler,topic,body)=>({id:getUniqueId(),identifier:"Rokt-Events",topic,body,handler}),getUniqueId=()=>guid();function isFunction(result){return"function"==typeof result}const createSingleRemoteCallProxy=(init={},complexObjectId,index)=>new Proxy(init,{get:function(_target,functionName){if("then"!==functionName)return functionName in _target?_target[functionName]:(...args)=>{const event={id:getUniqueId(),identifier:"Rokt-Events",handler:event_types_event_type_EventType.Controller,topic:event_type_TopicType.Launcher_To_Controller_RemoteCall,body:{args,function:functionName}};complexObjectId&&(event.complexObjectId=complexObjectId),void 0!==index&&(event.complexObjectIndex=index);const resultOb$=pipe_pipe(launcher_ResultObservable$)(filter_filter((r=>r.id===event.id)),map_map((e=>({resultComplexObjectId:e.complexObjectId,result:e.result,isComplexArray:e.isComplexArray})))),resultPromise$=first_value_from_firstValueFrom(resultOb$);launcher_ControllerAwareSubject$.next(event);const resultProxy=new Proxy({},{get:(_,resultFunctionName)=>(...args)=>resultOb$[resultFunctionName]?pipe_pipe(resultOb$)(map_map((({result,resultComplexObjectId,isComplexArray})=>resultComplexObjectId?createRemoteCallProxy(result,resultComplexObjectId,isComplexArray):result)))[resultFunctionName](...args):resultPromise$[resultFunctionName]?resultPromise$.then((({result,resultComplexObjectId,isComplexArray})=>resultComplexObjectId?createRemoteCallProxy(result,resultComplexObjectId,isComplexArray):result))[resultFunctionName](...args):{}});return resultProxy}}}),createRemoteCallProxy=(init={},complexObjectId,isComplexArrayType)=>isComplexArrayType?Array.isArray(init)?init.map(((item,idx)=>createSingleRemoteCallProxy(item,complexObjectId,idx))):init:createSingleRemoteCallProxy(init,complexObjectId),interfaces_Method_GET=(createRemoteCallProxy(),"GET"),interfaces_Method_POST="POST",interfaces_Method_PUT="PUT";class HttpClientService{constructor(_window){this._window=_window}get(url,headers){return this._request({url,method:interfaces_Method_GET,headers})}post({url,body={},headers,keepalive}){return this._request({url,method:interfaces_Method_POST,body,headers,keepalive})}put({url,body={},headers,keepalive}){return this._request({url,method:interfaces_Method_PUT,body,headers,keepalive})}_castHeaders(headers){const output={};return headers.forEach(((v,k)=>output[k.toLowerCase()]=v)),output}async _castBody(response){let body;return body=(response.headers.get("Content-Type")||"").includes("json")?await response.json():await response.text(),body}async _getBodyText(response,lengthLimit){const body=await response.text();return body.length>lengthLimit?body.substring(0,lengthLimit):body}_buildFetchOptions(input){var _a;const method=input.method||"GET";return!(input.headers&&input.headers["Content-Type"]||void 0)&&input.body&&"object"==typeof input.body&&(input.body=JSON.stringify(input.body),input.headers=Object.assign({"Content-Type":"application/json"},input.headers||{})),{url:input.url,options:{method,headers:input.headers,body:input.body,keepalive:null!==(_a=input.keepalive)&&void 0!==_a&&_a}}}async _request(input){const fetchOptions=this._buildFetchOptions(input),response=await this._window.fetch(fetchOptions.url,fetchOptions.options),headers=this._castHeaders(response.headers);if(!response.ok)throw create_contextual_error_createContextualError({code:error_codes_ErrorCodes.REQUEST_FAILED,severity:wsdk_error_WSDKErrorSeverity.WARNING,additionalInformation:{responseCode:JSON.stringify(response.status),responseHeaders:JSON.stringify(headers),responseStatusText:response.statusText,responseBody:await this._getBodyText(response,200),url:response.url}});return{body:await this._castBody(response),headers,status:response.status,statusText:response.statusText}}}const isBrowserExtension=integrationUrl=>{try{const url=new URL(integrationUrl);return"chrome-extension:"===url.protocol||"moz-extension:"===url.protocol||"safari-web-extension:"===url.protocol}catch(_a){return!1}},ENV_KEYS_CANARY="CANARY",ENV_KEYS_ROKT_COM_URL="ROKT_COM_URL",ENV_KEYS_DEMO_ROKT_COM_URL="DEMO_ROKT_COM_URL",ENV_KEYS_MULTI_PAGE_SESSION_BLACKLIST="MULTI_PAGE_SESSION_BLACKLIST",ENV_KEYS_NO_DEVICE_ID_PARTNERS="NO_DEVICE_ID_PARTNERS",ENV_KEYS_DEBUG="DEBUG",ENV_KEYS_VERSION="VERSION",ENV_KEYS_DOMAIN_PAGE_PATTERN_MAPPING="DOMAIN_PAGE_PATTERN_MAPPING";class EnvironmentConfigurationService{constructor(window){this._isInitLogEnabled=!0,this._origin=window.location.origin,this._globalPrivacyControl=window.navigator.globalPrivacyControl,this._userAgent=window.navigator.userAgent}getGlobalPrivacyControl(){return this._globalPrivacyControl}getUserAgent(){return this._userAgent}getApiUrl(isSandbox,proxySubPath){return isSandbox?this._getEnv(ENV_KEYS_DEMO_ROKT_COM_URL):this.isBrowserExtension()?this._getEnv(ENV_KEYS_ROKT_COM_URL):proxySubPath?`${this._origin}${proxySubPath}`:this._origin}isBrowserExtension(){return isBrowserExtension(this._origin)}isDomainProxied(){return this._origin!==this._getEnv(ENV_KEYS_ROKT_COM_URL)}getMultiPageSessionBlacklist(){return this._getEnv(ENV_KEYS_MULTI_PAGE_SESSION_BLACKLIST)}isCanary(){return"true"===this._getEnv(ENV_KEYS_CANARY).toLowerCase()}isNoDeviceIdPartner(partnerId){return this._getEnv(ENV_KEYS_NO_DEVICE_ID_PARTNERS).replace(/\s/g,"").split(",").filter((value=>!!value)).includes(partnerId)}getDebugMode(){return"true"===this._getEnv(ENV_KEYS_DEBUG).toLowerCase()}getControllerVersion(){return this._getEnv(ENV_KEYS_VERSION)}getDomainPagePatternMapping(){return this._getEnv(ENV_KEYS_DOMAIN_PAGE_PATTERN_MAPPING)}getIsInitLogEnabled(){return this._isInitLogEnabled}setIsInitLogEnabled(isInitLogEnabled){this._isInitLogEnabled=isInitLogEnabled}_getEnv(key){var _a;return null!==(_a={CANARY:"false",ROKT_COM_URL:"https://apps.rokt.com",DEMO_ROKT_COM_URL:"https://apps-demo.rokt.com",SOURCEMAP_ROKTINTERNAL_COM_URL:"https://sourcemaps-wsdk.roktinternal.com",MULTI_PAGE_SESSION_BLACKLIST:"fcc19e4c9494452d9e8fde05ce5b0026,260,2554873377920922361,2745201443439123936,2745200842143701109,2745207580947400930,2745199502113902350,2745199845711287180,2745202495706113715,2745207061256356434,2745203934520160133,2745204291002445711,2745204909477737795,2745205253075122293,2745204600240091625,2768954163069212781,2806486756987564147,2806482466315226397,2806484768417702792,2806484390460579187,2806483595891628106,2856198770055723711,2856199491610230954,2856198078565987347,2745198819214101523,2901377256164439275,3002366673326196145,2856198770055723711,2806484768417702792,2856199491610230954,2806483595891628106,2768954163069212781,2806484390460579187,2806482466315226397,2806486756987564147,2856198078565987347,3012069034512628447,3056919513968942327,3060975702558142909",NO_DEVICE_ID_PARTNERS:"2215307220479662547,2222069010832063954,2388261640774383951,2393374215224752143,2545534615780864385,2695481750969397521,2695486883455316530",DEBUG:"false",VERSION:"2.6685.0",UPSELLS_TAG_IDS:"6240a06506ec42b38f5475f577e2e5d8,18f21499ab634e598a0029da04bc9ba3,93a61038b3dd4b0c905279e0fb7f9e36,d95d8b6d8662476e8648eb91fbb49fb7,4019a66f0590412ab5b2128fd5eddcf7,669f3e389da34e3a9c5314cd7406ae0d",UPSELLS_ACCOUNT_IDS:"227,253,280,249,250,244,42",DOMAIN_PAGE_PATTERN_MAPPING:'{"pizzahut.com":"/confirmation","shutterfly.com":"#confirm.sfly","footlocker.com":"/checkout/confirm","regmovies.com":"order-success", "buffalowildwings.com":"confirmation","amctheatres.com":"confirmation","gianteagle.com":"confirm-order"}'}[key])&&void 0!==_a?_a:""}}class resolvable_promise_ResolvablePromise{constructor(){this.fulfilled=!1,this.rejected=!1,this.promise=new Promise(((resolve,reject)=>{this.resolve=resolve,this.reject=reject})).then((value=>(this.fulfilled=!0,value)),(e=>{throw this.rejected=!0,e}))}isFulfilled(){return this.fulfilled}isPending(){return!this.isFulfilled()&&!this.isRejected()}isRejected(){return this.rejected}static resolve(value){const resolvablePromise=new resolvable_promise_ResolvablePromise;return resolvablePromise.resolve(value),resolvablePromise}}class PartnerConfigurationService{constructor(){this._accountId="",this._tagId="",this._partnerId="",this._noFunctional=!1,this._noTargeting=!1,this._doNotShareOrSell=!1,this._isSandbox=!1,this._proxySubPath="",this._overrideLinkNavigation=!1,this._limitedUse=new resolvable_promise_ResolvablePromise}getAccountId(){return this._accountId}getTagId(){return this._tagId}getPartnerId(){return this._partnerId}setTagId(tagId){this._tagId=tagId}getNoFunctional(){return this._noFunctional}getNoTargeting(){return this._noTargeting}getDoNotShareOrSell(){return this._doNotShareOrSell}getDoNotTrack(){return this._noFunctional&&this._noTargeting}isSandbox(){return this._isSandbox}getRoktFirstTouch(){return this._roktFirstTouch}getLimitedUse(){return this._limitedUse.promise}getProxySubPath(){return this._proxySubPath}setAccountId(accountId){this._accountId=accountId}setPartnerId(partnerId){this._partnerId=partnerId}setNoFunctional(noFunctional){this._noFunctional=noFunctional}setNoTargeting(noTargeting){this._noTargeting=noTargeting}setDoNotShareOrSell(doNotShareOrSell){this._doNotShareOrSell=doNotShareOrSell}setSandbox(sandbox){this._isSandbox=sandbox}setRoktFirstTouch(roktFirstTouch){this._roktFirstTouch=roktFirstTouch}setLimitedUse(limitedUse){this._limitedUse.resolve(limitedUse)}setProxySubPath(subPath){this._proxySubPath=subPath}getOverrideLinkNavigation(){return this._overrideLinkNavigation}setOverrideLinkNavigation(flag){this._overrideLinkNavigation=flag}getDeepLinkingPattern(){return this._deepLinkingPattern}setDeepLinkingPattern(pattern){this._deepLinkingPattern=pattern}}class IntegrationConfigurationService{constructor(){this._customHeaders={},this._integration="",this._version="",this._launcherInstanceGuid=""}getCustomHeaders(){return this._customHeaders}getIntegration(){return this._integration}getVersion(){return this._version}getLauncherInstanceGuid(){return this._launcherInstanceGuid}setCustomHeaders(customHeaders){this._customHeaders=customHeaders}setIntegration(integration){this._integration=integration}setVersion(version){this._version=version}setLauncherInstanceGuid(launcherInstanceGuid){this._launcherInstanceGuid=launcherInstanceGuid}}class RecogniserService{constructor(_partnerService,_firstPartyRecogniserAccessor,_thirdPartyRecogniserAccessor){this._partnerService=_partnerService,this._firstPartyRecogniserAccessor=_firstPartyRecogniserAccessor,this._thirdPartyRecogniserAccessor=_thirdPartyRecogniserAccessor,this._firstPartyRecogniser={},this._thirdPartyRecogniser=new resolvable_promise_ResolvablePromise}getFirstPartyRecognisers(){return this._firstPartyRecogniser}async getThirdPartyRecognisers(){const existingEtag=this._thirdPartyRecogniserAccessor.getEtag(),etagRecogniser=!existingEtag||this._partnerService.getNoTargeting()?{}:{etag:existingEtag},recogniser=await this._thirdPartyRecogniser.promise;return Object.assign(Object.assign({},etagRecogniser),recogniser)}setFirstPartyRecognisers(localStorage,cookies){if(this._partnerService.getNoFunctional())this._firstPartyRecogniser={};else{const existingRecognisers={cookie:cookies[RECOGNISER_KEY],localStorage:localStorage[RECOGNISER_KEY]},populatedRecognisers=this._populateRecogniser(existingRecognisers);this._firstPartyRecogniser=populatedRecognisers,this._firstPartyRecogniserAccessor.set(populatedRecognisers)}}initialiseRecognisers(){this._initThirdPartyRecognisers()}setEtag(etag){this._partnerService.getNoTargeting()||this._thirdPartyRecogniserAccessor.setEtag(etag)}async _initThirdPartyRecognisers(){const foundRecogniser=this._thirdPartyRecogniserAccessor.get(),populatedRecogniser=this._populateRecogniser(foundRecogniser);if(this._partnerService.getNoTargeting())this._thirdPartyRecogniser.resolve({});else{this._thirdPartyRecogniser.resolve(populatedRecogniser);await this._partnerService.getLimitedUse()||this._thirdPartyRecogniserAccessor.set(populatedRecogniser)}}_populateRecogniser(recogniser){var _a,_b;return{cookie:null!==(_a=recogniser.cookie)&&void 0!==_a?_a:guid(),localStorage:null!==(_b=recogniser.localStorage)&&void 0!==_b?_b:guid()}}}const RECOGNISER_KEY="RoktRecogniser";class FirstPartyRecogniserAccessor{constructor(_cookieService,_localStorageService){this._cookieService=_cookieService,this._localStorageService=_localStorageService}async get(){return{cookie:await this._cookieService.then((cookies=>cookies.get(RECOGNISER_KEY))),localStorage:await this._localStorageService.then((local=>local.getItem(RECOGNISER_KEY)))}}async set(recogniser){const{cookie,localStorage}=recogniser;cookie&&await this._cookieService.then((cookies=>{cookies.set({name:RECOGNISER_KEY,value:cookie,sameSite:SameSite_Lax,secure:!0})})),localStorage&&await this._localStorageService.then((local=>{local.setItem(RECOGNISER_KEY,localStorage)}))}}class ThirdPartyRecogniserAccessor{constructor(_cookieService,_localStorageService){this._cookieService=_cookieService,this._localStorageService=_localStorageService}get(){return withGetCache(CACHE_KEYS.RECOGNISER,(()=>({cookie:this._cookieService.getCookie(RECOGNISER_KEY),localStorage:this._localStorageService.getItem(RECOGNISER_KEY)})))}set(recogniser){withSetCache(CACHE_KEYS.RECOGNISER,recogniser,(()=>{const{cookie,localStorage}=recogniser;cookie&&this._cookieService.setCookie({name:RECOGNISER_KEY,value:cookie,sameSite:SameSite_None,secure:!0}),localStorage&&this._localStorageService.setItem(RECOGNISER_KEY,localStorage)}))}getEtag(){return withGetCache(CACHE_KEYS.LOCAL_ETAG,(()=>this._localStorageService.getItem("RoktEtag")))}setEtag(etag){withSetCache(CACHE_KEYS.LOCAL_ETAG,etag,(()=>this._localStorageService.setItem("RoktEtag",etag)))}}const Endpoint_DOMAIN_TRANSFER="/v1/domain/transfer",Endpoint_EVENTS="/v1/events",Endpoint_EXPERIENCES="/v1/experiences",Endpoint_TIMING="/v1/timings",Endpoint_TIMINGS_EVENTS="/v1/timings/events",Endpoint_METRIC_EVENTS="/v1/events/metrics",Endpoint_INFO="/v1/info",Endpoint_RESPONSES="/v1/responses",Endpoint_ERRORS="/v1/errors",Endpoint_LOG="/v1/log";const http_interfaces_Method_GET="GET",http_interfaces_Method_POST="POST",http_interfaces_Method_PUT="PUT";const HeaderKey_ROKT_TAG_HEADER_KEY="rokt-tag-id",HeaderKey_ROKT_SESSION_ID_HEADER_KEY="rokt-session-id",HeaderKey_ROKT_ACCOUNT_ID_HEADER_KEY="rokt-account-id",HeaderKey_ROKT_CANARY_HEADER_KEY="rokt-canary",HeaderKey_ROKT_PAGE_ID_HEADER_KEY="rokt-page-id",HeaderKey_ROKT_PAGE_IDENTIFIER_HEADER_KEY="rokt-page-identifier",HeaderKey_ROKT_PAGE_INSTANCE_GUID="rokt-page-instance-guid",HeaderKey_ROKT_PAGE_URL_HEADER_KEY="rokt-page-url",HeaderKey_ROKT_DO_NOT_TRACK="rokt-do-not-track",HeaderKey_ROKT_ETAG="rokt-etag",HeaderKey_ROKT_ORIGIN="rokt-origin",HeaderKey_ROKT_SESSION_FIRST_PARTY_COOKIE_HEADER_KEY="rokt-first-party-cookie",HeaderKey_ROKT_SESSION_FIRST_PARTY_LOCAL_STORAGE_HEADER_KEY="rokt-first-party-local-storage",HeaderKey_ROKT_SESSION_THIRD_PARTY_COOKIE_HEADER_KEY="rokt-third-party-cookie",HeaderKey_ROKT_SESSION_THIRD_PARTY_LOCAL_STORAGE_HEADER_KEY="rokt-third-party-local-storage",HeaderKey_ROKT_EXISTING_TEST_SESSION="rokt-existing-test-session",HeaderKey_ROKT_LAYOUT_SCHEMA_VERSION="rokt-layout-schema-version",HeaderKey_ROKT_WSDK_VERSION="rokt-wsdk-version",HeaderKey_ROKT_LAUNCHER_INSTANCE_GUID="rokt-launcher-instance-guid",HeaderKey_ROKT_SESSION_TOKEN="rokt-session-token",HeaderKey_ROKT_MPARTICLE_SDK_VERSION="rokt-mparticle-sdk-version",HeaderKey_ROKT_MPARTICLE_KIT_VERSION="rokt-mparticle-kit-version",types_event_type_EventType_SIGNAL_IMPRESSION="SignalImpression",types_event_type_EventType_SIGNAL_INITIALIZE="SignalInitialize",types_event_type_EventType_SIGNAL_LOAD_START="SignalLoadStart",types_event_type_EventType_SIGNAL_LOAD_COMPLETE="SignalLoadComplete",types_event_type_EventType_SIGNAL_GATED_RESPONSE="SignalGatedResponse",types_event_type_EventType_SIGNAL_RESPONSE="SignalResponse",types_event_type_EventType_SIGNAL_CAPTURE_ATTRIBUTES="CaptureAttributes",types_event_type_EventType_SIGNAL_TIME_ON_SITE="SignalTimeOnSite",BasicStages_COMPLETE="__journey_complete__";const IRdnMetricEventType={ROKT_START:"ROKT_START",PAGE_START:"PAGE_START",PLACEMENT_INTERACTIVE:"PLACEMENT_INTERACTIVE"};var SDKVersion;!function(SDKVersion){SDKVersion.JOINT="joint",SDKVersion.V2="v2"}(SDKVersion||(SDKVersion={}));class WebAPIService{constructor({httpClient,sessionService,envConfig,partnerService,contextService,integrationConfigurationService}){this._envConfig=envConfig,this._httpClient=httpClient,this._sessionService=sessionService,this._partnerService=partnerService,this._contextService=contextService,this._integrationConfigurationService=integrationConfigurationService}async get(url,headers={},allowStaleSession){return this._request({method:http_interfaces_Method_GET,url,headers,allowStaleSession})}async post(payload){const{url,body,headers,keepalive,allowStaleSession}=payload;return this._request({method:http_interfaces_Method_POST,url,body,headers,keepalive,allowStaleSession})}async put(payload){const{url,body,headers,keepalive,allowStaleSession}=payload;return this._request({method:http_interfaces_Method_PUT,url,body,headers,keepalive,allowStaleSession})}async _request({method,url,body,headers={},keepalive,allowStaleSession}){const buildUrl=this._buildUrl(url),buildHeaders=this._buildHeaders(headers,!1!==allowStaleSession);if(method===http_interfaces_Method_GET)return this._httpClient.get(buildUrl,buildHeaders);const requestOptions={url:buildUrl,headers:buildHeaders,keepalive};return body&&(requestOptions.body=body),method===http_interfaces_Method_PUT?this._httpClient.put(Object.assign(Object.assign({},requestOptions),{url:buildUrl})):this._httpClient.post(Object.assign(Object.assign({},requestOptions),{url:buildUrl}))}_buildHeaders(headers={},allowStaleSession){var _a,_b;const tagId=this._partnerService.getTagId(),doNotTrack=this._partnerService.getDoNotTrack()?"true":"",integration=null===(_a=this._integrationConfigurationService.getIntegration())||void 0===_a?void 0:_a.toLowerCase(),DEFAULT_HEADERS=[[HeaderKey_ROKT_ACCOUNT_ID_HEADER_KEY,this._partnerService.getAccountId()],[HeaderKey_ROKT_PAGE_IDENTIFIER_HEADER_KEY,this._contextService.getPageIdentifier()],[HeaderKey_ROKT_WSDK_VERSION,integration.includes("mparticle")?SDKVersion.JOINT:SDKVersion.V2],[HeaderKey_ROKT_LAUNCHER_INSTANCE_GUID,this._integrationConfigurationService.getLauncherInstanceGuid()],[HeaderKey_ROKT_TAG_HEADER_KEY,tagId],[HeaderKey_ROKT_DO_NOT_TRACK,doNotTrack]],sessionId=this._sessionService.getSessionId({allowStaleSession}),sessionIdToken=null!==(_b=this._sessionService.getSessionIdToken())&&void 0!==_b?_b:{};if(sessionId){DEFAULT_HEADERS.push([HeaderKey_ROKT_SESSION_ID_HEADER_KEY,sessionId]);const token=sessionIdToken[sessionId];token&&DEFAULT_HEADERS.push([HeaderKey_ROKT_SESSION_TOKEN,token]);this._sessionService.isTestSession()&&DEFAULT_HEADERS.push([HeaderKey_ROKT_EXISTING_TEST_SESSION,"true"])}if(integration&&integration.includes("mparticle")){const versionMap=integration.split("_").reduce(((acc,part,index,arr)=>(("wsdkv"===part||"kitv"===part)&&index+1<arr.length&&(acc[part]=arr[index+1]),acc)),{});versionMap.wsdkv&&versionMap.kitv&&(DEFAULT_HEADERS.push([HeaderKey_ROKT_MPARTICLE_SDK_VERSION,versionMap.wsdkv]),DEFAULT_HEADERS.push([HeaderKey_ROKT_MPARTICLE_KIT_VERSION,versionMap.kitv]))}this._envConfig.isCanary()&&DEFAULT_HEADERS.push([HeaderKey_ROKT_CANARY_HEADER_KEY,"true"]);const defaultHeaders=DEFAULT_HEADERS.reduce(((acc,[key,value])=>(value&&(acc[key]=value),acc)),{});return Object.assign(Object.assign(Object.assign({},defaultHeaders),headers),this._integrationConfigurationService.getCustomHeaders())}_buildUrl(endpoint){return`${this._envConfig.getApiUrl(this._partnerService.isSandbox(),this._partnerService.getProxySubPath())}${endpoint}`}}class PlacementRegister extends Map{constructor(){super(...arguments),this._changes$=new Subject}get changes$(){return this._changes$}set(key,placement){const result=super.set(key,placement);return this._changes$.next({type:"add",placementId:key,placement}),result}delete(key){const placement=this.get(key);if(!placement)return!1;const result=super.delete(key);return result&&this._changes$.next({type:"delete",placementId:key,placement}),result}}const limitErrorCodes={[wsdk_error_WSDKErrorSeverity.ERROR]:error_codes_ErrorCodes.ERROR_LIMIT_EXCEEDED,[wsdk_error_WSDKErrorSeverity.WARNING]:error_codes_ErrorCodes.WARNING_LIMIT_EXCEEDED};class ErrorService{constructor(_webApiService,_environmentConfigService,_integrationConfigurationService,_contextService){this._webApiService=_webApiService,this._environmentConfigService=_environmentConfigService,this._integrationConfigurationService=_integrationConfigurationService,this._contextService=_contextService,this._limits={[wsdk_error_WSDKErrorSeverity.ERROR]:10,[wsdk_error_WSDKErrorSeverity.WARNING]:15},this._counts={[wsdk_error_WSDKErrorSeverity.ERROR]:0,[wsdk_error_WSDKErrorSeverity.WARNING]:0},this._limitSent={[wsdk_error_WSDKErrorSeverity.ERROR]:!1,[wsdk_error_WSDKErrorSeverity.WARNING]:!1}}throw(error,bypassLimit=!1){throw this.report(error,bypassLimit),error}async report(error,bypassLimit=!1){const integration=error.integration||this._integrationConfigurationService.getIntegration();if(error.severity===wsdk_error_WSDKErrorSeverity.INFO&&integration===IntegrationType_Preload)return;if(error.severity=error.severity||wsdk_error_WSDKErrorSeverity.ERROR,!bypassLimit&&this._checkLimit(error.severity))return void await this._reportLimitExceeded(error);const url=this._contextService.getPartnerUrl(),body={additionalInformation:Object.assign(Object.assign({},error.additionalInformation),{message:error.message,version:`${this._integrationConfigurationService.getVersion()}-${this._environmentConfigService.getControllerVersion()}`}),stackTrace:error.stack,severity:error.severity,reporter:error.reporter||"WSDK",integration,deviceInfo:this._environmentConfigService.getUserAgent(),code:error.code||error_codes_ErrorCodes.UNKNOWN_ERROR,url};error.severity!==wsdk_error_WSDKErrorSeverity.INFO?await this._webApiService.post({url:Endpoint_ERRORS,body}):await this._webApiService.post({url:Endpoint_LOG,body})}_checkLimit(level){return this._counts[level]+=1,this._counts[level]>this._limits[level]}async _reportLimitExceeded(err){this._limitSent[err.severity]||(err.code=limitErrorCodes[err.severity],this._limitSent[err.severity]=!0,await this.report(err,!0))}}const MetricOrigin_Plugin=2,MetricTimestampKey_PluginBootstrapEnd="7",MetricTimestampKey_PluginInteractive="8",sleep=(ms=0)=>new Promise((res=>setTimeout(res,ms)));var CoreEntity;!function(CoreEntity){CoreEntity.Controller="Controller",CoreEntity.Extension="Extension",CoreEntity.Launcher="Launcher",CoreEntity.Plugin="Plugin"}(CoreEntity||(CoreEntity={}));const ErrorSeverity_ERROR="ERROR",ErrorSeverity_WARNING="WARNING";class CoreError extends Error{constructor(context){super(context.message||context.code),this.code=context.code,this.sourceType=context.sourceType,this.sourceName=context.sourceName,this.severity=context.severity||ErrorSeverity_ERROR,context.stack&&(this.stack=context.stack)}}const core_controller_error_library_CoreControllerError={LAUNCHER_EXTENSION_UNDEFINED:"LAUNCHER_EXTENSION_UNDEFINED",EXTENSION_INITIALISATION_FAILED:"EXTENSION_INITIALISATION_FAILED",COULD_NOT_FIND_NODE:"COULD_NOT_FIND_NODE",POST_MESSAGE_CONNECTION_ERROR:"POST_MESSAGE_CONNECTION_ERROR"},CorePluginError_PLUGIN_IFRAME_NOT_FOUND="IFRAME_NOT_FOUND",CorePluginError_PLUGIN_PRELOADED_IFRAME_NOT_FOUND="PLUGIN_PRELOADED_IFRAME_NOT_FOUND",CorePluginError_SELECTOR_NOT_FOUND="SELECTOR_NOT_FOUND";const{setFrameworkTiming,setSelectionTiming,setPlacementTiming,sendTimingMetrics,setInteractiveTime,setFrameworkStartAndEndTiming}=new class{constructor(){this._collectedRequestMetrics=new Set,this._frameworkTimings=[],this._selectionTimings=new Map,this._placementTimings=new Map,this.setInteractiveTime=(value,placementId)=>{this.setPlacementTiming({name:TimingMetrics_placementInteractive,value},placementId)},this.setFrameworkTiming=event=>{const existingEventIndex=this._frameworkTimings.findIndex((timingEvent=>timingEvent.name===event.name));-1!==existingEventIndex?this._frameworkTimings[existingEventIndex]=event:this._frameworkTimings.push(event)},this.setFrameworkStartAndEndTiming=(start,end)=>{this.setFrameworkTiming({name:TimingMetrics_frameworkStart,value:start});const frameworkEndEvent={name:TimingMetrics_frameworkEnd,value:end};this.setFrameworkTiming(frameworkEndEvent)},this.setSelectionTiming=(event,selectionId)=>{this._selectionTimings.has(selectionId)||this._selectionTimings.set(selectionId,[]);this._selectionTimings.get(selectionId).push(event)},this.setPlacementTiming=(event,placementId)=>{if(this._placementTimings.has(placementId)){this._placementTimings.get(placementId).push(event)}else this._placementTimings.set(placementId,[event])},this.sendTimingMetrics=async(selectionId,placementId,pluginName,pluginUniqueId)=>{await Promise.race([this._fillTimingMetrics$(pluginUniqueId,placementId),sleep(1e3)]);const combinedTimingEvents=this._combineTimingEvents(selectionId,placementId),uniqueEvents=this._removeDuplicateEvents(combinedTimingEvents);uniqueEvents.length<combinedTimingEvents.length&&reportWSDKError(new ContextualError({code:error_codes_ErrorCodes.DUPLICATE_TIMING_METRICS,severity:ErrorSeverity_WARNING,additionalInformation:{timingEvents:JSON.stringify(combinedTimingEvents)}}));const headers=await this._getHeaders(selectionId),widgetApiService=getWebApiService(),timingMetricsBody={launcherInstanceGuid:getIntegrationConfigurationService().getLauncherInstanceGuid(),eventTime:(new Date).toISOString(),pluginId:placementId,pluginName,timingMetrics:uniqueEvents};try{await widgetApiService.post({url:Endpoint_TIMING,body:timingMetricsBody,headers})}catch(error){this._reportError(error,uniqueEvents,headers)}},this._fillTimingMetrics$=async(pluginId,placementId)=>{const collectedPluginMetrics=new Set;let retryCount=0;for(;this._collectedRequestMetrics.size+collectedPluginMetrics.size<4&&(retryCount++,!(retryCount>20));)first_value_from_firstValueFrom(pipe_pipe(getPerformanceResource$(pluginId))(tap_tap((performanceResources=>{var _a,_b,_c;(null===(_a=performanceResources.result)||void 0===_a?void 0:_a.controller)&&!this._collectedRequestMetrics.has(TimingMetrics_controllerScriptRequestStart)&&(this._collectedRequestMetrics.add(TimingMetrics_controllerScriptRequestStart),this.setFrameworkTiming({name:TimingMetrics_controllerScriptRequestStart,value:performanceResources.result.controller.start}),this.setFrameworkTiming({name:TimingMetrics_controllerScriptRequestEnd,value:performanceResources.result.controller.end})),(null===(_b=performanceResources.result)||void 0===_b?void 0:_b.launcher)&&!this._collectedRequestMetrics.has(TimingMetrics_launcherScriptRequestStart)&&(this._collectedRequestMetrics.add(TimingMetrics_launcherScriptRequestStart),this.setFrameworkTiming({name:TimingMetrics_launcherScriptRequestStart,value:performanceResources.result.launcher.start}),this.setFrameworkTiming({name:TimingMetrics_launcherScriptRequestEnd,value:performanceResources.result.launcher.end})),(null===(_c=performanceResources.result)||void 0===_c?void 0:_c.plugin)&&!collectedPluginMetrics.has(TimingMetrics_pluginScriptRequestStart)&&(collectedPluginMetrics.add(TimingMetrics_pluginScriptRequestStart),this.setPlacementTiming({name:TimingMetrics_pluginScriptRequestStart,value:performanceResources.result.plugin.start},placementId),this.setPlacementTiming({name:TimingMetrics_pluginScriptRequestEnd,value:performanceResources.result.plugin.end},placementId))})))),this._collectedRequestMetrics.has(TimingMetrics_domContentLoadedEventStart)||first_value_from_firstValueFrom(pipe_pipe(getDomContentLoadedEventEnd$())(tap_tap((result=>{result.result&&(this._collectedRequestMetrics.add(TimingMetrics_domContentLoadedEventStart),this.setFrameworkTiming({name:TimingMetrics_domContentLoadedEventStart,value:result.result.domContentLoadedEventEnd}))})))),await sleep(50)},this._getHeaders=async selectionId=>{const contextService=getContextService(),partnerConfigurationService=getPartnerConfigurationService(),integrationConfigurationService=getIntegrationConfigurationService(),partnerId=partnerConfigurationService.getPartnerId(),pageInstanceGuid=await contextService.getPageInstanceGuid(),pageId=await contextService.getPageId();return{[SharedHeaderKey_ROKT_TRACE_ID]:selectionId,[SharedHeaderKey_ROKT_PAGE_INSTANCE_GUID]:pageInstanceGuid,[SharedHeaderKey_ROKT_PAGE_ID_HEADER_KEY]:pageId,[SharedHeaderKey_ROKT_TAG_ID]:partnerId,[SharedHeaderKey_ROKT_SDK_VERSION]:integrationConfigurationService.getVersion(),[SharedHeaderKey_ROKT_SDK_INTEGRATION]:integrationConfigurationService.getIntegration(),[SharedHeaderKey_ROKT_INTEGRATION_TYPE]:"wsdk"}},this._removeDuplicateEvents=timingEvents=>{const nameSet=new Set(timingEvents.map((t=>t.name)));if(nameSet.size==timingEvents.length)return[...timingEvents];const uniqueEvents=new Map;return timingEvents.forEach((timingEvent=>{uniqueEvents.set(timingEvent.name,timingEvent)})),Array.from(uniqueEvents.values())},this._combineTimingEvents=(selectionId,placementId)=>{var _a,_b;const withEventName=name=>timingEvent=>timingEvent.name===name,timeOrigin=this._frameworkTimings.find(withEventName(TimingMetrics_timeOrigin)),domContentLoadedEventStart=this._frameworkTimings.find(withEventName(TimingMetrics_domContentLoadedEventStart));timeOrigin&&domContentLoadedEventStart&&this.setFrameworkTiming({name:TimingMetrics_pageVisible,value:timeOrigin.value+domContentLoadedEventStart.value});const placement=null!==(_a=this._placementTimings.get(placementId))&&void 0!==_a?_a:[],selection=null!==(_b=this._selectionTimings.get(selectionId))&&void 0!==_b?_b:[];return[...this._frameworkTimings,...placement,...selection].filter((timingEvent=>timingEvent.name!==TimingMetrics_domContentLoadedEventStart&&timingEvent.value>0)).map((timingEvent=>({name:timingEvent.name,value:Math.round(timingEvent.value)})))}}_reportError(error,timingMetrics,headers){reportWSDKError(create_contextual_error_createContextualError(error,{code:error_codes_ErrorCodes.TIMINGS_REQUEST_FAILED,severity:ErrorSeverity_WARNING,additionalInformation:{timingMetrics:JSON.stringify(timingMetrics),requestHeaders:JSON.stringify(headers)}}))}};const timingsEventsServiceInstance=new class{constructor(){this._eventsToSend=["frameworkEnd","selectionStart","confirmationPageLoad","localLauncherUsed"],this.sendEvent=async(event,selectionCorrelationId)=>{if(!this._eventsToSend.includes(event.name))return;if(!getEnvironmentConfigurationService().getIsInitLogEnabled())return;const headers=this._getHeaders(selectionCorrelationId),timingMetrics=[event];try{const widgetApiService=getWebApiService(),timingMetricsBody={timingMetrics};await widgetApiService.post({url:Endpoint_TIMINGS_EVENTS,body:timingMetricsBody,headers})}catch(error){this._reportError(error,timingMetrics,headers)}},this._getHeaders=selectionCorrelationId=>{const roktTraceId=guid(),contextService=getContextService(),partnerConfigurationService=getPartnerConfigurationService(),environmentConfigurationService=getEnvironmentConfigurationService(),integrationConfigurationService=getIntegrationConfigurationService(),partnerId=partnerConfigurationService.getPartnerId(),pageInstanceGuid=contextService.getPageInstanceGuidSync(),pageId=contextService.getPageIdSync(),sdkVersion=integrationConfigurationService.getVersion(),integration=integrationConfigurationService.getIntegration(),headers={[SharedHeaderKey_ROKT_TRACE_ID]:roktTraceId,[SharedHeaderKey_ROKT_PAGE_INSTANCE_GUID]:pageInstanceGuid,[SharedHeaderKey_ROKT_PAGE_ID_HEADER_KEY]:pageId,[SharedHeaderKey_ROKT_TAG_ID]:partnerId,[SharedHeaderKey_ROKT_SDK_VERSION]:sdkVersion||`IL-2.${environmentConfigurationService.getControllerVersion()}.0`,[SharedHeaderKey_ROKT_SDK_INTEGRATION]:integration||"integration-launcher",[SharedHeaderKey_ROKT_INTEGRATION_TYPE]:"wsdk",[SharedHeaderKey_ROKT_SELECTION_CORRELATION_ID]:selectionCorrelationId},filteredHeaders=Object.entries(headers).filter((([,value])=>!!value));return Object.fromEntries(filteredHeaders)}}_reportError(error,timingMetrics,headers){reportWSDKError(create_contextual_error_createContextualError(error,{code:error_codes_ErrorCodes.TIMINGS_EVENTS_REQUEST_FAILED,severity:ErrorSeverity_WARNING,additionalInformation:{timingMetrics:JSON.stringify(timingMetrics),requestHeaders:JSON.stringify(headers)}}))}},{sendEvent}=timingsEventsServiceInstance,D_FULLSCREEN="DisplayPreset.FULLSCREEN",D_EMBEDDED="DisplayPreset.EMBEDDED",DisplayPresets={["DisplayPreset.ATTACHED"]:{autoresize:!0,applyHighestZIndex:!0,outerCss:{bottom:"0",left:"50%",maxWidth:"650px",overflow:"hidden",position:"fixed",transform:"translateX(-50%)",width:"100%"},innerCss:{width:"100%"}},[D_FULLSCREEN]:{autoresize:!1,applyHighestZIndex:!0,replaceTargetElement:"body",css:{height:"100%",left:"0",position:"fixed",top:"0",width:"100%"}},[D_EMBEDDED]:{autoresize:!0,css:{minWidth:"100%",overflow:"hidden",width:"1px"}}},DisplayDefaults={border:0,width:"1px",minWidth:"100%",boxSizing:"border-box",display:"block"};class Display{constructor(_corePlugin,_errorService,_controllerCommunication){this._corePlugin=_corePlugin,this._errorService=_errorService,this._controllerCommunication=_controllerCommunication,this.placementDisplay=new Subject,this._displayPreset=new resolvable_promise_ResolvablePromise,this._selectPreset=preset=>Object.assign({},DisplayPresets[preset])}get displayPreset(){return this._displayPreset.promise}async setDisplaySettings(displaySettings){try{let selectedSettings=Object.assign({},displaySettings);selectedSettings.preset&&(selectedSettings=Object.assign(Object.assign({},selectedSettings),this._selectPreset(selectedSettings.preset))),this._displayPreset.resolve(selectedSettings.preset),await this._setSandboxAttributes(selectedSettings.sandbox),await this._putStyles(selectedSettings),await this._setResizeDetection(selectedSettings.autoresize),await this._setTitle(selectedSettings.title),selectedSettings.applyHighestZIndex&&this._corePlugin.display.setHighestZIndex(),selectedSettings.preset===D_FULLSCREEN&&this._corePlugin.display.setFullscreen(),this.placementDisplay.next(selectedSettings),this._controllerCommunication.send(PartnerEvent_DISPLAY_SETTINGS_SET)}catch(e){const contextError=create_contextual_error_createContextualError(e);this._errorService.report(contextError)}}async _appendIframeResizer(windowRef){const resize=this._corePlugin.display.enableResizeDetection.bind(this._corePlugin.display);windowRef.iFrameResizer={resize}}async _setSandboxAttributes(attributes){if(attributes)try{await this._corePlugin.display.setSandboxAttributes(attributes)}catch(e){throw create_contextual_error_createContextualError(e,{code:constants_error_codes_ErrorCodes_SANDBOX_ATTRIBUTES,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{attributes:JSON.stringify(attributes)}})}}async _setTitle(title){if(title)try{await this._corePlugin.display.setTitle(title)}catch(e){throw create_contextual_error_createContextualError(e,{code:constants_error_codes_ErrorCodes_SET_TITLE,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{title}})}}async _setResizeDetection(autoresize=!1){try{const pluginWindowRef=await this._corePlugin.getPluginWindowRef();autoresize&&pluginWindowRef?(this._appendIframeResizer(pluginWindowRef),await this._corePlugin.display.enableResizeDetection()):await this._corePlugin.display.disableResizeDetection()}catch(e){throw create_contextual_error_createContextualError(e,{code:constants_error_codes_ErrorCodes_RESIZE_DETECTION,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{autoresize:JSON.stringify(autoresize)}})}}async _putStyles(displaySettings){const{css,outerCss,innerCss}=displaySettings,cssWithDefaults=Object.assign(Object.assign({},DisplayDefaults),css);try{await this._corePlugin.display.putStyles(this._whitelistStyles(cssWithDefaults)),outerCss&&await this._corePlugin.display.putStyles(this._whitelistStyles(outerCss)),innerCss&&await this._corePlugin.display.putStyles(this._whitelistStyles(innerCss))}catch(e){throw create_contextual_error_createContextualError(e,{code:constants_error_codes_ErrorCodes_PUT_STYLES,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{css:JSON.stringify(cssWithDefaults),outerCss:JSON.stringify(outerCss),innerCss:JSON.stringify(innerCss)}})}}_whitelistStyles(css){const urlOrEncoding=/url|\\|&/i;return Object.entries(css).reduce(((memo,[key,value])=>(urlOrEncoding.test(value)||(memo[key]=value),memo)),{})}}class ParentPluginService{constructor(_corePlugin){this._corePlugin=_corePlugin}async send(eventName,body){this._corePlugin.parent&&await this._corePlugin.parent.send(eventName,body)}onEvent(eventName){return this._corePlugin.parent?this._corePlugin.parent.on(eventName):new Subject}}var _=Object.freeze({__proto__:null,CartEvent:{UPDATE_CART_ITEM_MESSAGE:"UPDATE_CART_ITEM_MESSAGE",UPSERT_ALERT:"UPSERT_ALERT",DELETE_ALERT:"DELETE_ALERT",UPSERT_DELIVERY_DETAILS:"UPSERT_DELIVERY_DETAILS"}}),T=Object.freeze({__proto__:null,PartnerMessage:{UpdateCartItem:"V2_UPDATE_CART_ITEM"},PlacementMessage:{CartItemUpdated:"V2_CART_ITEM_UPDATED"}});Object.freeze({__proto__:null,V1:_,V2:T});const a_OFFER_ENGAGEMENT="OFFER_ENGAGEMENT",a_PLACEMENT_CLOSED="PLACEMENT_CLOSED",a_PLACEMENT_READY="PLACEMENT_READY",a_PLACEMENT_RESIZE="PLACEMENT_RESIZE";Object.freeze({__proto__:null,PlacementMessage:{DELIVERY_DETAILS_SENT:"DELIVERY_DETAILS_SENT"}});var t=Object.freeze({__proto__:null,Extension:{PartnerValidation:"PartnerValidation",ThankYouPageJourney:"ThankYouPageJourney",UserAction:"UserAction"}}),N=(Object.freeze({__proto__:null,PartnerMessage:{CartItemInstantPurchaseResponse:"CART_ITEM_INSTANT_PURCHASE_RESPONSE"},PlacementMessage:{CartItemInstantPurchase:"CART_ITEM_INSTANT_PURCHASE"}}),Object.freeze({__proto__:null,PartnerValidationEvent:{SET_PARTNER_VALIDATION_STATUS:"SET_PARTNER_VALIDATION_STATUS",OPT_IN_TO_PARTNER_VALIDATION:"OPT_IN_TO_PARTNER_VALIDATION",SHOW_PARTNER_VALIDATION_STATUS:"SHOW_PARTNER_VALIDATION_STATUS"}})),S=(Object.freeze({__proto__:null}),Object.freeze({__proto__:null,ThankYouPageStages:{Waiting:"Waiting",ThankYouPage:"ThankYouPage",ConfirmationPage:"ConfirmationPage"}}));Object.freeze({__proto__:null,PartnerMessage:{SEND_UPSELLS:"SEND_UPSELLS"},PlacementMessage:{UPSELL_ENGAGEMENT:"UPSELL_ENGAGEMENT",UPSELLS_SENT:"UPSELLS_SENT",UPSELL_CREATIVE_SENT:"UPSELL_CREATIVE_SENT"}});const L_LINK_NAVIGATION_REQUEST="LINK_NAVIGATION_REQUEST";class Placement{constructor(selectionId,placementId,_corePlugin,_selectionServiceContainer){var _a,_b;this.selectionId=selectionId,this.placementId=placementId,this._corePlugin=_corePlugin,this._selectionServiceContainer=_selectionServiceContainer,this.runtimeInitTime=new Date,this.isInteractiveResolvable=new resolvable_promise_ResolvablePromise,this.alias=this._corePlugin.name,this.id=this._corePlugin.id,this.parentId=null===(_a=this._corePlugin.parent)||void 0===_a?void 0:_a.id,this.cssSelector=this._corePlugin.cssSelector,this.isUsingPreloadIframe=null!==(_b=this._corePlugin.isPluginIframePreloaded)&&void 0!==_b&&_b,this.config=new ReplaySubject(1),this.fonts=new ReplaySubject(1),this.configurables=new ReplaySubject(1),this.selectionContext=this._selectionServiceContainer.selectionContext,this.loggingService=this._selectionServiceContainer.loggingService,this.integrationConfigurationService=this._selectionServiceContainer.integrationConfigurationService,this.partnerConfigService=this._selectionServiceContainer.partnerConfigService,this.errorService=this._selectionServiceContainer.errorService,this.contextService=this._selectionServiceContainer.contextService,this.sessionService=this._selectionServiceContainer.sessionService,this.rdnEventService=this._selectionServiceContainer.rdnEventService,this._placementsRegister=this._selectionServiceContainer.placementsRegister,this._rdnMetricEventService=this._selectionServiceContainer.rdnMetricEventService,this.window=this._selectionServiceContainer.window,this._corePlugin.config$.subscribe(this.config),this.instanceGuid=first_value_from_firstValueFrom(pipe_pipe(this.config)(filter_filter((config=>!!(null==config?void 0:config.instanceGuid))),map_map((config=>{var _a;return null!==(_a=null==config?void 0:config.instanceGuid)&&void 0!==_a?_a:""})))),this.parent=new ParentPluginService(this._corePlugin),this.controllerToPluginCommunication=this._corePlugin.controllerToPluginCommunication,this.pluginToControllerCommunication=this._corePlugin.pluginToControllerCommunication;const pattern=this.partnerConfigService.getDeepLinkingPattern();pattern&&this.controllerToPluginCommunication.on(L_LINK_NAVIGATION_REQUEST).subscribe((event=>{const updatedUrl=pattern.replace("{encoded-advertiser-url}",encodeURIComponent(event.url));this.window.open(updatedUrl,"_blank")})),this.display=new Display(_corePlugin,this._selectionServiceContainer.errorService,this.pluginToControllerCommunication),setPlacementTiming({name:TimingMetrics_pluginBootStrapStart,value:Date.now()},this.id);const placementMonitoringOptions={onDisplayPreset:this.display.displayPreset,pageId:this.selectionContext.getPageId(),placementId:this.placementId};this._selectionServiceContainer.placementMonitoringService.add(this._corePlugin,placementMonitoringOptions)}async pushMetric(event){if(event.name===MetricTimestampKey_PluginInteractive){this._corePlugin.parent||sendTimingMetrics(this.selectionId,this.id,this.alias,this._corePlugin.id);const instanceGuid=await this.instanceGuid;this._rdnMetricEventService.triggerPlacementMetricEvent({parentInstanceGuid:instanceGuid,type:IRdnMetricEventType.PLACEMENT_INTERACTIVE,clientTimestamp:event.recordedTime})}}async close(){await this._corePlugin.close()}async ready(){await this.isInteractiveResolvable.promise}isChildPlugin(){return Promise.resolve(!!this._corePlugin.parent)}onClose(){return this._corePlugin.onClose()}resetPreloadPluginStatus(){this._corePlugin.resetPreloadPluginStatus(),this.isUsingPreloadIframe=!1}createChildPlacement(corePlugin){const childPlacement=new Placement(this.selectionId,this.placementId,corePlugin,this._selectionServiceContainer);return this._placementsRegister.set(childPlacement.id,childPlacement),this._handleSubscriptions(this,childPlacement),childPlacement}async createChildPlugin(name,config,options){return await this._corePlugin.createChild(Object.assign({name,config,e2eId:"rokt-placements-frame-"},options))}logMetric(code,metricName,duration){this.loggingService.log({code,additionalInformation:{metricName,alias:this.alias,placementId:this.placementId,duration:String(duration)}})}_handleSubscriptions(placement,childPlacement){const fontsSubscription=placement.fonts.subscribe(childPlacement.fonts),configurablesSubscription=placement.configurables.subscribe(childPlacement.configurables);childPlacement.onClose().then((()=>{this._placementsRegister.delete(childPlacement.id),fontsSubscription.unsubscribe(),configurablesSubscription.unsubscribe()}))}}class Selection{constructor(selectionId,container,selectionData){this._closed=new resolvable_promise_ResolvablePromise,this._placements=new resolvable_promise_ResolvablePromise,this._pluginInitializationTimeout=8e3,this._eventsPool=[],this._needCacheEvents=!0,this._noticeMoreEventsSubject=new BehaviorSubject(!1),this._noticeCheckEventToReadObservable$=pipe_pipe(this._noticeMoreEventsSubject)(map_map(Boolean)),this.id=selectionId,this._container=container,this.context=container.selectionContext,this._selectionData=selectionData,this._attributesService=container.attributesService,this._errorService=container.errorService}async close(){const placementsPromise=this.getPlacements();this._closed.resolve();const placements=await placementsPromise;await Promise.all(placements.map((placement=>placement.close())))}async getPlacements(){return this._placements.promise.catch((()=>[]))}noticeSubscriberEventAddedToEventPool(){this._noticeMoreEventsSubject.next(!0)}on(eventName){const subject=new Subject;return Promise.resolve().then((()=>this._noticeCheckEventToReadObservable$.subscribe((()=>{if(this._eventsPool.length){const replyEvents=[],leftEvents=[];this._eventsPool.forEach((event=>{event.eventName===eventName||"*"===eventName?replyEvents.push(event):leftEvents.push(event)})),replyEvents.forEach((e=>{subject.next(e)})),this._eventsPool=leftEvents}this._needCacheEvents=!1,this._getPlacementsEventPipe().then((eventPipe=>{pipe_pipe(eventPipe)(filter_filter((event=>event.eventName===eventName||"*"===eventName))).subscribe((e=>{subject.next(e)}))}),(e=>subject.error(e)))})))),subject.asObservable()}async place(){await this._loadSelection(this._selectionData),this._removeUnusedPreloadedIframes()}async ready(){const isInteractivePromises=(await this._placements.promise).map((placement=>placement.isInteractiveResolvable.promise));await Promise.all(isInteractivePromises)}async send(event,data){(await this._placements.promise).forEach((placement=>placement.controllerToPluginCommunication.send(event,data)))}setAttributes(attributes){const eventType=types_event_type_EventType_SIGNAL_CAPTURE_ATTRIBUTES,parentGuid=this._container.sessionService.getSessionId(),pageInstanceGuid=this.context.getPageInstanceGuid(),stringifiedAttributes=this._stringifyAttributes(attributes);this._attributesService.update(parentGuid,attributes),this._container.rdnEventService.triggerEvent({eventType,parentGuid,pageInstanceGuid,attributes:stringifiedAttributes},{},!0).then((()=>this._container.launcherEventsService.emit(event_type_EventType_AttributesCapture))).catch((()=>this._container.launcherEventsService.emit(event_type_EventType_AttributesCaptureFailure)))}_stringifyAttributes(attributes){const stringifiedAttributes=[];for(const[name,attributeValue]of Object.entries(attributes)){const value=this._attributesService.stringify(attributeValue);value&&stringifiedAttributes.push({name,value})}return stringifiedAttributes}async _loadSelection(selectionData){try{const placementsData=await Promise.race([selectionData.then((selectionData=>selectionData.placements)),this._closed.promise.then((()=>[]))]),placements=Promise.all(placementsData.map((placementData=>this._loadPlacement(placementData))));this._cacheMissedEventBeforeSubscribe(),this._placements.resolve(placements)}catch(e){this._placements.reject(e)}}async _loadPlacement(placementData){const{coreController,placementsRegister}=this._container,pluginName=placementData.name.replace("torrent","dcui"),shouldUsePreloadPluginIframe=this._getShouldUsePreloadPluginIframe(pluginName,placementData.targetElementSelector,placementData.targetElementRelation,placementData.targetElementPosition),corePlugin=await coreController.createPlugin({name:pluginName,e2eId:`rokt-placements-frame-${placementData.id}`,shouldUsePreloadPluginIframe}),placement=new Placement(this.id,placementData.id,corePlugin,this._container);this._setPlacementData(placement,placementData);const insertPosition=this._getInsertPosition(null==placementData?void 0:placementData.targetElementRelation,null==placementData?void 0:placementData.targetElementPosition);return this._appendToSelector({corePlugin,placement,placementData,insertPosition,shouldUsePreloadPluginIframe}),placementsRegister.set(placement.id,placement),placement.onClose().then((()=>{placement.pluginToControllerCommunication.send(a_PLACEMENT_CLOSED,{}),placementsRegister.delete(placement.id)})),placement}_setPlacementData(placement,placementData){placement.fonts.next(placementData.fonts),placement.config.next(placementData.config),placement.configurables.next(placementData.configurables)}_getShouldUsePreloadPluginIframe(pluginName,targetElementSelector,targetElementRelation,targetElementPosition){const{coreController}=this._container;return coreController.isPluginIframePreloaded(pluginName)&&(!targetElementSelector||"body"===targetElementSelector)&&(!targetElementRelation||"child"===targetElementRelation)&&(!targetElementPosition||"append"===targetElementPosition)}async _appendToSelector({placement,placementData,corePlugin,insertPosition,shouldUsePreloadPluginIframe}){const targetSelector=placementData.targetElementSelector||"body";try{shouldUsePreloadPluginIframe?await this._tryAppendToPreloadedIframe(corePlugin,targetSelector,insertPosition,placement):await corePlugin.appendTo(targetSelector,insertPosition),this._handlePluginFrameTimeout(placement,shouldUsePreloadPluginIframe)}catch(e){await this._handleAppendError(e,placement)}}async _tryAppendToPreloadedIframe(corePlugin,targetSelector,insertPosition,placement){try{await corePlugin.appendToPreloadedIframe(targetSelector,insertPosition)}catch(_err){placement.resetPreloadPluginStatus(),await corePlugin.appendTo(targetSelector,insertPosition),this._errorService.report(create_contextual_error_createContextualError({code:error_codes_ErrorCodes.PLUGIN_PRELOADED_IFRAME_NOT_FOUND,severity:wsdk_error_WSDKErrorSeverity.INFO}))}}async _handleAppendError(e,placement){const instanceGuid=await placement.instanceGuid,contextualError=create_contextual_error_createContextualError(e,{additionalInformation:{placementId:placement.placementId,placementAlias:placement.alias,placementInstanceGuid:instanceGuid}});contextualError.message===error_codes_ErrorCodes.PLUGIN_ALREADY_APPENDED?this._errorService.report(Object.assign(Object.assign({},contextualError),{code:error_codes_ErrorCodes.PLUGIN_ALREADY_APPENDED})):this._errorService.report(Object.assign(Object.assign({},contextualError),{code:error_codes_ErrorCodes.SELECTOR_ELEMENT_NOT_FOUND,severity:wsdk_error_WSDKErrorSeverity.WARNING}))}async _handlePluginFrameTimeout(placement,shouldUsePreloadPluginIframe){if(!await Promise.race([placement.isInteractiveResolvable.promise.then((()=>!0)),sleep(this._pluginInitializationTimeout).then((()=>!1))])){const pluginFrameError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.PLUGIN_INITIALIZATION_TIMEOUT,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{pluginInitialisationTimeout:this._pluginInitializationTimeout,shouldUsePreloadIframe:shouldUsePreloadPluginIframe}});this._errorService.report(pluginFrameError),placement.isInteractiveResolvable.reject(new Error("Placement failed to load"))}}_getInsertPosition(relation="child",method="append"){switch(`${relation}-${method}`){case"sibling-prepend":return"beforebegin";case"child-prepend":return"afterbegin";case"sibling-append":return"afterend";default:return"beforeend"}}_cacheMissedEventBeforeSubscribe(){if(!this._needCacheEvents)return;this._getPlacementsEventPipe().then((p=>pipe_pipe(p)(filter_filter((_=>this._needCacheEvents))).subscribe((e=>{this._eventsPool.push(e),this.noticeSubscriberEventAddedToEventPool()})))).catch((()=>this._needCacheEvents=!1))}_getPlacementsEventPipe(){return this._placementsEventPipe||(this._placementsEventPipe=this._placements.promise.then((placements=>merge(...placements.map((placement=>pipe_pipe(placement.controllerToPluginCommunication.on("*"))(map_map((event=>Object.assign(Object.assign({},event),{placementId:placement.id})))))))))),this._placementsEventPipe}async _removeUnusedPreloadedIframes(){const placements=await this.getPlacements(),{coreController}=this._container,preloadedIframes=coreController.getPreloadedPluginNames(),removedPluginIframes=new Set;preloadedIframes.forEach((iframeName=>{placements.some((placement=>placement.alias===iframeName&&placement.isUsingPreloadIframe))||removedPluginIframes.has(iframeName)||(coreController.removePreloadedPluginIframe(iframeName),removedPluginIframes.add(iframeName))}))}}class SelectionMiddlewareService{constructor(){this._middlewares=[],this._currentSplittedSelectionDataStream=new Subject,this._completeCurrentSplittedSelectionDataStream=()=>{this._splittedSelectionDataSubscription&&this._splittedSelectionDataSubscription.unsubscribe(),this._currentSplittedSelectionDataStream.complete(),this._currentSplittedSelectionDataStream=new Subject}}registerMiddleware(middlewareObject){this.unregisterMiddleware(middlewareObject),this._middlewares.push(middlewareObject)}unregisterMiddleware(middlewareObject){const index=this._middlewares.indexOf(middlewareObject);index>=0&&this._middlewares.splice(index,1)}updateSelectPlacementOptions(options){return this._middlewares.reduce(((accumOptions,middleware)=>middleware.updateSelectPlacementOptions?middleware.updateSelectPlacementOptions(accumOptions):accumOptions),options)}splitSelectionData(selectionDataPromise){const splitSelectionDataMiddlewares=this._middlewares.filter((middleware=>"splitSelectionData"in middleware&&"updateSelectionData"in middleware));return 0===splitSelectionDataMiddlewares.length?((...args)=>new Observable((observer=>{for(const arg of args)observer.next(arg)})))(selectionDataPromise):(this._completeCurrentSplittedSelectionDataStream(),this._splittedSelectionDataSubscription=merge(...splitSelectionDataMiddlewares.map((middleware=>middleware.splitSelectionData(selectionDataPromise)))).subscribe({next:selectionData=>{this._currentSplittedSelectionDataStream.next(selectionData),splitSelectionDataMiddlewares.forEach((middleware=>middleware.updateSelectionData(selectionData)))},complete:this._completeCurrentSplittedSelectionDataStream}),this._currentSplittedSelectionDataStream.asObservable())}}var __spreadArray=function(to,from,pack){if(pack||2===arguments.length)for(var ar,i=0,l=from.length;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))},BrowserInfo=function(name,version,os){this.name=name,this.version=version,this.os=os,this.type="browser"},NodeInfo=function(version){this.version=version,this.type="node",this.name="node",this.os=process.platform},SearchBotDeviceInfo=function(name,version,os,bot){this.name=name,this.version=version,this.os=os,this.bot=bot,this.type="bot-device"},BotInfo=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},ReactNativeInfo=function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null},SEARCHBOT_OS_REGEX=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,REQUIRED_VERSION_PARTS=3,userAgentRules=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],operatingSystemRules=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function detect(userAgent){return userAgent?parseUserAgent(userAgent):"undefined"==typeof document&&"undefined"!=typeof navigator&&"ReactNative"===navigator.product?new ReactNativeInfo:"undefined"!=typeof navigator?parseUserAgent(navigator.userAgent):"undefined"!=typeof process&&process.version?new NodeInfo(process.version.slice(1)):null}function matchUserAgent(ua){return""!==ua&&userAgentRules.reduce((function(matched,_a){var browser=_a[0],regex=_a[1];if(matched)return matched;var uaMatch=regex.exec(ua);return!!uaMatch&&[browser,uaMatch]}),!1)}function parseUserAgent(ua){var matchedRule=matchUserAgent(ua);if(!matchedRule)return null;var name=matchedRule[0],match=matchedRule[1];if("searchbot"===name)return new BotInfo;var versionParts=match[1]&&match[1].split(".").join("_").split("_").slice(0,3);versionParts?versionParts.length<REQUIRED_VERSION_PARTS&&(versionParts=__spreadArray(__spreadArray([],versionParts,!0),function(count){for(var output=[],ii=0;ii<count;ii++)output.push("0");return output}(REQUIRED_VERSION_PARTS-versionParts.length),!0)):versionParts=[];var version=versionParts.join("."),os=function(ua){for(var ii=0,count=operatingSystemRules.length;ii<count;ii++){var _a=operatingSystemRules[ii],os=_a[0];if(_a[1].exec(ua))return os}return null}(ua),searchBotMatch=SEARCHBOT_OS_REGEX.exec(ua);return searchBotMatch&&searchBotMatch[1]?new SearchBotDeviceInfo(name,version,os,searchBotMatch[1]):new BrowserInfo(name,version,os)}function detect_detect(userAgent){return detect(userAgent)}const ClientType_DesktopWeb="DesktopWeb",ClientType_MobileWeb="MobileWeb";class error_RequestError{constructor(headers,status,statusText,url){this.headers=headers,this.status=status,this.statusText=statusText,this.url=url}}new RegExp("^\\d{4}-\\d{2}-\\d{2}((T\\d{2}:\\d{2}(:\\d{2})?)(\\.\\d{1,6})?(Z|(\\+|-)\\d{2}:\\d{2})?)?$");var task_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};function nTimes(tryFn,attempts=3,delay=100,shouldRetry=(()=>!0)){return task_awaiter(this,void 0,void 0,(function*(){try{return yield tryFn()}catch(error){if(attempts<=1||!shouldRetry(error))throw error}return yield sleep(1*delay),yield nTimes(tryFn,attempts-1,delay)}))}const sleep_sleep=duration=>new Promise((res=>setTimeout(res,duration))),currentActiveExtensionsSubject$=new BehaviorSubject(null),extensionSettingsSubject$=new BehaviorSubject(ExtensionVNextSettings),extensionAttributes$=new BehaviorSubject({}),integrationUrlSubject$=new BehaviorSubject(null),activeAttributesProviderExtensions$=pipe_pipe(combineLatest(currentActiveExtensionsSubject$,extensionSettingsSubject$))(map_map((([activeExtensions,extensionSettings])=>null==activeExtensions?void 0:activeExtensions.filter((e=>{var _a;return null===(_a=extensionSettings[e])||void 0===_a?void 0:_a.selectionAttribute})))),filter_filter(Boolean)),activeExtensionsAttributes$=pipe_pipe(combineLatest(activeAttributesProviderExtensions$,extensionAttributes$))(map_map((([extensions,extensionAttributes])=>{const extensionsWithType=extensions;let result={};for(const extension of extensionsWithType){if(!extensionAttributes[extension])return null;result=Object.assign(Object.assign({},result),extensionAttributes[extension])}return result})),filter_filter(Boolean)),setActiveExtensions$=extensions=>{var _a;const newValue=[...null!==(_a=currentActiveExtensionsSubject$.getValue())&&void 0!==_a?_a:[],...extensions];currentActiveExtensionsSubject$.next(newValue)},controllerExtensions$=pipe_pipe(combineLatest(currentActiveExtensionsSubject$,extensionSettingsSubject$))(map_map((([activeExtensions,extensionSettings])=>null==activeExtensions?void 0:activeExtensions.filter((e=>{var _a;return null===(_a=extensionSettings[e])||void 0===_a?void 0:_a.controllerActivated})))),filter_filter(Boolean)),getExtensionAttributes=async()=>{let timeOutFlag=!1;const extensionAttributes=await Promise.race([first_value_from_firstValueFrom(activeExtensionsAttributes$),sleep_sleep(1e3).then((()=>(timeOutFlag=!0,null)))]);if(timeOutFlag){(await first_value_from_firstValueFrom(getErrorService$())).report(create_contextual_error_createContextualError({code:error_error_codes_ErrorCodes_EXTENSION_VX_ATTRIBUTE_TIMEOUT,severity:wsdk_error_WSDKErrorSeverity.WARNING}))}return extensionAttributes||(()=>{const currentAttributes=extensionAttributes$.getValue();return Object.values(currentAttributes).reduce(((acc,attributes)=>Object.assign(Object.assign({},acc),attributes)),{})})()},currentWidgetDataSubject$=new BehaviorSubject(null),allWidgetDataSubject$=new BehaviorSubject([]),currentWidgetData$=pipe_pipe(currentWidgetDataSubject$)(filter_filter((data=>!!data))),currentWidgetBody$=pipe_pipe(currentWidgetData$)(map_map((data=>data.body))),currentWidgetPageContext$=pipe_pipe(currentWidgetBody$)(map_map((data=>data.pageContext))),currentWidgetPageInstanceGuid$=pipe_pipe(currentWidgetPageContext$)(map_map((data=>data.pageInstanceGuid))),allWidgetData$=pipe_pipe(allWidgetDataSubject$)(map_map((data=>data.filter((item=>null!=item))))),allWidgetBody$=pipe_pipe(allWidgetData$)(map_map((data=>data.map((d=>d.body))))),getEventTokenById$=id=>pipe_pipe(allWidgetBody$)(map_map((data=>data.find((d=>{var _a;return null===(_a=d.eventData)||void 0===_a?void 0:_a[id]})))),filter_filter(Boolean),map_map((d=>d.eventData[id].token))),getEventTokenById=id=>{const data=allWidgetDataSubject$.getValue().filter((d=>null!=d)).map((d=>d.body)).find((d=>{var _a;return null===(_a=d.eventData)||void 0===_a?void 0:_a[id]}));return null==data?void 0:data.eventData[id].token},integration$=new BehaviorSubject(null),setIntegration$=(pipe_pipe(integration$)(filter_filter(Boolean)),integration=>{integration$.next(integration)});class SelectionContext{constructor(_identifier="",_url,_selectionModel,_selectionStartTime){this._identifier=_identifier,this._url=_url,this._selectionModel=_selectionModel,this._selectionStartTime=_selectionStartTime,this._selectionEndTime=Date.now()}getIdentifier(){return this._identifier}getLanguage(){return this._getContextProperty("language")}getPageId(){return this._getContextProperty("pageId")}getPageInstanceGuid(){return this._getContextProperty("pageInstanceGuid")}getPageVariantName(){return this._getContextProperty("pageVariantName")}getSelectionStartTime(){return this._selectionStartTime}getSelectionEndTime(){return this._selectionEndTime}getSessionId(){return this._getContextProperty("sessionId")}getUrl(){return this._url}_getContextProperty(property){return this._selectionModel&&this._selectionModel.context[property]||""}}class SelectionService{constructor({domainTransferService,environmentConfigService,errorService,launcherWindowService,partnerConfigService,recogniserService,globalSessionService,selectionMiddlewareService,selectionContainerFactory,eventDataService,webApiService,performanceService,contextService,attributesService,referralService,launcherEventsService,blockDetectionService,loggingService}){this._selections=new Subject,this._selectionCount=0,this._currentSelectionAttributes=null,this._processOmitUrl=(omitUrl=!1,url)=>omitUrl?{}:{url},this._environmentConfigurationService=environmentConfigService,this._errorService=errorService,this._launcherWindowService=launcherWindowService,this._partnerConfigService=partnerConfigService,this._recogniserService=recogniserService,this._sessionService=globalSessionService,this._selectionMiddlewareService=selectionMiddlewareService,this._selectionContainerFactory=selectionContainerFactory,this._eventDataService=eventDataService,this._webApiService=webApiService,this._performanceService=performanceService,this._contextService=contextService,this._attributesService=attributesService,this._referralService=referralService,this._launcherEventsService=launcherEventsService,this._domainTransferService=domainTransferService,this._blockDetectionService=blockDetectionService,this._loggingService=loggingService}async selectPlacements(options,partnerSelectionTimestamp){const currentSelectionCount=++this._selectionCount,startTime=Date.now();options=this._selectionMiddlewareService.updateSelectPlacementOptions(options);const selectionCorrelationId=guid();if(setSelectionTiming({name:TimingMetrics_partnerSelectPlacements,value:partnerSelectionTimestamp},selectionCorrelationId),setSelectionTiming({name:TimingMetrics_selectionStart,value:startTime},selectionCorrelationId),sendEvent({name:TimingMetrics_selectionStart,value:startTime},selectionCorrelationId),this._contextService.setPageIdentifier(options.identifier||""),!options.url){const locationService=await this._launcherWindowService.getLocationService();options.url=await locationService.getHref()}options.attributes=await this._processAttributes(options.attributes),this._currentSelectionAttributes=options.attributes,this._attributesService.update(selectionCorrelationId,options.attributes);const selectionDataPromise=this._requestPlacements(options).then((response=>{var _a;if(currentSelectionCount!==this._selectionCount)throw create_contextual_error_createContextualError({code:error_error_codes_ErrorCodes_SIMULTANEOUS_SELECTION,severity:wsdk_error_WSDKErrorSeverity.WARNING,additionalInformation:{pageId:options.identifier}});this._verifyResponseBody(response);const finalisedData=this._extractSelectionData(response);return(data=>{currentWidgetDataSubject$.next(data);const allData=allWidgetDataSubject$.getValue();allWidgetDataSubject$.next([...allData,data])})(response),this._eventDataService.setEventData(null===(_a=null==response?void 0:response.body)||void 0===_a?void 0:_a.eventData),this._recordEndSelectionTimestamps(selectionCorrelationId),this._launcherEventsService.emit(event_type_EventType_AttributesCapture),this._launcherEventsService.emit(event_type_EventType_PageIdUpdated,finalisedData.context.pageId),this._launcherEventsService.emit(event_type_EventType_PageInstanceGuidUpdated,finalisedData.context.pageInstanceGuid),this._launcherEventsService.emit(event_type_EventType_PageVariantNameUpdated,finalisedData.context.pageVariantName),this._launcherEventsService.emit(event_type_EventType_SessionIdUpdated,finalisedData.context.sessionId),finalisedData})).catch((err=>{if(this._launcherEventsService.emit(event_type_EventType_AttributesCaptureFailure),err.code===error_error_codes_ErrorCodes_SIMULTANEOUS_SELECTION)this._errorService.throw(err);else{const errorCode=this._blockDetectionService.isRequestBlocked(err)?error_codes_ErrorCodes.V1_EXPERIENCES_REQUEST_FAILED:error_codes_ErrorCodes.EXPERIENCES_CALL_FAILED;this._errorService.throw(create_contextual_error_createContextualError({code:errorCode,severity:wsdk_error_WSDKErrorSeverity.ERROR,message:err.message,additionalInformation:err.additionalInformation}))}}));let selectionData;try{selectionData=await selectionDataPromise}catch(_err){}const selectionContext=new SelectionContext(options.identifier,options.url,selectionData,startTime),selectionContainer=await this._selectionContainerFactory(selectionContext);setSelectContex(selectionCorrelationId,selectionContext),this._domainTransferService.transferDomain(selectionContext);const result=new resolvable_promise_ResolvablePromise;return this._splitSelectionDataSubscription&&this._splitSelectionDataSubscription.unsubscribe(),this._splitSelectionDataSubscription=this._selectionMiddlewareService.splitSelectionData(selectionDataPromise).subscribe((splittedSelectionDataPromise=>{const selection=this._createSelection(selectionCorrelationId,selectionContainer,splittedSelectionDataPromise);result.isPending()&&result.resolve(selection)})),result.promise}onSelection(){return this._selections.asObservable()}getCurrentSelectionAttributes(){return this._currentSelectionAttributes}_createSelection(selectionCorrelationId,selectionContainer,selectionDataPromise){const selection=new Selection(selectionCorrelationId,selectionContainer,selectionDataPromise);return selection.place(),selection.ready().catch((()=>{})),this._selections.next(selection),selection}async _requestPlacements(options){const body=this._buildRequestBody(options),headers=await this._buildRequestHeaders();return nTimes((()=>this._webApiService.post({url:Endpoint_EXPERIENCES,allowStaleSession:!1,body,headers}).then((response=>{var _a,_b;const etag=(null===(_a=null==response?void 0:response.headers)||void 0===_a?void 0:_a.Etag)||(null===(_b=null==response?void 0:response.headers)||void 0===_b?void 0:_b.etag);return etag&&this._recogniserService.setEtag(etag),response}))),3,100,this._shouldRetryRequest)}_buildRealTimeEvents(){const eventData=this._eventDataService.getEventData();if(!eventData)return;const events=Object.entries(eventData).flatMap((([InstanceGuid,eventData])=>Object.entries(eventData.events||{}).filter((([_,eventInfo])=>!0===eventInfo.eventOccurred)).map((([_token,eventInfo])=>({eventType:eventInfo.eventType,eventTime:eventInfo.eventTime,parentGuid:InstanceGuid,payload:eventInfo.payload})))));return{version:"1.0",events:events.length>50?events.slice(-50):events}}_buildRequestBody(options){const privacyControl={noFunctional:this._partnerConfigService.getNoFunctional(),noTargeting:this._partnerConfigService.getNoTargeting(),doNotShareOrSell:this._partnerConfigService.getDoNotShareOrSell(),gpcEnabled:this._environmentConfigurationService.getGlobalPrivacyControl()};if(options.omitUrl&&!options.identifier){const error=new ContextualError({message:"When omitUrl is specified a page identifier must be provided",severity:wsdk_error_WSDKErrorSeverity.ERROR,code:error_codes_ErrorCodes.PAGE_IDENTIFIER_DOES_NOT_EXIST});this._errorService.throw(error)}const realTimeEvents=this._buildRealTimeEvents();return Object.assign({attributes:options.attributes||{},pageIdentifier:options.identifier,privacyControl,realTimeEvents},this._processOmitUrl(options.omitUrl,options.url))}async _processAttributes(originalAttributes){originalAttributes||this._errorService.report(create_contextual_error_createContextualError({code:error_error_codes_ErrorCodes_NO_ATTRIBUTES,severity:wsdk_error_WSDKErrorSeverity.WARNING}));const attributes=Object.assign({},originalAttributes||{});if(attributes[AttributeKeys_UserAgent]||(attributes[AttributeKeys_UserAgent]=this._environmentConfigurationService.getUserAgent()),!attributes[AttributeKeys_ClientType]){const clientType=function(userAgent){const browserInfo=detect_detect(userAgent),osType=browserInfo?browserInfo.os:null;if(null!==osType)switch(osType){case"Amazon OS":case"Android OS":case"BlackBerry OS":case"iOS":case"Windows Mobile":return ClientType_MobileWeb;default:return ClientType_DesktopWeb}}();clientType&&(attributes[AttributeKeys_ClientType]=clientType)}const referralId=this._referralService.getReferralId();referralId&&((referralId=>{const receivedEvent={data:referralId,type:events_EventSlots_onGetReferralId};extensionSubject$.next(receivedEvent)})(referralId),attributes[AttributeKeys_PassbackConversionId]=referralId);const extensionAttributes=await getExtensionAttributes(),combinedAttributes=Object.assign(Object.assign({},attributes),extensionAttributes);return this._attributesService.normalize(combinedAttributes)}async _buildRequestHeaders(){const headers={[HeaderKey_ROKT_LAYOUT_SCHEMA_VERSION]:"*",[HeaderKey_ROKT_ORIGIN]:this._contextService.getSDKOrigin()},[firstPartyRecognisers,thirdPartyRecognisers]=await Promise.all([this._recogniserService.getFirstPartyRecognisers(),this._recogniserService.getThirdPartyRecognisers()]);return firstPartyRecognisers.cookie&&(headers[HeaderKey_ROKT_SESSION_FIRST_PARTY_COOKIE_HEADER_KEY]=firstPartyRecognisers.cookie),firstPartyRecognisers.localStorage&&(headers[HeaderKey_ROKT_SESSION_FIRST_PARTY_LOCAL_STORAGE_HEADER_KEY]=firstPartyRecognisers.localStorage),thirdPartyRecognisers.cookie&&(headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_COOKIE_HEADER_KEY]=thirdPartyRecognisers.cookie),thirdPartyRecognisers.localStorage&&(headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_LOCAL_STORAGE_HEADER_KEY]=thirdPartyRecognisers.localStorage),thirdPartyRecognisers.etag&&(headers[HeaderKey_ROKT_ETAG]=thirdPartyRecognisers.etag),headers}_verifyResponseBody(response){const body=response.body;if(!body.pageContext||!body.plugins&&!body.placements){const error=new ContextualError({message:"Invalid response"});(function(response){var _a;return!!(null===(_a=null==response?void 0:response.description)||void 0===_a?void 0:_a.match(/quota exceeded/i))})(body)&&(error.code="SANDBOX_EXCEEDED"),this._errorService.throw(error)}}_extractSelectionData(selectionResponse){var _a,_b,_c,_d,_e,_f,_g;const{body,headers}=selectionResponse,accountId=null!==(_a=headers[HeaderKey_ROKT_ACCOUNT_ID_HEADER_KEY])&&void 0!==_a?_a:"",sessionId=null!==(_b=headers[HeaderKey_ROKT_SESSION_ID_HEADER_KEY])&&void 0!==_b?_b:"",isTestSession=null!==(_c=headers[HeaderKey_ROKT_EXISTING_TEST_SESSION])&&void 0!==_c?_c:"",sessionToken=null!==(_d=headers[HeaderKey_ROKT_SESSION_TOKEN])&&void 0!==_d?_d:"";this._partnerConfigService.setAccountId(accountId),this._sessionService.updateSession({sessionId,isTestSession:"true"===isTestSession}),this._sessionService.updateSessionIdToken({[sessionId]:sessionToken}),this._contextService.setPageId(body.pageContext.pageId),this._contextService.setLanguage(null!==(_e=body.pageContext.language)&&void 0!==_e?_e:""),this._contextService.setPageInstanceGuid(body.pageContext.pageInstanceGuid),this._contextService.setPageType(null!==(_f=body.pageContext.pageType)&&void 0!==_f?_f:""),this._partnerConfigService.setLimitedUse(!0===(null===(_g=body.privacyControl)||void 0===_g?void 0:_g.limitedUse));const{language,pageId,pageInstanceGuid,pageVariantName="",pageType=""}=body.pageContext;return{context:{language,pageId,pageInstanceGuid,pageVariantName,pageType,sessionId,sessionToken},placements:[...body.placements?body.placements:[],...body.plugins?body.plugins:[]].map((placement=>(this._logOnDCUI(placement),this._mapToPlacementData(placement))))}}_logOnDCUI(placement){"dcui"===placement.plugin.name&&this._loggingService.log({code:error_codes_ErrorCodes.LAYOUT_RECEIVED,integration:"dcui"})}_mapToPlacementData(placement){var _a;const{fonts,plugin}=placement;return{id:plugin.id,config:plugin.config,configurables:null!==(_a=placement.placementConfigurables)&&void 0!==_a?_a:{},fonts:null!=fonts?fonts:[],name:plugin.name,targetElementSelector:plugin.targetElementSelector||"body",targetElementRelation:plugin.targetElementRelation,targetElementPosition:plugin.targetElementPosition,targetSection:plugin.targetSection}}_recordEndSelectionTimestamps(selectionCorrelationId){const experiencesRequestStartTimestamp=this._performanceService.experiencesRequestPerformanceStartTimeStamp(),experiencesRequestEndTimestamp=this._performanceService.experiencesRequestPerformanceEndTimeStamp();setSelectionTiming({name:TimingMetrics_experiencesRequestEnd,value:experiencesRequestEndTimestamp},selectionCorrelationId),setSelectionTiming({name:TimingMetrics_experiencesRequestStart,value:experiencesRequestStartTimestamp},selectionCorrelationId),setSelectionTiming({name:TimingMetrics_selectionEnd,value:Date.now()},selectionCorrelationId)}_shouldRetryRequest(error){return!(error instanceof error_RequestError)||(!error.status||error.status<400||408===error.status)}}const debounce=(fn,delay=0,options={isImmediate:!1,useAnimationFrame:!1})=>{let timerId;const useRaf=!0===options.useAnimationFrame&&"function"==typeof window.requestAnimationFrame;return function(...args){const shouldExec=options.isImmediate&&!timerId;var scheduledFn;scheduledFn=()=>{timerId=void 0,options.isImmediate||fn(...args)},timerId=useRaf?(timerId&&window.cancelAnimationFrame(timerId),window.requestAnimationFrame(scheduledFn)):(timerId&&clearTimeout(timerId),setTimeout(scheduledFn,delay)),shouldExec&&fn(...args)}};class RdnEventService{constructor(_webApiService,_sessionService,_errorService,_contextService,_blockDetectionService,_eventDataService){this._webApiService=_webApiService,this._sessionService=_sessionService,this._errorService=_errorService,this._contextService=_contextService,this._blockDetectionService=_blockDetectionService,this._eventDataService=_eventDataService,this._scheduledEvents=[],this._recordedImpressions={},this._scheduleSendingEvents=((fn,delay=0,options={isImmediate:!1,useAnimationFrame:!1})=>{let pendingPromise=new resolvable_promise_ResolvablePromise;const debounceFn=debounce(((...args)=>{try{null==pendingPromise||pendingPromise.resolve(fn(...args))}catch(e){null==pendingPromise||pendingPromise.reject(e)}pendingPromise=new resolvable_promise_ResolvablePromise}),delay,options);return(...args)=>(debounceFn(...args),pendingPromise.promise)})((()=>{const sessionId=this._sessionService.getSessionId(),events=this._scheduledEvents.map((({eventData,options})=>this._createEventPayload(eventData,options,sessionId)));return this._scheduledEvents=[],this._postToEndpoint(events)}),25)}async triggerEvent(event,optionsRaw={},propagateFailure=!1){try{await this._triggerEventInternal(event,optionsRaw)}catch(error){if(propagateFailure)throw error}}async _triggerEventInternal(event,optionsRaw={}){var _a;const options=Object.assign(Object.assign({},optionsRaw),{clientTimeStamp:null!==(_a=optionsRaw.clientTimeStamp)&&void 0!==_a?_a:new Date});if(this._shouldSkipImpression(event))return;const enrichedEvent=this._enrichEventData(event);event.eventType!==types_event_type_EventType_SIGNAL_RESPONSE&&event.eventType!==types_event_type_EventType_SIGNAL_GATED_RESPONSE&&event.eventType!==types_event_type_EventType_SIGNAL_TIME_ON_SITE?(this._scheduledEvents.push({eventData:enrichedEvent,options}),await this._scheduleSendingEvents()):await this._sendEventImmediately(enrichedEvent,options)}_sendEventImmediately(eventData,options){const sessionId=this._sessionService.getSessionId({allowStaleSession:!0}),event=this._createEventPayload(eventData,options,sessionId);return this._postToEndpointImmediately([event])}async _postToEndpoint(events){const headers=await this._prepareRequestHeaders(),eventsWithToken=await this._prepareEventToken(events);return this._eventDataService.batchUpdateEventOccurred(eventsWithToken),this._webApiService.post({url:Endpoint_EVENTS,body:eventsWithToken,headers,keepalive:!0}).catch((async eventsReason=>{if(this._shouldRetry(eventsReason))try{return await this._webApiService.post({url:Endpoint_INFO,body:eventsWithToken,keepalive:!0})}catch(infoReason){if(this._shouldRetry(infoReason))return this._webApiService.post({url:Endpoint_RESPONSES,body:eventsWithToken,keepalive:!0});throw infoReason}throw eventsReason})).then((()=>{})).catch(this._handleRequestError.bind(this))}async _postToEndpointImmediately(events){const headers=this._prepareRequestHeadersImmediately(),eventsWithToken=this._prepareEventTokenImmediately(events);return this._eventDataService.batchUpdateEventOccurred(eventsWithToken),this._webApiService.post({url:Endpoint_EVENTS,body:eventsWithToken,headers,keepalive:!0}).catch((async eventsReason=>{if(this._shouldRetry(eventsReason))try{return await this._webApiService.post({url:Endpoint_INFO,body:eventsWithToken,keepalive:!0})}catch(infoReason){if(this._shouldRetry(infoReason))return this._webApiService.post({url:Endpoint_RESPONSES,body:eventsWithToken,keepalive:!0});throw infoReason}throw eventsReason})).then((()=>{})).catch(this._handleRequestError.bind(this))}_prepareEventTokenImmediately(events){const results=[];for(let i=0;i<events.length;i++){const event=events[i],eventToken=getEventTokenById(event.parentGuid);this._reportIfEventTokenIsMissing(event,eventToken),results.push(Object.assign(Object.assign({},event),eventToken?{token:eventToken}:{}))}return results}_reportIfEventTokenIsMissing(event,eventToken){eventToken||this._errorService.report(create_contextual_error_createContextualError({code:error_codes_ErrorCodes.TOKEN_NOT_FOUND,severity:wsdk_error_WSDKErrorSeverity.WARNING,additionalInformation:{eventType:event.eventType,instanceGuid:event.parentGuid}})).catch((()=>{}))}async fetchEventTokenWithTimeout(parentGuid){return await Promise.race([sleep(500).then((()=>{})),first_value_from_firstValueFrom(getEventTokenById$(parentGuid))])}async _prepareEventToken(events){const results=[];for(let i=0;i<events.length;i++){const event=events[i],eventToken=await this.fetchEventTokenWithTimeout(event.parentGuid);this._reportIfEventTokenIsMissing(event,eventToken),results.push(Object.assign(Object.assign({},event),eventToken?{token:eventToken}:{}))}return results}async _prepareRequestHeaders(){const pageId=await this._contextService.getPageId();return{[HeaderKey_ROKT_PAGE_ID_HEADER_KEY]:pageId}}_prepareRequestHeadersImmediately(){const pageId=this._contextService.getPageIdSync();return{[HeaderKey_ROKT_PAGE_ID_HEADER_KEY]:pageId}}_shouldSkipImpression(event){return event.eventType===types_event_type_EventType_SIGNAL_IMPRESSION&&(!!this._recordedImpressions[event.parentGuid]||(this._recordedImpressions[event.parentGuid]=!0,!1))}_enrichEventData(event){return Object.assign(Object.assign({},event),{instanceGuid:guid()})}_shouldRetry(error){var _a;return!(null===(_a=null==error?void 0:error.additionalInformation)||void 0===_a?void 0:_a.responseCode)||this._blockDetectionService.isRequestBlocked(error)}_handleRequestError(error){const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.EVENT_RESPONSE,severity:wsdk_error_WSDKErrorSeverity.WARNING,message:null==error?void 0:error.message,additionalInformation:null==error?void 0:error.additionalInformation});return this._blockDetectionService.isRequestBlocked(error)&&(contextError.code=error_codes_ErrorCodes.V1_EVENT_RESPONSE_REQUEST_FAILED),this._errorService.report(contextError).catch((()=>{})),Promise.reject(error)}_createEventPayload(eventData,options,sessionId){const attributes=eventData.attributes||[];return Object.assign(Object.assign({},eventData),{attributes,metadata:this._createMetaData(options,eventData.metadata),sessionId})}_createMetaData(options,extraMetadata=[]){const{clientTimeStamp=new Date,transformedTrafficURL}=options,eventMetaData=[{name:"clientTimeStamp",value:clientTimeStamp.toISOString()},{name:"captureMethod",value:"ClientProvided"}];return transformedTrafficURL&&eventMetaData.push({name:"transformedTrafficURL",value:transformedTrafficURL}),[...eventMetaData,...extraMetadata]}}class RdnMetricEventService{constructor(_webApiService,_sessionService,_contextService,_loggingService,_errorService,_blockDetectionService){this._webApiService=_webApiService,this._sessionService=_sessionService,this._contextService=_contextService,this._loggingService=_loggingService,this._errorService=_errorService,this._blockDetectionService=_blockDetectionService,this._scheduledMetricEvents=[],this._scheduleMetricEvent=debounce((async()=>{var _a;try{const events=this._scheduledMetricEvents;this._scheduledMetricEvents=[];const headers=await this._prepareRequestHeaders();await this._webApiService.post({url:Endpoint_METRIC_EVENTS,headers,body:events})}catch(e){const errorCode=this._blockDetectionService.isRequestBlocked(e)?error_codes_ErrorCodes.V1_METRICS_REQUEST_FAILED:constants_error_codes_ErrorCodes_V1_METRIC_FAILURE;this._loggingService.log({additionalInformation:null!==(_a=e.additionalInformation)&&void 0!==_a?_a:{},code:errorCode})}}),25),this._sentPageMetricEvents=new Set}async triggerPageMetricEvent(event){if(this._sentPageMetricEvents.has(IRdnMetricEventType.ROKT_START)&&this._sentPageMetricEvents.has(IRdnMetricEventType.PAGE_START))return;this._sentPageMetricEvents.add(event.type);const parentInstanceGuid=await this._contextService.getPageInstanceGuid();this._triggerMetricEvent(Object.assign(Object.assign({},event),{parentInstanceGuid}))}async triggerPlacementMetricEvent(event){this._triggerMetricEvent(event)}async fetchEventTokenWithTimeout(parentGuid){return await Promise.race([sleep(500).then((()=>{})),first_value_from_firstValueFrom(getEventTokenById$(parentGuid))])}async _triggerMetricEvent(event){try{const clientTimestamp=new Date(event.clientTimestamp).toISOString(),sessionId=this._sessionService.getSessionId({allowStaleSession:!0}),eventToken=await this.fetchEventTokenWithTimeout(event.parentInstanceGuid);eventToken||this._errorService.report(create_contextual_error_createContextualError({code:error_codes_ErrorCodes.TOKEN_NOT_FOUND,severity:wsdk_error_WSDKErrorSeverity.WARNING,additionalInformation:{eventType:event.type,parentInstanceGuid:event.parentInstanceGuid}}));const instanceGuid=guid();this._scheduledMetricEvents.push({sessionId,parentInstanceGuid:event.parentInstanceGuid,instanceGuid,type:event.type,clientTimestamp,token:null!=eventToken?eventToken:""}),this._scheduleMetricEvent()}catch(e){this._errorService.report(create_contextual_error_createContextualError(e,{code:"TEMP-ISO-DATE-ERROR",additionalInformation:{clientTimestamp:JSON.stringify(event.clientTimestamp),type:event.type}}))}}async _prepareRequestHeaders(){const pageId=await this._contextService.getPageId();return{[HeaderKey_ROKT_PAGE_ID_HEADER_KEY]:pageId}}}class SignalMiddlewareService{constructor(){this._signalQueue=[],this._partnerEventQueue=[],this._signalQueueSubject=new Subject}queueSignal(sendOnEvent,sendSignal,eventType,parentGuid,options){this._signalQueue.push({sendOnEvent,sendSignal,eventType,parentGuid,options}),this._signalQueueSubject.next({sendOnEvent,eventType,parentGuid,options})}capturePartnerEvent(eventKey){const matchingSignals=this._signalQueue.filter((signal=>signal.sendOnEvent===eventKey));matchingSignals.length>0?(matchingSignals.forEach((signal=>{signal.sendSignal(signal.eventType,signal.parentGuid,signal.options)})),this._signalQueue=this._signalQueue.filter((signal=>!matchingSignals.includes(signal)))):this._partnerEventQueue.push(eventKey)}onSignalQueued(sendOnEvent){return sendOnEvent?pipe_pipe(this._signalQueueSubject)(filter_filter((event=>event.sendOnEvent===sendOnEvent))):this._signalQueueSubject.asObservable()}}class GlobalSessionService{constructor(_partnerConfig,_sessionAccessor,_errorService){this._partnerConfig=_partnerConfig,this._sessionAccessor=_sessionAccessor,this._errorService=_errorService,this._sessionId="",this._timestamp=0,this._isTestSession=!1,this._sessionSelectionCount=0}getSessionId({allowStaleSession}={}){return allowStaleSession?this._sessionId:this._sessionSelectionCount&&this._sessionSelectionCount>=50?(this._errorService.then((errorService=>{errorService.report(create_contextual_error_createContextualError({code:error_codes_ErrorCodes.SESSION_LIMIT_EXCEEDED,severity:wsdk_error_WSDKErrorSeverity.WARNING}))})),""):Date.now()-this._timestamp>=18e5?"":this._sessionId}isTestSession(){return this._isTestSession}getSessionIdToken(){const currentSessionId=this.getSessionId();return currentSessionId&&""!==currentSessionId?this._sessionAccessor.getSessionIdToken():{}}initSession(partnerPassedSessionId,firstPartyRoktCookies){const partnerId=this._partnerConfig.getPartnerId(),storedSession=this._sessionAccessor.getSessionInformation(partnerId,firstPartyRoktCookies);if(partnerPassedSessionId){let sessionSelectionCount=0;return storedSession.sessionSelectionCount&&storedSession.sessionId&&partnerPassedSessionId===storedSession.sessionId&&(sessionSelectionCount=storedSession.sessionSelectionCount),this._setSession(partnerId,{sessionId:partnerPassedSessionId,isTestSession:!1,timestamp:Date.now(),sessionSelectionCount})}return this._setSession(partnerId,storedSession)}updateSession(updatedSession){const{sessionId:updatedSessionId,isTestSession:updatedIsTestSession}=updatedSession;if(!updatedSessionId)return;this._timestamp=Date.now(),this._isTestSession=void 0!==updatedIsTestSession?updatedIsTestSession:this._isTestSession,updatedSessionId!==this._sessionId?(this._sessionId=updatedSessionId,this._sessionSelectionCount=1):this._sessionSelectionCount++;const partnerId=this._partnerConfig.getPartnerId();this._syncSessionInformation(partnerId)}updateSessionIdToken(sessionIdToken){this._sessionAccessor.updateSessionIdToken(sessionIdToken)}_setSession(partnerId,session){const{sessionId,isTestSession,timestamp,sessionSelectionCount}=session;sessionId&&(this._sessionId=sessionId),void 0!==isTestSession&&(this._isTestSession=isTestSession),timestamp&&(this._timestamp=timestamp),(sessionSelectionCount||0===sessionSelectionCount)&&(this._sessionSelectionCount=sessionSelectionCount),this._syncSessionInformation(partnerId)}_syncSessionInformation(partnerId){this._sessionId&&this._sessionAccessor.updateSessionInformation(partnerId,{sessionId:this._sessionId,isTestSession:this._isTestSession,timestamp:this._timestamp,sessionSelectionCount:this._sessionSelectionCount})}}class SelectionSessionService{constructor(_sessionId,_sessionIdToken,_isTestSession){this._sessionId=_sessionId,this._sessionIdToken=_sessionIdToken,this._isTestSession=_isTestSession}getSessionId(){return this._sessionId}isTestSession(){return this._isTestSession}getSessionIdToken(){return this._sessionIdToken}}class GlobalSessionAccessor{constructor(_sessionStorageService,_sessionCookieService,_partnerConfigService,_envConfig){this._sessionStorageService=_sessionStorageService,this._sessionCookieService=_sessionCookieService,this._partnerConfigService=_partnerConfigService,this._envConfig=_envConfig,this._sessionKey=partnerId=>`rokt_session_id-${partnerId}`,this._timestampKey=partnerId=>`rokt_session_timestamp-${partnerId}`,this._testSessionKey=sessionId=>`${sessionId}_is_test`,this._selectionCountKey=(sessionId,partnerId)=>`${sessionId}-${partnerId}`,this._partnerBlacklist=this._envConfig.getMultiPageSessionBlacklist().split(",").filter(Boolean)}getSessionInformation(partnerId,firstPartyRoktCookies){if(this._partnerBlacklist.includes(partnerId))return this._emptySession();const thirdPartySession=this._fetchThirdPartySession(partnerId);if(thirdPartySession)return thirdPartySession;const firstPartyCookie=this._unpackFirstPartyCookie(partnerId,firstPartyRoktCookies);return firstPartyCookie||this._emptySession()}updateSessionInformation(partnerId,session){if(this._partnerBlacklist.includes(partnerId))return;const{sessionId,isTestSession,timestamp,sessionSelectionCount}=session,sessionKey=this._sessionKey(partnerId),timestampKey=this._timestampKey(partnerId),testSessionkey=this._testSessionKey(sessionId),selectionCountKey=this._selectionCountKey(sessionId,partnerId);this._sessionStorageService.setItem(sessionKey,sessionId),this._sessionStorageService.setItem(timestampKey,`${timestamp}`),this._sessionStorageService.setItem(selectionCountKey,`${sessionSelectionCount}`),this._sessionStorageService.setItem(testSessionkey,`${isTestSession}`),this._partnerConfigService.getNoFunctional()||this._sessionCookieService.updateSession(partnerId,session)}getSessionIdToken(){try{return JSON.parse(this._sessionStorageService.getItem("RoktSessionIdToken")||"{}")}catch(error){return{}}}updateSessionIdToken(sessionIdToken){let currentSessionIdToken=this.getSessionIdToken();currentSessionIdToken=Object.assign(Object.assign({},currentSessionIdToken),sessionIdToken),this._sessionStorageService.setItem("RoktSessionIdToken",JSON.stringify(currentSessionIdToken))}_fetchThirdPartySession(partnerId){const sessionKey=this._sessionKey(partnerId),sessionId=this._sessionStorageService.getItem(sessionKey);if(!sessionId)return;const timestampKey=this._timestampKey(partnerId),testSessionkey=this._testSessionKey(sessionId),selectionCountKey=this._selectionCountKey(sessionId,partnerId),timestampItem=this._sessionStorageService.getItem(timestampKey)||"",timestamp=parseInt(timestampItem)||Date.now(),isTestSession="true"===this._sessionStorageService.getItem(testSessionkey),sessionSelectionCountItem=this._sessionStorageService.getItem(selectionCountKey);return{sessionId,timestamp,isTestSession,sessionSelectionCount:sessionSelectionCountItem&&parseInt(sessionSelectionCountItem)||0}}_unpackFirstPartyCookie(partnerId,roktCookies){if(this._partnerConfigService.getNoFunctional())return;const sessionInformation=roktCookies[`RoktSessionId-${partnerId}`];if(!sessionInformation)return;const[sessionId,isTestSessionStr,expirationTimestamp]=sessionInformation.split("|");if(!sessionId||!expirationTimestamp)return;const isTestSession="true"===isTestSessionStr,expirationTime=parseInt(expirationTimestamp),timestamp=expirationTime?expirationTime-18e5:Date.now(),sessionSelectionCountItem=roktCookies[`RoktSelectionCount-${sessionId}`];return{sessionId,isTestSession,timestamp,sessionSelectionCount:parseInt(sessionSelectionCountItem)||0}}_emptySession(){return{sessionId:"",isTestSession:!1,timestamp:0,sessionSelectionCount:0}}}class SessionCookieService{constructor(_cookieServicePromise,_launcherEventsService){this._cookieServicePromise=_cookieServicePromise,this._launcherEventsService=_launcherEventsService}updateSession(tagId,session){const{sessionId,isTestSession,timestamp,sessionSelectionCount}=session,expirationTimestamp=timestamp+18e5,sessionInformation=`${sessionId}|${isTestSession}|${expirationTimestamp}`;this._launcherEventsService.emit(event_type_EventType_SessionInformationUpdated,sessionInformation),this._cookieServicePromise.then((cookieService=>{cookieService.set({name:`RoktSessionId-${tagId}`,sameSite:SameSite_Strict,secure:!0,value:sessionInformation,expires:new Date(expirationTimestamp)},!0),cookieService.set({name:`RoktSelectionCount-${sessionId}`,sameSite:SameSite_Strict,secure:!0,value:`${sessionSelectionCount}`,expires:new Date(expirationTimestamp)},!0)}))}}class SelectionServiceContainer{constructor(serviceContainer,coreController,context){this.coreController=coreController,this.selectionContext=context,this.contextService=serviceContainer.contextService;const sessionId=context.getSessionId(),sessionIdToken=serviceContainer.globalSessionService.getSessionIdToken(),isTestSession=serviceContainer.globalSessionService.isTestSession();this.sessionService=new SelectionSessionService(sessionId,sessionIdToken,isTestSession),this.errorService=serviceContainer.errorService,this.placementsRegister=serviceContainer.placementsRegister,this.rdnMetricEventService=serviceContainer.rdnMetricEventService,this.loggingService=serviceContainer.loggingService,this.partnerConfigService=serviceContainer.partnerConfigService,this.eventDataService=serviceContainer.eventDataService,this.attributesService=serviceContainer.attributesService,this.integrationConfigurationService=serviceContainer.integrationConfigurationService,this.launcherEventsService=serviceContainer.launcherEventsService,this.window=serviceContainer.window,this.placementMonitoringService=serviceContainer.placementMonitoringService,this.blockDetectionService=serviceContainer.blockDetectionService,this.webApiService=new WebAPIService({httpClient:serviceContainer.httpClient,sessionService:this.sessionService,envConfig:serviceContainer.environmentConfigService,partnerService:serviceContainer.partnerConfigService,contextService:this.contextService,integrationConfigurationService:this.integrationConfigurationService}),this.rdnEventService=new RdnEventService(this.webApiService,this.sessionService,this.errorService,this.contextService,this.blockDetectionService,this.eventDataService)}}class PerformanceService{constructor(_window){this._window=_window}resourcePerformance(endpoint){const entity=this._resourcePerformanceEntity(endpoint);return null==entity?void 0:entity.duration}experiencesRequestPerformance(){return this.resourcePerformance(Endpoint_EXPERIENCES)}experiencesRequestDomainLookupTime(){const entity=this._resourcePerformanceEntity(Endpoint_EXPERIENCES);return entity?entity.domainLookupEnd-entity.domainLookupStart:void 0}experiencesRequestTLSTime(){const entity=this._resourcePerformanceEntity(Endpoint_EXPERIENCES);return entity?entity.requestStart-entity.secureConnectionStart:void 0}experienceApiFirstByteLatency(){const entity=this._resourcePerformanceEntity(Endpoint_EXPERIENCES);return entity?entity.responseStart-entity.requestStart:void 0}experienceApiLastByteLatency(){const entity=this._resourcePerformanceEntity(Endpoint_EXPERIENCES);return entity?entity.responseEnd-entity.requestStart:void 0}experiencesRequestPerformanceEndTimeStamp(){const entity=this._resourcePerformanceEntity(Endpoint_EXPERIENCES);return entity?entity.duration+entity.startTime+window.performance.timeOrigin:0}experiencesRequestPerformanceStartTimeStamp(){const entity=this._resourcePerformanceEntity(Endpoint_EXPERIENCES);return entity?entity.startTime+window.performance.timeOrigin:0}_resourcePerformanceEntity(endpoint){const resourceEntries=this._window.performance.getEntriesByType("resource").filter((entry=>-1!==entry.name.indexOf(endpoint,entry.name.length-endpoint.length)));if(0===resourceEntries.length)return;return resourceEntries[resourceEntries.length-1]}}class AttributesService{constructor(_errorService){this._errorService=_errorService,this._attributesStreams={}}update(key,attributes){const normalizedAttributes=this.normalize(attributes);this._attributesStreams[key]?this._attributesStreams[key].next(Object.assign(Object.assign({},this._attributesStreams[key].getValue()),normalizedAttributes)):this._createNewStream(key,normalizedAttributes)}onChange(key){return this._attributesStreams[key]||this._createNewStream(key),this._attributesStreams[key].asObservable()}normalize(attributes){const normalizedAttributes={};for(const[name,value]of Object.entries(attributes)){const stringValue=this.stringify(value);stringValue&&(normalizedAttributes[name]=stringValue)}return normalizedAttributes}stringify(value){return Array.isArray(value)?JSON.stringify(value.filter(((item,i)=>value.indexOf(item)===i&&this._isAllowedValue(item)))):this._isAllowedValue(value)?"object"==typeof value&&null!==value?JSON.stringify(value):String(value):""}async hash(attributes){const hashedAttributes={};try{const onReady=Object.entries(attributes).filter((([,value])=>null!=value&&""!==value)).map((async([key,value])=>{const hashedKey=`${key}sha256`,hashedValue=await(async value=>{if("string"!=typeof value)throw new Error("Value to be hashed must be of type string");return getSha256Hex(value.trim().toLocaleLowerCase())})(String(value));hashedAttributes[hashedKey]=hashedValue}));return await Promise.all(onReady),hashedAttributes}catch(error){const contextError=create_contextual_error_createContextualError(error,{code:error_codes_ErrorCodes.HASHING_FAILED,severity:wsdk_error_WSDKErrorSeverity.WARNING});throw this._errorService.report(contextError),contextError}}_createNewStream(key,attributes={}){this._attributesStreams[key]=new BehaviorSubject(attributes)}_isAllowedValue(value){return null!=value&&""!==value}}class LauncherEventsService{constructor(){this._eventsSubject=new Subject}on(eventName){return pipe_pipe(this._eventsSubject)(filter_filter((({event})=>event===eventName||"*"===eventName)))}emit(event,body){this._eventsSubject.next({event,body})}}class PlacementMonitoringService{constructor(...args){this._services=args}add(plugin,options={}){this._services.forEach((service=>service.add(plugin,options)))}}function onResizeComplete(plugin,waitTime=500){const onResizeComplete=new resolvable_promise_ResolvablePromise;let prevTimer;const unsubscriber=plugin.display.onResizeDetection().subscribe((size=>{prevTimer&&clearTimeout(prevTimer),prevTimer=setTimeout((()=>{unsubscriber.unsubscribe(),onResizeComplete.resolve(size)}),waitTime)}));return plugin.onClose().then((()=>{onResizeComplete.resolve(),unsubscriber.unsubscribe(),prevTimer&&clearTimeout(prevTimer)})),onResizeComplete.promise}class PlacementMissizeService{constructor(_coreControllerPromise,_errorService){this._coreControllerPromise=_coreControllerPromise,this._errorService=_errorService}add(plugin,options){this._triggerMissize(plugin,options)}async _triggerMissize(plugin,options={}){const expectedSize=await onResizeComplete(plugin,500);if(!expectedSize)return;const id=plugin.id,controller=await this._coreControllerPromise,actualSize=await controller.getElementBoundingRect(id);if(!actualSize)return;const{height:expectedHeight,width:expectedWidth}=expectedSize,{height:actualHeight,width:actualWidth}=actualSize;let{pageId,placementId}=options;if(pageId=pageId||"",placementId=placementId||"",Math.abs(actualHeight-expectedHeight)>1||actualWidth+1<expectedWidth){const missizedError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.PLUGIN_MISSIZED,severity:wsdk_error_WSDKErrorSeverity.INFO,additionalInformation:{expectedHeight:Math.floor(expectedHeight).toString(),actualHeight:Math.floor(actualHeight).toString(),expectedWidth:Math.floor(expectedWidth).toString(),actualWidth:Math.floor(actualWidth).toString(),pageId,placementId}});this._errorService.report(missizedError)}}}class PlacementCoveredService{constructor(_coreControllerPromise,_errorService){this._coreControllerPromise=_coreControllerPromise,this._errorService=_errorService}add(plugin,options){this._triggerCovered(plugin,options)}async _triggerCovered(plugin,options){const{onDisplayPreset}=options,[confirmedSize,displayPreset]=await Promise.all([onResizeComplete(plugin),onDisplayPreset]);if(!confirmedSize||displayPreset!==D_EMBEDDED)return;const id=plugin.id,coreController=await this._coreControllerPromise,boundingRect=await coreController.getElementBoundingRect(id);if(!boundingRect)return;const{top:topEdge,bottom:bottomEdge,left:leftEdge,right:rightEdge,height,width}=boundingRect,top=Math.ceil(topEdge+1),left=Math.ceil(leftEdge+1),right=Math.floor(rightEdge-1),bottom=Math.floor(bottomEdge-1),middle=Math.floor(topEdge+height/2),quarterAcross=Math.floor(leftEdge+width/4),halfAcross=Math.floor(leftEdge+width/2),points=[{x:left,y:top},{x:halfAcross,y:top},{x:right,y:top},{x:quarterAcross,y:middle},{x:halfAcross,y:middle},{x:Math.floor(rightEdge-width/4),y:middle},{x:left,y:bottom},{x:halfAcross,y:bottom},{x:right,y:bottom}],{points:foundCoveredPoints}=await coreController.getElementCoverage(id,{points});if(!(foundCoveredPoints.length&&Math.random()<.2))return;const coveredPoints=JSON.stringify(foundCoveredPoints);let{pageId,placementId}=options;pageId=pageId||"",placementId=placementId||"";const placementCoveredError=create_contextual_error_createContextualError({code:foundCoveredPoints.length===points.length?error_codes_ErrorCodes.PLUGIN_COVERED_FULL:error_codes_ErrorCodes.PLUGIN_COVERED,severity:wsdk_error_WSDKErrorSeverity.INFO,additionalInformation:{coveredPoints,pageId,placementId}});this._errorService.report(placementCoveredError)}}class PlacementResizeService{add(plugin){const unsubscriber=plugin.display.onResizeDetection().subscribe((body=>plugin.pluginToControllerCommunication.send(a_PLACEMENT_RESIZE,body)));plugin.onClose().then((()=>unsubscriber.unsubscribe()))}}const caches=new Map;var CACHE_KEYS;!function(CACHE_KEYS){CACHE_KEYS[CACHE_KEYS.LOCAL_ETAG=0]="LOCAL_ETAG",CACHE_KEYS[CACHE_KEYS.RECOGNISER=1]="RECOGNISER"}(CACHE_KEYS||(CACHE_KEYS={}));const withSetCache=(key,value,fn)=>{const result=fn();return caches.set(key,value),result},withGetCache=(key,fn)=>{const cachedValue=caches.get(key);return cachedValue||fn()};class ContextService{constructor(_window){this._window=_window,this._pageInstanceGuidPromise=new resolvable_promise_ResolvablePromise,this._pageInstanceGuid="",this._pageIdPromise=new resolvable_promise_ResolvablePromise,this._pageId="",this._language="",this._pageIdentifier="",this._pageType="",this._launcherInstanceId=guid(),this._partnerUrl=""}getLanguage(){return this._language}getLauncherInstanceId(){return this._launcherInstanceId}async getPageInstanceGuid(){return this._pageInstanceGuidPromise.promise}getPageInstanceGuidSync(){return this._pageInstanceGuid}async getPageId(){return this._pageIdPromise.promise}getPageIdSync(){return this._pageId}getPageIdentifier(){return this._pageIdentifier}getPageType(){return this._pageType}getPartnerUrl(){return this._partnerUrl}setLanguage(language){this._language=language}setPageInstanceGuid(pageInstanceGuid){this._pageInstanceGuid=pageInstanceGuid,this._pageInstanceGuidPromise.isFulfilled()&&(this._pageInstanceGuidPromise=new resolvable_promise_ResolvablePromise),this._pageInstanceGuidPromise.resolve(pageInstanceGuid)}setPageId(pageId){this._pageId=pageId,this._pageIdPromise.isFulfilled()&&(this._pageIdPromise=new resolvable_promise_ResolvablePromise),this._pageIdPromise.resolve(pageId)}setPageIdentifier(identifier){this._pageIdentifier=identifier}setPageType(pageType){this._pageType=pageType}setPartnerUrl(partnerUrl){this._partnerUrl=partnerUrl}getSDKOrigin(){return this._window.location.origin}}class LoggingService{constructor(_errorService,_webApiService,_integrationConfigurationService,_environmentConfigService){this._errorService=_errorService,this._webApiService=_webApiService,this._integrationConfigurationService=_integrationConfigurationService,this._environmentConfigService=_environmentConfigService}async log(logEntry){var _a,_b;const integration=null!==(_a=logEntry.integration)&&void 0!==_a?_a:this._integrationConfigurationService.getIntegration();if(integration===IntegrationType_Preload)return;const body=Object.assign(Object.assign({severity:wsdk_error_WSDKErrorSeverity.INFO},logEntry),{additionalInformation:Object.assign(Object.assign({},logEntry.additionalInformation),{version:`${this._integrationConfigurationService.getVersion()}-${this._environmentConfigService.getControllerVersion()}`}),deviceInfo:this._environmentConfigService.getUserAgent(),integration,reporter:null!==(_b=logEntry.reporter)&&void 0!==_b?_b:"WSDK"});try{await this._webApiService.post({url:Endpoint_LOG,body,keepalive:!0})}catch(error){this._errorService.report(create_contextual_error_createContextualError(error,{code:error_codes_ErrorCodes.REQUEST_FAILED,additionalInformation:{endpoint:Endpoint_LOG},severity:wsdk_error_WSDKErrorSeverity.WARNING}))}}}class LocationChangeTrackService{constructor(){this._latestUrl="",this._lastURLChangeTimeStamp=null,this._urlUpdated=!1}getLatestUrl(){return this._latestUrl}setUrl(url,timestamp){this._latestUrl=url,this._isSPA()&&(this._lastURLChangeTimeStamp=timestamp,setFrameworkTiming({name:TimingMetrics_lastLocationChange,value:this._lastURLChangeTimeStamp})),this._urlUpdated=!0}getLocationChangeTimeStamp(){return this._lastURLChangeTimeStamp}_isSPA(){return this._urlUpdated}}const RPCType={HtmlElement:"HtmlElement",Subscriber:"Subscriber",Listener:"Listener",PromiseProperty:"PromiseProperty"};function createHtmlElementMessage(selector){return{$rpc:RPCType.HtmlElement,selector}}const RETAIN_METHOD=Symbol.for("RemoteUi::Retain"),RELEASE_METHOD=Symbol.for("RemoteUi::Release"),RETAINED_BY=Symbol.for("RemoteUi::RetainedBy");class StackFrame{constructor(){this._memoryManaged=new Set}add(memoryManageable){this._memoryManaged.add(memoryManageable),memoryManageable[RETAINED_BY].add(this),memoryManageable[RETAIN_METHOD]()}release(){for(const _memoryManaged of this._memoryManaged)_memoryManaged[RETAINED_BY].delete(this),_memoryManaged[RELEASE_METHOD]();this._memoryManaged.clear()}}function isMemoryManageable(value){return Boolean(value&&value[RETAIN_METHOD]&&value[RELEASE_METHOD])}function retain(value,{deep=!0}={}){return retainInternal(value,deep,new Map)}function retainInternal(value,deep,seen){const seenValue=seen.get(value);if(null!=seenValue)return seenValue;const canRetain=isMemoryManageable(value);if(canRetain&&value[RETAIN_METHOD](),seen.set(value,canRetain),deep){if(Array.isArray(value)){const nestedCanRetain=value.reduce(((canRetain,item)=>retainInternal(item,deep,seen)||canRetain),canRetain);return seen.set(value,nestedCanRetain),nestedCanRetain}if(isBasicObject(value)){const nestedCanRetain=Object.keys(value).reduce(((canRetain,key)=>retainInternal(value[key],deep,seen)||canRetain),canRetain);return seen.set(value,nestedCanRetain),nestedCanRetain}}return seen.set(value,canRetain),canRetain}function release(value,{deep=!0}={}){return releaseInternal(value,deep,new Map)}function releaseInternal(value,deep,seen){const seenValue=seen.get(value);if(null!=seenValue)return seenValue;const canRelease=isMemoryManageable(value);if(canRelease&&value[RELEASE_METHOD](),seen.set(value,canRelease),deep){if(Array.isArray(value)){const nestedCanRelease=value.reduce(((canRelease,item)=>releaseInternal(item,deep,seen)||canRelease),canRelease);return seen.set(value,nestedCanRelease),nestedCanRelease}if(isBasicObject(value)){const nestedCanRelease=Object.keys(value).reduce(((canRelease,key)=>releaseInternal(value[key],deep,seen)||canRelease),canRelease);return seen.set(value,nestedCanRelease),nestedCanRelease}}return canRelease}function isBasicObject(value){if(null==value||"object"!=typeof value)return!1;const prototype=Object.getPrototypeOf(value);return null==prototype||prototype===Object.prototype}function validateAccessor(descriptor,key){const accessor=descriptor[key];if(void 0!==accessor&&"function"!=typeof accessor)throw new TypeError(`${key[0].toUpperCase()+key.slice(1)} must be a function or undefined`)}const FUNCTION="_@f";function createBasicEncoder(api){const functionsToId=new Map,idsToFunction=new Map,idsToProxy=new Map;return{encode:function encode(value,seen=new Map){if(null==value)return[value];const seenValue=seen.get(value);if(seenValue)return seenValue;if("object"==typeof value){if(Array.isArray(value)){seen.set(value,[void 0]);const transferables=[],fullResult=[value.map((item=>{const[result,nestedTransferables=[]]=encode(item,seen);return transferables.push(...nestedTransferables),result})),transferables];return seen.set(value,fullResult),fullResult}if(isBasicObject(value)){seen.set(value,[void 0]);const transferables=[],fullResult=[Object.keys(value).reduce(((object,key)=>{const[result,nestedTransferables=[]]=encode(value[key],seen);return transferables.push(...nestedTransferables),Object.assign(Object.assign({},object),{[key]:result})}),{}),transferables];return seen.set(value,fullResult),fullResult}}if("function"==typeof value){if(functionsToId.has(value)){const id=functionsToId.get(value),result=[{[FUNCTION]:id}];return seen.set(value,result),result}const id=api.uuid();functionsToId.set(value,id),idsToFunction.set(id,value);const result=[{[FUNCTION]:id}];return seen.set(value,result),result}const result=[value];return seen.set(value,result),result},decode,async call(id,args){const stackFrame=new StackFrame,func=idsToFunction.get(id);if(null==func)throw new Error("You attempted to call a function that was already released.");try{const retainedBy=isMemoryManageable(func)?[stackFrame,...func[RETAINED_BY]]:[stackFrame];return await func(...decode(args,retainedBy))}finally{stackFrame.release()}},release(id){const func=idsToFunction.get(id);func&&(idsToFunction.delete(id),functionsToId.delete(func))},terminate(){functionsToId.clear(),idsToFunction.clear(),idsToProxy.clear()}};function decode(value,retainedBy){if("object"==typeof value){if(null==value)return value;if(Array.isArray(value))return value.map((value=>decode(value,retainedBy)));if(FUNCTION in value){const id=value[FUNCTION];if(idsToProxy.has(id))return idsToProxy.get(id);let retainCount=0,released=!1;const release=()=>{retainCount-=1,0===retainCount&&(released=!0,idsToProxy.delete(id),api.release(id))},retain=()=>{retainCount+=1},retainers=new Set(retainedBy),proxy=(...args)=>{if(released)throw new Error("You attempted to call a function that was already released.");if(!idsToProxy.has(id))throw new Error("You attempted to call a function that was already revoked.");return api.call(id,args)};!function(obj,properties){if(!("Zone"in window))return Object.defineProperties(obj,properties);if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)throw new TypeError("Object.defineProperties called on non-object");if(!Object.isExtensible(obj))throw new TypeError("Cannot define properties on a non-extensible object");[...Object.keys(properties),...Object.getOwnPropertySymbols(properties)].forEach((prop=>{const descriptor=properties[prop];if(!descriptor||"object"!=typeof descriptor)throw new TypeError("Property descriptor must be an object: "+descriptor);if(validateAccessor(descriptor,"get"),validateAccessor(descriptor,"set"),("get"in descriptor||"set"in descriptor)&&("value"in descriptor||"writable"in descriptor))throw new TypeError("Invalid property descriptor. Cannot both specify accessors and a value or writable attribute");Object.defineProperty(obj,prop,descriptor)}))}(proxy,{[RELEASE_METHOD]:{value:release,writable:!1},[RETAIN_METHOD]:{value:retain,writable:!1},[RETAINED_BY]:{value:retainers,writable:!1}});for(const retainer of retainers)retainer.add(proxy);return idsToProxy.set(id,proxy),proxy}if(isBasicObject(value))return Object.keys(value).reduce(((object,key)=>Object.assign(Object.assign({},object),{[key]:decode(value[key],retainedBy)})),{})}return value}}const CALL=0,RESULT=1,TERMINATE=2,RELEASE=3,FUNCTION_APPLY=5,FUNCTION_RESULT=6;function createEndpoint(initialMessenger,{uuid=defaultUuid,createEncoder=createBasicEncoder,callable}={}){let terminated=!1,messenger=initialMessenger;const activeApi=new Map,callIdsToResolver=new Map,call=function(handlerForCall,callable){let call;if(null==callable){if("function"!=typeof Proxy)throw new Error("You must pass an array of callable methods in environments without Proxies.");const cache=new Map;call=new Proxy({},{get(_target,property){if(cache.has(property))return cache.get(property);const handler=handlerForCall(property);return cache.set(property,handler),handler}})}else{call={};for(const method of callable)Object.defineProperty(call,method,{value:handlerForCall(method),writable:!1,configurable:!0,enumerable:!0})}return call}(handlerForCall,callable),encoder=createEncoder({uuid,release(id){send(RELEASE,[id])},call(id,args,retainedBy){const callId=uuid(),done=waitForResult(callId,retainedBy),[encoded,transferables]=encoder.encode(args);return send(FUNCTION_APPLY,[callId,id,encoded],transferables),done}});return messenger.addEventListener("message",listener),{call,replace(newMessenger){const oldMessenger=messenger;messenger=newMessenger,oldMessenger.removeEventListener("message",listener),newMessenger.addEventListener("message",listener)},expose(api){for(const key of Object.keys(api)){const value=api[key];"function"==typeof value?activeApi.set(key,value):activeApi.delete(key)}},callable(...newCallable){if(null!=callable)for(const method of newCallable)Object.defineProperty(call,method,{value:handlerForCall(method),writable:!1,configurable:!0,enumerable:!0})},terminate(){send(TERMINATE,void 0),terminate(),messenger.terminate&&messenger.terminate()}};function send(type,args,transferables){terminated||messenger.postMessage(args?[type,args]:[type],transferables)}async function listener(event){const{data}=event;var value;if(value=data,Array.isArray(value)&&"number"==typeof value[0]&&(null==value[1]||Array.isArray(value[1])))switch(data[0]){case TERMINATE:terminate();break;case CALL:{const stackFrame=new StackFrame,[id,property,args]=data[1],func=activeApi.get(property);try{if(null==func)throw new Error(`No '${property}' method is exposed on this endpoint`);const[encoded,transferables]=encoder.encode(await func(...encoder.decode(args,[stackFrame])));send(RESULT,[id,void 0,encoded],transferables)}catch(error){const{name,message,stack}=error;throw send(RESULT,[id,{name,message,stack}]),error}finally{stackFrame.release()}break}case RESULT:{const[callId]=data[1];callIdsToResolver.get(callId)(...data[1]),callIdsToResolver.delete(callId);break}case RELEASE:{const[id]=data[1];encoder.release(id);break}case FUNCTION_RESULT:{const[callId]=data[1];callIdsToResolver.get(callId)(...data[1]),callIdsToResolver.delete(callId);break}case FUNCTION_APPLY:{const[callId,funcId,args]=data[1];try{const result=await encoder.call(funcId,args),[encoded,transferables]=encoder.encode(result);send(FUNCTION_RESULT,[callId,void 0,encoded],transferables)}catch(error){const{name,message,stack}=error;throw send(FUNCTION_RESULT,[callId,{name,message,stack}]),error}break}}}function handlerForCall(property){return(...args)=>{if(terminated)return Promise.reject(new Error("You attempted to call a function on a terminated web worker."));if("string"!=typeof property&&"number"!=typeof property)return Promise.reject(new Error(`Can’t call a symbol method on a remote endpoint: ${property.toString()}`));const id=uuid(),done=waitForResult(id),[encoded,transferables]=encoder.encode(args);return send(CALL,[id,property,encoded],transferables),done}}function waitForResult(id,retainedBy){return new Promise(((resolve,reject)=>{callIdsToResolver.set(id,((_,errorResult,value)=>{if(null==errorResult)resolve(value&&encoder.decode(value,retainedBy));else{const error=new Error;Object.assign(error,errorResult),reject(error)}}))}))}function terminate(){var _a;terminated=!0,activeApi.clear(),callIdsToResolver.clear(),null===(_a=encoder.terminate)||void 0===_a||_a.call(encoder),messenger.removeEventListener("message",listener)}}function defaultUuid(){return`${uuidSegment()}-${uuidSegment()}-${uuidSegment()}-${uuidSegment()}`}function uuidSegment(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)}function createPromisePropertyMessage(promise){return{$rpc:RPCType.PromiseProperty,getValue:()=>promise}}const createSubscriberMethodProxyMessage=subscriberCallback=>({$rpc:"Subscriber",getSubscriber:async(...args)=>({subscribe:(callback,error,complete)=>{const subscriber=subscriberCallback(...args),observer=normaliseToObserver(callback,error,complete);retain(observer);const unsubscriber=subscriber.subscribe(observer);return{unsubscribe:()=>{release(observer),unsubscriber.unsubscribe()}}}})});class PartnerValidationService{constructor(_selectionService){this._selectionService=_selectionService,this._placementsValidationState={}}activatePartnerValidation(){this._selectionService.onSelection().subscribe(this._onSelection.bind(this))}async getValidationStatus(){var _a;const validationStateStream=combineLatest(...Object.values(this._placementsValidationState)),validationStates=await first_value_from_firstValueFrom(validationStateStream,{defaultValue:[]}),validationStatus={isValid:!0,placements:[]};for(const state of validationStates)state.optedIn&&state.placement&&(null===(_a=state.errors)||void 0===_a?void 0:_a.length)&&(validationStatus.isValid=!1,validationStatus.placements.push({element:createHtmlElementMessage(state.placement.cssSelector),errors:state.errors}),state.placement.controllerToPluginCommunication.send(N.PartnerValidationEvent.SHOW_PARTNER_VALIDATION_STATUS));return validationStatus}async _onSelection(selection){(await selection.getPlacements()).forEach((placement=>{const validationStateCache=new ReplaySubject(1),subscription=this._createPlacementValidationStream(placement).subscribe(validationStateCache);this._placementsValidationState[placement.id]=validationStateCache,placement.onClose().then((()=>{delete this._placementsValidationState[placement.id],subscription.unsubscribe()}))}))}_createPlacementValidationStream(placement){return new Observable((subscriber=>{const optInDecision=pipe_pipe(merge(pipe_pipe(placement.controllerToPluginCommunication.on(N.PartnerValidationEvent.OPT_IN_TO_PARTNER_VALIDATION))(map_map((()=>!0))),pipe_pipe(placement.controllerToPluginCommunication.on(PartnerEvent_DISPLAY_SETTINGS_SET))(map_map((()=>!1)))))(first()),notOptedIn=pipe_pipe(optInDecision)(filter_filter((hasOptedIn=>!hasOptedIn)),map_map((()=>({errors:[],placement,optedIn:!1})))),placementErrors=pipe_pipe(placement.controllerToPluginCommunication.on(N.PartnerValidationEvent.SET_PARTNER_VALIDATION_STATUS))(map_map((response=>({errors:response.errors,placement,optedIn:!0})))),subscription=merge(notOptedIn,placementErrors).subscribe(subscriber);return placement.onClose().then((()=>{subscriber.next({placement:null,errors:[],optedIn:!1}),subscriber.complete()})),()=>subscription.unsubscribe()}))}}class ReferralService{setReferralId(roktLocalStorage,roktCookies){const[legacyReferralId,referralId]=[REFERRAL_ID_LEGACY_KEY,REFERRAL_ID_STORAGE_KEY].map((key=>roktLocalStorage[key])),referralIdFromCookie=roktCookies[REFERRAL_ID_STORAGE_KEY];this._referralId=legacyReferralId||referralId||referralIdFromCookie||void 0}getReferralId(){return this._referralId}}class SignalManagementService{constructor(_rdnEventService,_partnerConfigService,_selectionService,_errorService){this._rdnEventService=_rdnEventService,this._partnerConfigService=_partnerConfigService,this._selectionService=_selectionService,this._errorService=_errorService;const selectionObservable=this._selectionService.onSelection();pipe_pipe(selectionObservable)(first()).subscribe((selection=>this._onFirstSelection(selection))),selectionObservable.subscribe((selection=>this._onSelection(selection)))}async _onFirstSelection(selection){const pageInstanceGuid=selection.context.getPageInstanceGuid(),roktFirstTouch=this._partnerConfigService.getRoktFirstTouch();if(!roktFirstTouch)return void this._errorService.report(create_contextual_error_createContextualError({code:error_codes_ErrorCodes.ROKT_FIRST_TOUCH_NOT_SET,severity:wsdk_error_WSDKErrorSeverity.WARNING}));const initTimestamp=new Date(roktFirstTouch);this._triggerEvent(types_event_type_EventType_SIGNAL_INITIALIZE,pageInstanceGuid,initTimestamp)}async _onSelection(selection){if(!(await selection.getPlacements()).length)return;const pageInstanceGuid=selection.context.getPageInstanceGuid();this._triggerEvent(types_event_type_EventType_SIGNAL_LOAD_START,pageInstanceGuid,new Date(selection.context.getSelectionStartTime())),this._triggerEvent(types_event_type_EventType_SIGNAL_LOAD_COMPLETE,pageInstanceGuid,new Date(selection.context.getSelectionEndTime()))}_triggerEvent(eventType,parentGuid,clientTimeStamp){parentGuid&&this._rdnEventService.triggerEvent({eventType,parentGuid},{clientTimeStamp})}}class JourneyManagerService{constructor(){this._currentJourney={_firstStage:void 0,stages:{}},this._currentJourneyComplete=!0,this._currentStage=new BehaviorSubject(void 0)}init(journey){this._currentJourney=journey,this._currentStage.complete(),this._currentJourneyComplete=!1,this._currentStage=new BehaviorSubject(void 0),this._sendNextStage(journey._firstStage)}cancel(){this._currentJourneyComplete||(this._currentJourney={_firstStage:void 0,stages:{}},this._sendNextStage(BasicStages_COMPLETE),this._currentStage=new BehaviorSubject(void 0))}getCurrentStage(){return this._currentStage.getValue()}setNextStage(stage){var _a,_b;const currentStage=this.getCurrentStage();if(!currentStage||this._currentJourneyComplete)throw new ContextualError({code:constants_error_codes_ErrorCodes_JOURNEY_NOT_INITIALISED,severity:wsdk_error_WSDKErrorSeverity.ERROR});const nextStage=void 0!==stage?stage:null===(_a=this._currentJourney.stages[currentStage])||void 0===_a?void 0:_a.at(0);if(!nextStage||!(null===(_b=this._currentJourney.stages[currentStage])||void 0===_b?void 0:_b.includes(nextStage)))throw new ContextualError({message:`Journey can't progress from ${currentStage} to ${nextStage}`,code:constants_error_codes_ErrorCodes_INVALID_NEXT_JOURNEY_STAGE,severity:wsdk_error_WSDKErrorSeverity.ERROR});this._sendNextStage(nextStage)}onChange(){return this._currentStage.asObservable()}_sendNextStage(stage){stage!==BasicStages_COMPLETE?this._currentStage.next(stage):(this._currentJourneyComplete=!0,this._currentStage.complete())}}var SignalTimeOnSiteTrigger;!function(SignalTimeOnSiteTrigger){SignalTimeOnSiteTrigger.timeout="timeout",SignalTimeOnSiteTrigger.advertiserPageClosed="advertiserPageClosed",SignalTimeOnSiteTrigger.partnerPageClosed="partnerPageClosed"}(SignalTimeOnSiteTrigger||(SignalTimeOnSiteTrigger={}));class AdvertiserPageService{constructor(_rdnEventService,_partnerConfigurationService){this._rdnEventService=_rdnEventService,this._partnerConfigurationService=_partnerConfigurationService,this._activePages=new Map,this._trackingIntervalRef=void 0}addActivePage(windowRef,parentGuid){if(!windowRef||this._partnerConfigurationService.getOverrideLinkNavigation())this._raiseTimeOnSiteEvent(parentGuid,void 0,void 0,!1);else{const startTime=Date.now();this._activePages.has(parentGuid)||this._activePages.set(parentGuid,{windowRef,startTime}),this._trackingIntervalRef||this._trackTimeOnSite()}}_removeActivePage(parentGuid){this._activePages.delete(parentGuid),0===this._activePages.size&&(clearInterval(this._trackingIntervalRef),this._trackingIntervalRef=void 0,window.removeEventListener("beforeunload",this._pageCloseHandler.bind(this)))}_raiseTimeOnSiteEvent(parentGuid,trigger,durationMs,isSupported){this._rdnEventService.triggerEvent({eventType:types_event_type_EventType_SIGNAL_TIME_ON_SITE,parentGuid,objectData:{durationMs:void 0===durationMs?"":String(durationMs),trigger:void 0===trigger?"":trigger,isSupported:String(isSupported)}})}_pageCloseHandler(){this._activePages.forEach(((activePage,parentGuid)=>{const durationMs=Math.min(Date.now()-activePage.startTime,24e4);this._raiseTimeOnSiteEvent(parentGuid,SignalTimeOnSiteTrigger.partnerPageClosed,durationMs,!0),this._removeActivePage(parentGuid)}))}_trackTimeOnSite(){window.addEventListener("beforeunload",this._pageCloseHandler.bind(this)),this._trackingIntervalRef=setInterval((()=>{this._activePages.forEach(((activePage,parentGuid)=>{const{windowRef,startTime}=activePage,currentDuration=Date.now()-startTime;if(windowRef.closed){const durationMs=Math.min(currentDuration,24e4);this._raiseTimeOnSiteEvent(parentGuid,SignalTimeOnSiteTrigger.advertiserPageClosed,durationMs,!0),this._removeActivePage(parentGuid)}else currentDuration>24e4&&(this._raiseTimeOnSiteEvent(parentGuid,SignalTimeOnSiteTrigger.timeout,24e4,!0),this._removeActivePage(parentGuid))}))}),100)}}const NetworkBlockedKeywords=["block","failed to fetch","load failed","networkerror when attempting to fetch resource"],BlockedResponseHeaderKeywords=["block","adguard"],BlockedResponseBodyKeywords=["block"];class BlockDetectionService{constructor(_window){this._window=_window}isRequestBlocked(error){var _a,_b,_c;if(error instanceof ContextualError&&"500"===(null===(_a=error.additionalInformation)||void 0===_a?void 0:_a.responseCode)){if(this._includeKeywords(null===(_b=error.additionalInformation)||void 0===_b?void 0:_b.responseHeaders,BlockedResponseHeaderKeywords))return!0;if(this._includeKeywords(null===(_c=error.additionalInformation)||void 0===_c?void 0:_c.responseBody,BlockedResponseBodyKeywords))return!0}return!!this._window.navigator.onLine&&(error instanceof TypeError&&this._includeKeywords(error.message,NetworkBlockedKeywords))}_includeKeywords(input,keywords){const normalizedInput=null==input?void 0:input.toLowerCase();return keywords.some((kw=>null==normalizedInput?void 0:normalizedInput.includes(kw)))}}class PageFireTrackingService{constructor(_environmentConfigService,_errorService){this._environmentConfigService=_environmentConfigService,this._errorService=_errorService;const domainConfirmationPatternMappingStr=this._environmentConfigService.getDomainPagePatternMapping();domainConfirmationPatternMappingStr&&(this._domainConfirmationPatternMapping=JSON.parse(domainConfirmationPatternMappingStr))}async trackConfirmationPage(url,timestamp){const{hostname}=new URL(url);if(this._domainConfirmationPatternMapping)for(const[key,value]of Object.entries(this._domainConfirmationPatternMapping))hostname.includes(key)&&url.includes(value)&&(await isSetControllerConfigurationsSet(),sendEvent({name:TimingMetrics_confirmationPageLoad,value:timestamp}));else{const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.DOMAIN_PATTERN_MAPPING_NOT_FOUND,severity:wsdk_error_WSDKErrorSeverity.INFO,message:"domainConfirmationPatternMapping is not found"});this._errorService.report(contextError)}}}var __rest=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t};class EventDataService{constructor(_localStorageService,_errorService,_sessionService){this._localStorageService=_localStorageService,this._errorService=_errorService,this._sessionService=_sessionService,this._eventData={}}getEventData(){if(this._isDataExpired())return this._clearEventData(),{};try{return JSON.parse(this._localStorageService.getItem("RoktEventData")||"{}")}catch(error){const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.GET_EVENT_DATA_FAILED,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInfo:{error:String(error),eventData:this._eventData}});return this._errorService.report(contextError),{}}}setEventData(eventData){const sanitizedEventData=this._removeTokensFromEventData(eventData);this._eventData=Object.assign(Object.assign({},this._eventData),sanitizedEventData),this._saveEventData()}loadEventData(){if(this._isDataExpired())return this._clearEventData(),void(this._eventData={});const storedData=this._localStorageService.getItem("RoktEventData")||"{}";try{this._eventData=JSON.parse(storedData)}catch(error){const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.LOAD_EVENT_DATA_FAILED,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInfo:{error:String(error),storedData}});return this._errorService.report(contextError),this._clearEventData(),void(this._eventData={})}}batchUpdateEventOccurred(events){var _a,_b;const eventData=this.getEventData();if(!eventData||0===Object.keys(eventData).length)return;let hasUpdates=!1;for(const event of events){const{parentGuid,eventType}=event;if(eventData[parentGuid]){const eventsMap=eventData[parentGuid].events;eventsMap&&eventsMap[eventType]&&(eventsMap[eventType].eventOccurred=!0,eventsMap[eventType].eventTime=(null===(_b=null===(_a=event.metadata)||void 0===_a?void 0:_a.find((meta=>"clientTimeStamp"===meta.name)))||void 0===_b?void 0:_b.value)||"",hasUpdates=!0)}}hasUpdates&&this._updateEventData(eventData)}_updateEventData(enhancedEventData){try{this._eventData=enhancedEventData,this._localStorageService.setItem("RoktEventData",JSON.stringify(enhancedEventData)),this._localStorageService.setItem("RoktEventDataTimestamp",Date.now().toString())}catch(error){const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.UPDATE_EVENT_DATA_FAILED,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInfo:{error:String(error),eventData:this._eventData}});this._errorService.report(contextError)}}_clearEventData(){this._eventData={},this._localStorageService.setItem("RoktEventData",""),this._localStorageService.setItem("RoktEventDataTimestamp","")}_isDataExpired(){const sessionId=this._sessionService.getSessionId();return!sessionId||""===sessionId}_saveEventData(){try{const enhanceEvents=events=>Object.fromEntries(Object.entries(events).map((([signalType,eventInfo])=>{const enhancedEvent=eventInfo;return[signalType,Object.assign(Object.assign({},eventInfo),{eventOccurred:!0===enhancedEvent.eventOccurred})]}))),enhancedEventData=Object.fromEntries(Object.entries(this._eventData).map((([key,eventData])=>[key,Object.assign(Object.assign({},eventData),{events:eventData.events&&Object.keys(eventData.events).length>0?enhanceEvents(eventData.events):eventData.events})])));this._eventData=enhancedEventData,this._localStorageService.setItem("RoktEventData",JSON.stringify(enhancedEventData)),this._localStorageService.setItem("RoktEventDataTimestamp",Date.now().toString())}catch(error){const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.SAVE_EVENT_DATA_FAILED,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInfo:{error:String(error),eventData:this._eventData}});this._errorService.report(contextError)}}_removeTokensFromEventData(eventData){return Object.entries(eventData).filter((([key])=>"token"!==key)).reduce(((result,[key,value])=>(this._isEmptyEventData(value)||(result[key]=this._removeTokenFromNestedObject(value)),result)),{})}_isEmptyEventData(value){if("object"!=typeof value||null===value)return!0;const events=value.events;return!(!events||"object"!=typeof events||0!==Object.keys(events).length)}_removeTokenFromNestedObject(value){if("object"!=typeof value||null===value)return value;if(0===Object.keys(value).length)return value;const _a=value,{token}=_a;return __rest(_a,["token"])}}let services,registered=!1;const servicesSubject$=new BehaviorSubject(null),services$=pipe_pipe(servicesSubject$)(filter_filter(Boolean)),registerServices=sv=>{services=sv,(services=>{const event={data:services,type:events_EventSlots_onServiceContainerReady};extensionSubject$.next(event)})(sv),servicesSubject$.next(sv),registered=!0},checkInitialization=()=>{if(!registered)throw new Error("service have not been initialized yet.")},getContextService=()=>(checkInitialization(),services.contextService),getPartnerConfigurationService=()=>(checkInitialization(),services.partnerConfigService),getEnvironmentConfigurationService=()=>(checkInitialization(),services.environmentConfigService),getWebApiService=()=>(checkInitialization(),services.webApiService),getErrorService$=()=>pipe_pipe(services$)(map_map((svs=>svs.errorService))),getIntegrationConfigurationService=()=>(checkInitialization(),services.integrationConfigurationService),selectContexts=new Map,setSelectContex=(selectionId,context)=>{selectContexts.set(selectionId,context)},setExtensionAttributes=(extensionName,attributes)=>{((extensionName,attributes)=>{const currentAttributes=extensionAttributes$.getValue();extensionAttributes$.next(Object.assign(Object.assign({},currentAttributes),{[extensionName]:attributes}))})(extensionName,attributes)},getControllerExtensions=()=>first_value_from_firstValueFrom(controllerExtensions$),setIntegrationUrl=url=>{(url=>{integrationUrlSubject$.next(url)})(url)},extension_vnext_service_getIntegrationUrl=()=>first_value_from_firstValueFrom(pipe_pipe(integrationUrlSubject$)(filter_filter(Boolean)));function setupPlacementEventListener(placement){var _a;if(!(null===(_a=null==placement?void 0:placement.controllerToPluginCommunication)||void 0===_a?void 0:_a.on))return;const subscription=placement.controllerToPluginCommunication.on("*").subscribe((event=>{passPluginEvent$(event)}));placement.onClose().then((()=>{subscription.unsubscribe()}))}async function initializePluginEventListening(){try{pipe_pipe(services$)(map_map((svs=>svs.placementsRegister))).subscribe({next:placementsRegister=>{if(!placementsRegister)return;Array.from(placementsRegister.values()).forEach(setupPlacementEventListener),placementsRegister.changes$.subscribe((event=>{const registerEvent=event;"add"===registerEvent.type&&setupPlacementEventListener(registerEvent.placement)}))},error:error=>{reportWSDKError({name:error_codes_ExtensionErrorCodes_EXTENSION_PLUGIN_EVENT_SETUP_ERROR,message:`Error setting up plugin event listening: ${error instanceof Error?error.message:String(error)}`,stack:error instanceof Error?error.stack:void 0})}})}catch(error){reportWSDKError({name:error_codes_ExtensionErrorCodes_EXTENSION_PLUGIN_EVENT_SETUP_ERROR,message:`Error setting up plugin event listening: ${error instanceof Error?error.message:String(error)}`,stack:error instanceof Error?error.stack:void 0})}}const reportWSDKError=async e=>{const errorService=await first_value_from_firstValueFrom(getErrorService$());await errorService.report(e)};let port1,port2;if(window.MessageChannel){const mc=new window.MessageChannel;port1=mc.port1,port2=mc.port2}const getControllerPort=()=>port1,sendMessageToLauncher=message=>{port1.postMessage(message)},syncUrl=async(url,timestamp)=>{first_value_from_firstValueFrom(pipe_pipe(services$)(map_map((svs=>svs.locationChangeTrackService)))).then((locationService=>{locationService.setUrl(url,timestamp)})),first_value_from_firstValueFrom(pipe_pipe(services$)(map_map((svs=>svs.pageFireTrackingService)))).then((pageFireTrackingService=>{pageFireTrackingService.trackConfirmationPage(url,timestamp)}))},configurationSetupDone$=new BehaviorSubject(!1),isSetControllerConfigurationsSet=()=>first_value_from_firstValueFrom(pipe_pipe(configurationSetupDone$)(filter_filter(Boolean))),sendLog=async log=>{const loggingService=await first_value_from_firstValueFrom(pipe_pipe(services$)(map_map((svs=>svs.loggingService))));await loggingService.log(log)};let eventCounter=0;const controllerResultPipe=id=>pipe_pipe(((id,port)=>pipe_pipe(from_event_fromEvent(port,"message"))(filter_filter((e=>e.data.id===id)),map_map((event=>event.data))))(id,getControllerPort()))(tap_tap((r=>{if(eventCounter++,eventCounter>500){const error=create_contextual_error_createContextualError({message:constants_error_codes_ErrorCodes_ONS_EVENTS_WARNING_THRESHOLD_EXCEEDED,code:constants_error_codes_ErrorCodes_ONS_EVENTS_WARNING_THRESHOLD_EXCEEDED});reportWSDKError(error),eventCounter=0}if(r.error){const error=create_contextual_error_createContextualError(r.error);reportWSDKError(error)}}))),getDomContentLoadedEventEnd$=()=>{const event=createRoktQueryEvent(event_types_event_type_EventType.Launcher,event_type_TopicType.Launcher_DataQuery,{target:["performance","getEntriesByType"],arguments:["navigation"],index:0,children:["domContentLoadedEventEnd"]});return sendMessageToLauncher(event),controllerResultPipe(event.id)},getPerformanceResource$=pluginId=>{const event=createRoktQueryEvent(event_types_event_type_EventType.Launcher,event_type_TopicType.Launcher_DataQuery,{functionName:"getPerformanceResources",arguments:[pluginId]});return sendMessageToLauncher(event),controllerResultPipe(event.id)},getLauncherInitData$=()=>{const event=createRoktQueryEvent(event_types_event_type_EventType.Launcher,event_type_TopicType.Launcher_DataQuery,{functionName:"getLauncherInitData"});return sendMessageToLauncher(event),controllerResultPipe(event.id)},RemoteHandlers={setFrameworkTiming:(event,value)=>{setFrameworkTiming(value?{name:event,value}:event)},syncLocation:(url,timestamp)=>{syncUrl(url,timestamp)},setConfigurations:configurations=>{(configurations=>{const integrationConfigurationService=getIntegrationConfigurationService();integrationConfigurationService.setIntegration(configurations.integration),integrationConfigurationService.setVersion(configurations.sdkVersion),integrationConfigurationService.setLauncherInstanceGuid(configurations.launcherInstanceGuid),configurationSetupDone$.next(!0)})(configurations)},sendEvent:eventName=>{(async name=>{const[rdnEventService,pageInstanceGuid]=await Promise.all([first_value_from_firstValueFrom(pipe_pipe(services$)(map_map((svs=>svs.rdnEventService)))),first_value_from_firstValueFrom(currentWidgetPageInstanceGuid$)]);await rdnEventService.triggerEvent({eventType:name,parentGuid:pageInstanceGuid})})(eventName)},sendLoadStatus:status=>sendLog({additionalInformation:{status:String(status)},code:"LOAD_STATUS"}),setExtensionAttributes(extensionName,attributes){setExtensionAttributes(extensionName,attributes)},setActiveExtensions(extensionName){setActiveExtensions$(extensionName)},setExtensionVNextConfig:configs=>{setExtensionVNextData(configs,"controller")},setFrameworkStartAndEndTiming:(start,end)=>{setFrameworkStartAndEndTiming(start,end)},sendTimingEvent:event=>{sendEvent(event)}},preloadTimingMetrics=()=>{(()=>{const event=createRoktQueryEvent(event_types_event_type_EventType.Launcher,event_type_TopicType.Launcher_DataQuery,{target:["performance","timeOrigin"],arguments:[]});return sendMessageToLauncher(event),controllerResultPipe(event.id)})().subscribe((result=>{result.result&&setFrameworkTiming({name:TimingMetrics_timeOrigin,value:result.result})}))},isResultComplex=result=>{if(Array.isArray(result))return result.some((r=>isResultComplex(r)));if(function(result){return Object(result)!==result}(result))return!1;if(Object.entries(result).some((([_,p])=>isFunction(p))))return!0;if(Object.getPrototypeOf(result)===Object.prototype)return!1;const classInstanceMethod=(obj=result,Object.getOwnPropertyNames(Object.getPrototypeOf(obj)).filter((name=>"function"==typeof obj[name])));var obj;return!!classInstanceMethod.includes("constructor")&&classInstanceMethod.length>1},createResult=(result,id,resultKey,isComplexArray)=>Object.assign({result,handler:event_types_event_type_EventType.Result,id,identifier:"Rokt-Events",topic:event_type_TopicType.EventResult,complexObjectId:resultKey},isComplexArray?{isComplexArray:!0}:{}),complexResultMap=new Map,reportError=(error,eventData)=>{reportWSDKError({name:constants_error_codes_ErrorCodes_INVALID_CONTROLLER_REMOTE_CALL,message:null==error?void 0:error.message,stack:null==error?void 0:error.stack,additionalInformation:eventData})},createResultMessage=(r,resultId)=>{let resultMessage;if(isResultComplex(r)){const isComplexArray=Array.isArray(r),resultKey=getUniqueId();complexResultMap.set(resultKey,r),resultMessage=createResult((complexObject=r,JSON.parse(JSON.stringify(complexObject))),resultId,resultKey,isComplexArray)}else resultMessage=createResult(r,resultId);var complexObject;return resultMessage},controllerEventDispatcherPipe=pipe_pipe(from_event_fromEvent(getControllerPort(),"message"))(filter_filter((e=>{const messageEvent=e;return"Rokt-Events"===messageEvent.data.identifier&&messageEvent.data.handler===event_types_event_type_EventType.Controller})),tap_tap((e=>{const messageEvent=e;try{let result;if(messageEvent.data.complexObjectId){const complexResult=complexResultMap.get(messageEvent.data.complexObjectId),complexIndex=messageEvent.data.complexObjectIndex,complexObject=void 0!==complexIndex?complexResult.at(complexIndex):complexResult,remoteCall=messageEvent.data.body;complexObject[remoteCall.function]&&isFunction(complexObject[remoteCall.function])&&(result=complexObject[remoteCall.function](...remoteCall.args))}else result=(event=>{if(event.topic===event_type_TopicType.Launcher_To_Controller_RemoteCall){const remoteCall=event.body,func=RemoteHandlers[remoteCall.function];if(func)return func(...remoteCall.args)}})(messageEvent.data);(null==(r=result)?void 0:r.subscribe)?result.subscribe((res=>{const resultMessage=createResultMessage(res,messageEvent.data.id);sendMessageToLauncher(resultMessage)})):Promise.resolve(result).then((res=>{const resultMessage=createResultMessage(res,messageEvent.data.id);sendMessageToLauncher(resultMessage)})).catch((error=>{reportError(error,e.data)}))}catch(error){reportError(error,e.data)}var r}))),dynamicImport=url=>import(url),randomString=()=>{let result="";for(let i=0;i<10;i++)result+="abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(26*Math.random()));return result};var CoreNodeType,InternalNodeEventType;!function(CoreNodeType){CoreNodeType[CoreNodeType.Host=0]="Host",CoreNodeType[CoreNodeType.Plugin=1]="Plugin",CoreNodeType[CoreNodeType.Extension=2]="Extension"}(CoreNodeType||(CoreNodeType={})),function(InternalNodeEventType){InternalNodeEventType.AddChild="internal:add-child",InternalNodeEventType.RemoveChild="internal:remove-child"}(InternalNodeEventType||(InternalNodeEventType={}));class CoreNode{constructor(id,name,type,element=null,windowRef=null){this.id=id,this.name=name,this.type=type,this.element=element,this.windowRef=windowRef,this.children=[],this.events$=new Subject,this.parent=null,this.unsubscribers=[]}appendChild(node){node.parent=this,this.children.push(node),this.events$.next({source:node,type:InternalNodeEventType.AddChild,data:void 0})}removeChild(node){const index=this.children.indexOf(node);-1!==index&&(this.children.splice(index,1),node.parent=null)}}class NodeCommunication{constructor(_originNode,_targetNode){this._originNode=_originNode,this._targetNode=_targetNode,this._events$=pipe_pipe(this._originNode.events$)(filter_filter((event=>event.source===_targetNode)),map_map((event=>({eventName:event.type,data:event.data}))))}send(eventName,data){this._targetNode.events$.next({source:this._originNode,type:eventName,data})}on(eventName){return"*"===eventName?this._events$:pipe_pipe(this._events$)(filter_filter((event=>event.eventName===eventName)),map_map((event=>event.data)))}}const createPluginNode=(id,name,window=null,element=null)=>new CoreNode(id,name,CoreNodeType.Plugin,element,window),PutConfigEvent="internal:put-config",ClosePluginEvent="internal:close",AppendedEvent="internal:appended";var InternalPluginEventType;function createPluginRPC(pluginEvents,hostNode){return{close:async()=>{pluginEvents.next({source:hostNode,type:ClosePluginEvent,data:void 0})},onAppended:async()=>{pluginEvents.next({source:hostNode,type:AppendedEvent,data:void 0})},putConfig:async config=>{pluginEvents.next({source:hostNode,type:PutConfigEvent,data:config})},sendMessage:async(eventName,data)=>{pluginEvents.next({source:hostNode,type:eventName,data})}}}!function(InternalPluginEventType){InternalPluginEventType.PutConfigEvent="internal:put-config",InternalPluginEventType.ClosePluginEvent="internal:close",InternalPluginEventType.MethodEvent="internal:method",InternalPluginEventType.Initiate="internal:appended"}(InternalPluginEventType||(InternalPluginEventType={}));var internal_events_InternalPluginEventType,LifecycleState;!function(InternalPluginEventType){InternalPluginEventType.LifeCycle="internal:lifecycle",InternalPluginEventType.Close="internal:close"}(internal_events_InternalPluginEventType||(internal_events_InternalPluginEventType={})),function(LifecycleState){LifecycleState.BeforeInit="internal:before-init",LifecycleState.AfterInit="internal:after-init",LifecycleState.Closed="internal:closed"}(LifecycleState||(LifecycleState={}));var _CoreReporter_errorStream,_CoreReporter_sourceType,_CoreReporter_sourceName,__classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},__classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};class CoreReporter{constructor(sourceType,sourceName){_CoreReporter_errorStream.set(this,new Subject),_CoreReporter_sourceType.set(this,void 0),_CoreReporter_sourceName.set(this,void 0),__classPrivateFieldSet(this,_CoreReporter_sourceType,sourceType,"f"),__classPrivateFieldSet(this,_CoreReporter_sourceName,sourceName,"f")}throw(code,message="",stack){throw new CoreError({code,stack,message,sourceType:__classPrivateFieldGet(this,_CoreReporter_sourceType,"f"),sourceName:__classPrivateFieldGet(this,_CoreReporter_sourceName,"f")})}onError(){return __classPrivateFieldGet(this,_CoreReporter_errorStream,"f").asObservable()}reportError(error){const errorObject=Object.assign({message:error.message,stack:error.stack},error);__classPrivateFieldGet(this,_CoreReporter_errorStream,"f").next(errorObject)}createCoreError(code,message="",stack,severity){return new CoreError({code,stack,message:message||code,severity,sourceType:__classPrivateFieldGet(this,_CoreReporter_sourceType,"f"),sourceName:__classPrivateFieldGet(this,_CoreReporter_sourceName,"f")})}}_CoreReporter_errorStream=new WeakMap,_CoreReporter_sourceType=new WeakMap,_CoreReporter_sourceName=new WeakMap;const registeredEvent=name=>`core:extension-registered-${name}`;var PluginStageType,InternalExtensionEvent;!function(PluginStageType){PluginStageType[PluginStageType.BeforeInit=0]="BeforeInit",PluginStageType[PluginStageType.AfterInit=1]="AfterInit",PluginStageType[PluginStageType.Closed=2]="Closed"}(PluginStageType||(PluginStageType={}));class Lifecycle{constructor(pluginNode,lifecycleStage){this.pluginNode=pluginNode,this.lifecycleStage=lifecycleStage;const close$=new Subject,afterInit$=new Subject;this.close$=close$.asObservable(),this.afterInit$=afterInit$.asObservable(),lifecycleStage===LifecycleState.AfterInit?this._lifecycleStage=PluginStageType.AfterInit:this._lifecycleStage=PluginStageType.BeforeInit;const sub=pluginNode.events$.subscribe((event=>{event.source===pluginNode&&(event.type===internal_events_InternalPluginEventType.LifeCycle&&event.data===LifecycleState.AfterInit&&(this._lifecycleStage=PluginStageType.AfterInit,afterInit$.next(),afterInit$.complete()),event.type===internal_events_InternalPluginEventType.Close&&(sub.unsubscribe(),this._lifecycleStage=PluginStageType.Closed,close$.next(),close$.complete()))}))}async getCurrentStage(){return this._lifecycleStage}}!function(InternalExtensionEvent){InternalExtensionEvent.Use="internal:use",InternalExtensionEvent.Method="internal:method"}(InternalExtensionEvent||(InternalExtensionEvent={}));class ExtensionPluginRegister{constructor(_extensionNode,_pluginNode){this._extensionNode=_extensionNode,this._pluginNode=_pluginNode}method(name,implementation){pipe_pipe(this._extensionNode.events$)(filter_filter((event=>event.source===this._pluginNode)),filter_filter((event=>event.type===InternalExtensionEvent.Method)),filter_filter((event=>event.data.methodName===name))).subscribe((async event=>{const{ref,args}=event.data,result=await implementation(...args);this._pluginNode.events$.next({source:this._extensionNode,type:"internal:method",data:{result,ref}})}))}}class PluginConnection{constructor(_extensionNode,_pluginNode,lifecycleStage){this._extensionNode=_extensionNode,this._pluginNode=_pluginNode,this.lifecycleStage=lifecycleStage,this.id="",this.name="",this.register=new ExtensionPluginRegister(this._extensionNode,this._pluginNode),this.lifecycle=new Lifecycle(this._pluginNode,lifecycleStage),this.events$=pipe_pipe(this._extensionNode.events$)(filter_filter((event=>event.source===this._pluginNode)),filter_filter((event=>!Object.values(InternalExtensionEvent).includes(event.type))),map_map((({type,data})=>({eventName:type,data}))))}async send(eventName,data){this._pluginNode.events$.next({source:this._extensionNode,type:eventName,data})}on(eventName){return pipe_pipe(this.events$)(filter_filter((event=>event.eventName===eventName)),map_map((event=>event.data)))}}class ExtensionContext{constructor(_extensionNode){this._launcherInterfacePromise=new resolvable_promise_ResolvablePromise,this._pluginInterfacePromise=new resolvable_promise_ResolvablePromise,this.pluginConnected$=pipe_pipe(_extensionNode.events$)(filter_filter((event=>event.type===InternalExtensionEvent.Use)),map_map((event=>new PluginConnection(_extensionNode,event.source,event.data))))}definePluginInterface(pluginInterface){this._pluginInterfacePromise.resolve(pluginInterface)}defineLauncherInterface(launcherInterface){this._launcherInterfacePromise.resolve(launcherInterface)}getLauncherInterface(){return this._launcherInterfacePromise.promise}getPluginInterface(){return this._pluginInterfacePromise.promise}}const loadExtensionScript=async(windowRef,name,reporter)=>{const script=windowRef.document.createElement("script");script.src=`../extensions/${name}/index.js`;const onload=new Promise(((resolve,reject)=>{script.onerror=reject;const eventName=(name=>`core:extension-register-${name}`)(name),onLibraryRequest=event=>{windowRef.removeEventListener(eventName,onLibraryRequest),resolve(event.detail)};windowRef.addEventListener(eventName,onLibraryRequest)})).catch((e=>{const error=reporter.createCoreError(core_controller_error_library_CoreControllerError.EXTENSION_INITIALISATION_FAILED,`EXTENSION ${name} FAILED`,e.stack);reporter.reportError(error)}));windowRef.document.head.appendChild(script),await onload};async function loadExtension(hostNode,ctrlWindowRef,extensionRegistry,name,reporter){const found=extensionRegistry.get(name);if(found)return found;const extensionReporter=new CoreReporter(CoreEntity.Extension),extensionNode=new CoreNode(randomString(),name,CoreNodeType.Extension),context=new ExtensionContext(hostNode),unsubscriber=extensionReporter.onError().subscribe((error=>{reporter.reportError(error)}));return hostNode.unsubscribers.push(unsubscriber),extensionRegistry.set(name,[extensionNode,context]),await loadExtensionScript(ctrlWindowRef,name,extensionReporter),function(ctrlWindowRef,name,context){const ev=new CustomEvent(registeredEvent(name),{detail:context});ctrlWindowRef.dispatchEvent(ev)}(ctrlWindowRef,name,context),[extensionNode,context]}class ExtensionRegistry extends Map{}const createHostNode=()=>new CoreNode("host","host",CoreNodeType.Host),ParamKey_IntegrationType="integration_type",ParamKey_PluginName="plugin_name",_scanForPlugins=(windowRef,frameWindowRefs)=>{const plugins=[];for(let i=0;i<frameWindowRefs.length;i++)try{if(windowRef===frameWindowRefs[i])continue;frameWindowRefs[i].origin===windowRef.location.origin&&plugins.push(frameWindowRefs[i],..._scanForPlugins(windowRef,frameWindowRefs[i]))}catch(error){}return plugins},_findPreloadedPluginIframe=(window,pluginName)=>{const urlSearchParams=new URLSearchParams(window.name);return urlSearchParams.get(ParamKey_IntegrationType)===IntegrationType_PreloadPersistent&&urlSearchParams.get(ParamKey_PluginName)===pluginName};class ParentPlugin{constructor(_childNode,_parentNode){this._childNode=_childNode,this._parentNode=_parentNode,this.id=this._parentNode.id,this.events$=pipe_pipe(_childNode.events$)(filter_filter((event=>event.source===this._parentNode)),map_map((event=>({eventName:event.type,data:event.data}))))}async send(eventName,data){this._parentNode.events$.next({source:this._childNode,type:eventName,data})}on(eventName){return pipe_pipe(this.events$)(filter_filter((event=>event.eventName===eventName||"*"===eventName)),map_map((event=>event.data)))}}class ChildPlugin{constructor(_childNode,_parentNode,_initialConfig,_pluginFactory,_e2eId,_targetElementSelector="body"){this._childNode=_childNode,this._parentNode=_parentNode,this._initialConfig=_initialConfig,this._pluginFactory=_pluginFactory,this._e2eId=_e2eId,this._targetElementSelector=_targetElementSelector,this.id=_childNode.id,this.events$=pipe_pipe(_parentNode.events$)(filter_filter((event=>event.source===this._childNode)),map_map((event=>({eventName:event.type,data:event.data})))),this._onClose=new resolvable_promise_ResolvablePromise}async send(eventName,data){this._childNode.events$.next({source:this._parentNode,type:eventName,data})}on(eventName){return pipe_pipe(this.events$)(filter_filter((event=>event.eventName===eventName)),map_map((event=>event.data)))}onClose(){return this._onClose.promise}async putConfig(config){this._childNode.events$.next({source:this._parentNode,type:PutConfigEvent,data:config})}async close(){var _a;this._parentNode.removeChild(this._childNode),await(null===(_a=this._plugin)||void 0===_a?void 0:_a.close())}async appendToHostSelector(){const plugin=await this._pluginFactory.createChildHostPlugin(this._childNode,this._parentNode,this._e2eId,this._initialConfig);this._plugin=plugin,this._plugin.onClose().then(this._onClose.resolve),plugin.parent=new ParentPlugin(this._childNode,this._parentNode),await plugin.appendTo(this._targetElementSelector)}async appendToParentSelector(){const plugin=await this._pluginFactory.createChildInternalPlugin(this._childNode,this._parentNode,this._e2eId,this._initialConfig);this._plugin=plugin,this._plugin.onClose().then(this._onClose.resolve),plugin.parent=new ParentPlugin(this._childNode,this._parentNode),await plugin.appendTo(this._targetElementSelector)}}class PluginConfigObservable extends Observable{constructor(hostNode,pluginNode,parentNode,_config){super((observer=>(observer.next(this._config),this._observers.push(observer),1===this._observers.length&&this._initialiseSubscription(hostNode,pluginNode,parentNode),()=>{var _a;this._observers=this._observers.filter((element=>element!==observer)),0===this._observers.length&&(null===(_a=this._$$)||void 0===_a||_a.unsubscribe())}))),this._config=_config,this._observers=[],this._$$=null}_initialiseSubscription(hostNode,pluginNode,parentNode){this._$$=pipe_pipe(pluginNode.events$)(filter_filter((event=>event.source===hostNode||event.source===parentNode)),filter_filter((event=>event.type===PutConfigEvent))).subscribe((event=>{this._config=event.data,this._observers.forEach((observer=>{observer.next(this._config)}))}))}}class plugin_display_Display{constructor(_launcherDisplay,_node,_pluginAdapter,_pluginSelector,_domCheckIntervalMillisecond=10,_domCheckTimeoutMillisecond=5e3){this._launcherDisplay=_launcherDisplay,this._node=_node,this._pluginAdapter=_pluginAdapter,this._pluginSelector=_pluginSelector,this._domCheckIntervalMillisecond=_domCheckIntervalMillisecond,this._domCheckTimeoutMillisecond=_domCheckTimeoutMillisecond,this._onResizeSubject=new Subject}async setFullscreen(){await this._launcherDisplay.setFullscreen(this._pluginSelector)}setStyles(_value){throw new Error("to be implemented")}async setSandboxAttributes(sandboxAttributes){await this._pluginAdapter.setSandboxAttributes(sandboxAttributes)}async setTitle(title){await this._pluginAdapter.setTitle(title)}async enableResizeDetection(){const windowRef=this._node.windowRef;windowRef.ResizeObserver||await this._waitUntilReady((()=>!!windowRef.ResizeObserver),this._domCheckIntervalMillisecond,this._domCheckTimeoutMillisecond,"ResizeObserver is not available"),await this.setHeight(windowRef),this._observer=new windowRef.ResizeObserver((async()=>{await this.setHeight(windowRef),this._onResizeSubject.next({height:windowRef.document.documentElement.offsetHeight,width:windowRef.document.body.clientWidth})})),windowRef.document.body||await this._waitUntilReady((()=>!!windowRef.document.body),this._domCheckIntervalMillisecond,this._domCheckTimeoutMillisecond,"document.body is not available"),this._observer.observe(windowRef.document.body)}async disableResizeDetection(){this._observer&&this._observer.disconnect()}async putStyles(cssStyles){await this._pluginAdapter.putStyles(cssStyles)}async setHighestZIndex(){const newZIndex=await this._launcherDisplay.getHighestZIndex()+1;await this._pluginAdapter.putStyles({zIndex:`${newZIndex}`})}async clearStyles(){await this._pluginAdapter.clearStyles()}onResizeDetection(){return this._onResizeSubject.asObservable()}async setHeight(windowRef){await this.putStyles({height:`${windowRef.document.documentElement.offsetHeight}px`})}async _waitUntilReady(isReady,retryMillisecond,timeoutMillisecond,errorMessage){await new Promise(((resolve,reject)=>{const timeoutTimestamp=(new Date).getTime()+timeoutMillisecond,interval=setInterval((()=>{timeoutTimestamp<(new Date).getTime()&&(clearInterval(interval),reject(new Error(errorMessage))),isReady()&&(clearInterval(interval),resolve())}),retryMillisecond)}))}}class PluginExtension{constructor(_pluginNode,_extensionNode,lifecycleStage){this._pluginNode=_pluginNode,this._extensionNode=_extensionNode,this.lifecycleStage=lifecycleStage,this.events$=pipe_pipe(_pluginNode.events$)(filter_filter((event=>event.source===_extensionNode)),filter_filter((event=>"internal:method"!==event.type)),map_map((event=>({eventName:event.type,data:event.data})))),this.send(InternalExtensionEvent.Use,{lifecycleStage})}async send(eventName,data){this._extensionNode.events$.next({source:this._pluginNode,type:eventName,data})}on(eventName){return pipe_pipe(this.events$)(filter_filter((event=>event.eventName===eventName)),map_map((event=>event.data)))}async runMethod(name,args){const ref=randomString(),onReply$=pipe_pipe(this._pluginNode.events$)(filter_filter((event=>event.source===this._extensionNode)),filter_filter((event=>"internal:method"===event.type)),filter_filter((event=>event.data.ref===ref)),map_map((event=>event.data.result))),onReply=first_value_from_firstValueFrom(onReply$);return this._extensionNode.events$.next({source:this._pluginNode,type:InternalExtensionEvent.Method,data:{methodName:name,args,ref}}),await onReply}}class Plugin{constructor(launcherDisplay,_hostNode,_pluginNode,_parentNode,config,_ctrlWindowRef,_extensionRegistry,_pluginFactory,_pluginLibraryFactory,_pluginAdapter,_reporter,_isPluginIframePreloaded=!1){this.launcherDisplay=launcherDisplay,this._hostNode=_hostNode,this._pluginNode=_pluginNode,this._ctrlWindowRef=_ctrlWindowRef,this._extensionRegistry=_extensionRegistry,this._pluginFactory=_pluginFactory,this._pluginLibraryFactory=_pluginLibraryFactory,this._pluginAdapter=_pluginAdapter,this._reporter=_reporter,this._isPluginIframePreloaded=_isPluginIframePreloaded,this.parent=null,this._lifecycleStage=LifecycleState.BeforeInit,this._onClose=new resolvable_promise_ResolvablePromise,this._pluginWindowRef=new resolvable_promise_ResolvablePromise,this._linkNavigationRequestSubscription=null,this._linkNavigationTimeout=null,this.id=_pluginNode.id,this.name=_pluginNode.name,this.isPluginIframePreloaded=this._isPluginIframePreloaded,this.cssSelector=this._selectorForId(_pluginNode.id),this.config$=new PluginConfigObservable(_hostNode,_pluginNode,_parentNode,config),this.display=new plugin_display_Display(launcherDisplay,_pluginNode,_pluginAdapter,this.cssSelector);const topNode=(node=this._pluginNode,hostNode=this._hostNode,reporter=this._reporter,function search(node){return node.parent||reporter.throw(core_controller_error_library_CoreControllerError.COULD_NOT_FIND_NODE),node.parent===hostNode?node:search(node.parent)}(node));var node,hostNode,reporter;this.pluginToControllerCommunication=new NodeCommunication(topNode,this._hostNode),this.controllerToPluginCommunication=new NodeCommunication(this._hostNode,topNode),this._pluginNode.unsubscribers.push(pipe_pipe(this._pluginNode.events$)(filter_filter((event=>event.type===AppendedEvent))).subscribe((()=>this._onAppended()))),this._pluginNode.unsubscribers.push(pipe_pipe(this._pluginNode.events$)(filter_filter((event=>event.type===ClosePluginEvent))).subscribe((()=>{this.close()})))}async createChild({name,e2eId,config,targetElementSelector}){const id=randomString(),node=createPluginNode(id,name);return new ChildPlugin(node,this._pluginNode,config,this._pluginFactory,null!=e2eId?e2eId:"",targetElementSelector)}resetPreloadPluginStatus(){this.isPluginIframePreloaded=!1}async close(){var _a;this._lifecycleStage!==LifecycleState.Closed&&(this._lifecycleStage=LifecycleState.Closed,[...this._pluginNode.children].forEach((childNode=>{childNode.events$.next({source:childNode,type:ClosePluginEvent,data:void 0})})),this._pluginNode.unsubscribers.forEach((unsubscriber=>{unsubscriber.unsubscribe()})),this._pluginNode.unsubscribers.splice(0),null===(_a=this._pluginNode.parent)||void 0===_a||_a.removeChild(this._pluginNode),this._pluginAdapter.close(),this.display.disableResizeDetection(),this._clearLinkNavigationTimeout(),this._onClose.resolve())}async onClose(){await this._onClose.promise}async useExtension(name){const[extensionNode]=await loadExtension(this._hostNode,this._ctrlWindowRef,this._extensionRegistry,name,this._reporter),pluginExtension=new PluginExtension(this._pluginNode,extensionNode,this._lifecycleStage);return methods=["on","send"],properties=["events$"],new Proxy(pluginExtension,{get:(target,key)=>"then"===key?null:properties.includes(key)?target[key]:methods.includes(key)?target[key].bind(target):(...args)=>target.runMethod(key,args)});var methods,properties}async init(){await this._pluginAdapter.putStyles({display:"block"}),this._lifecycleStage=LifecycleState.AfterInit,this._pluginNode.events$.next({source:this._pluginNode,type:internal_events_InternalPluginEventType.LifeCycle,data:this._lifecycleStage})}async appendTo(selector,insertPosition="beforeend"){await this._pluginAdapter.appendTo(selector,insertPosition)}async appendToPreloadedIframe(selector,insertPosition){await this._pluginAdapter.appendToPreloadedIframe(selector,insertPosition)}getPluginWindowRef(){return this._pluginWindowRef.promise}_onAppended(){const preloadedIframePluginName=this.isPluginIframePreloaded?this.name:void 0,pluginWindowRef=((windowRef,id,preloadedIframePluginName)=>{const pluginsWindowRefs=_scanForPlugins(windowRef,windowRef.parent.frames);for(const pluginWindowRef of pluginsWindowRefs)if(pluginWindowRef.name===id||preloadedIframePluginName&&_findPreloadedPluginIframe(pluginWindowRef,preloadedIframePluginName))return pluginWindowRef})(this._ctrlWindowRef,this.id,preloadedIframePluginName);if(pluginWindowRef){this._pluginNode.windowRef=pluginWindowRef,this._pluginWindowRef.resolve(pluginWindowRef);((windowRef,library)=>{windowRef.dispatchEvent(new CustomEvent("core:library-load",{detail:library}))})(pluginWindowRef,this._pluginLibraryFactory(this))}else this._pluginWindowRef.resolve(void 0),this._reporter.throw(CorePluginError_PLUGIN_IFRAME_NOT_FOUND)}_selectorForId(id){return`iframe[id="${id}"]`}_clearLinkNavigationTimeout(){var _a;this._linkNavigationTimeout&&(clearTimeout(this._linkNavigationTimeout),this._linkNavigationTimeout=null,null===(_a=this._linkNavigationRequestSubscription)||void 0===_a||_a.unsubscribe())}}class HostPluginAdapter{constructor(_launcherRPCPlugin){this._launcherRPCPlugin=_launcherRPCPlugin}async appendTo(selector,insertPosition){await this._launcherRPCPlugin.appendTo(selector,insertPosition)}async appendToPreloadedIframe(selector,insertPosition){this._launcherRPCPlugin.markPreloadedPluginAppended(selector,insertPosition)}async clearStyles(){await this._launcherRPCPlugin.clearStyles()}async close(){await this._launcherRPCPlugin.close()}async putStyles(styles){await this._launcherRPCPlugin.setStyles(styles)}async setSandboxAttributes(attributes){await this._launcherRPCPlugin.setSandbox(attributes)}async setTitle(title){await this._launcherRPCPlugin.setTitle(title)}}class InternalPluginAdapter{constructor(_pluginNode,_parentNode,_reporter,_e2eId){this._pluginNode=_pluginNode,this._parentNode=_parentNode,this._reporter=_reporter,this._e2eId=_e2eId}async appendTo(selector,insertPosition){const targetElement=this._parentNode.windowRef.document.querySelector(selector);targetElement||this._reporter.throw(CorePluginError_SELECTOR_NOT_FOUND);const iframe=this._createIframe(this._pluginNode.id,this._pluginNode.name,this._parentNode.windowRef),onLoad=new Promise((res=>iframe.onload=()=>res()));targetElement.insertAdjacentElement(insertPosition,iframe),await onLoad,this._pluginNode.element=iframe,this._pluginNode.windowRef=iframe.contentWindow,this._pluginNode.events$.next({source:this._pluginNode,type:AppendedEvent,data:void 0})}async appendToPreloadedIframe(){let preloadedIframe=this._parentNode.windowRef.document.getElementById(this._pluginNode.name);if(preloadedIframe||(preloadedIframe=this._parentNode.windowRef.document.getElementById(this._pluginNode.id)),preloadedIframe||this._reporter.throw(CorePluginError_PLUGIN_PRELOADED_IFRAME_NOT_FOUND),this._setIframeAttributes(preloadedIframe,this._pluginNode.id),preloadedIframe.onload){const onLoad=new Promise((res=>{preloadedIframe.onload=()=>res()}));await onLoad,preloadedIframe.onload=null}this._pluginNode.element=preloadedIframe,this._pluginNode.windowRef=preloadedIframe.contentWindow,this._pluginNode.events$.next({source:this._pluginNode,type:"internal:appendedToPreloaded",data:void 0})}async clearStyles(){var _a;null===(_a=this._pluginNode.element)||void 0===_a||_a.removeAttribute("style")}async close(){const iframe=this._pluginNode.element;(null==iframe?void 0:iframe.parentNode)&&iframe.parentNode.removeChild(iframe)}async putStyles(_styles){for(const[style,value]of Object.entries(_styles))this._pluginNode.element.style[style]=value}async setSandboxAttributes(_attributes){for(const attr of _attributes)this._pluginNode.element.sandbox.add(attr)}async setTitle(title){this._pluginNode.element.title=title}_createIframe(id,name,window){const iframe=window.document.createElement("iframe");return iframe.src=`../${name}/index.html`,this._setIframeAttributes(iframe,id),iframe}_setIframeAttributes(iframe,id){iframe.name=id,iframe.title="Rokt placement",iframe.style.display="block",iframe.style.width="100%",iframe.style.colorScheme="auto",iframe.setAttribute("data-core-type","plugin"),iframe.setAttribute("data-e2e-id",this._e2eId),iframe.setAttribute("allow","clipboard-write; payment"),iframe.sandbox.add("allow-scripts","allow-same-origin","allow-popups","allow-forms","allow-top-navigation","allow-popups-to-escape-sandbox")}}class PluginFactory{constructor(_ctrlWindowRef,_hostNode,_launcherRPC,_reporter,_extensionRegistry,_createPluginRpc,_pluginLibraryFactory,_preloadedPlugins=new Set){this._ctrlWindowRef=_ctrlWindowRef,this._hostNode=_hostNode,this._launcherRPC=_launcherRPC,this._reporter=_reporter,this._extensionRegistry=_extensionRegistry,this._createPluginRpc=_createPluginRpc,this._pluginLibraryFactory=_pluginLibraryFactory,this._preloadedPlugins=_preloadedPlugins}async createRootPlugin(pluginNode,parentNode,e2eId,shouldUsePreloadPluginIframe,config){const launcherRPCPlugin=await this._createLauncherPlugin(pluginNode,parentNode,e2eId,shouldUsePreloadPluginIframe),hostAdapter=new HostPluginAdapter(launcherRPCPlugin),pluginReporter=this._createReporter(pluginNode);return parentNode.appendChild(pluginNode),new Plugin(this._launcherRPC,this._hostNode,pluginNode,parentNode,config,this._ctrlWindowRef,this._extensionRegistry,this,this._pluginLibraryFactory,hostAdapter,pluginReporter,shouldUsePreloadPluginIframe)}registerPreloadedPluginIframe(pluginName){this._preloadedPlugins.add(pluginName)}getPreloadedPluginNames(){return this._preloadedPlugins}removePreloadedPluginIframe(pluginName){this._launcherRPC.removePreloadedPluginIframe(pluginName),this._preloadedPlugins.delete(pluginName)}async createChildHostPlugin(pluginNode,parentNode,e2eId,config,shouldUsePreloadPluginIframe=!1){const launcherRPCPlugin=await this._createLauncherPlugin(pluginNode,parentNode,e2eId,shouldUsePreloadPluginIframe),pluginReporter=this._createReporter(pluginNode),hostAdapter=new HostPluginAdapter(launcherRPCPlugin);return parentNode.appendChild(pluginNode),new Plugin(this._launcherRPC,this._hostNode,pluginNode,parentNode,config,this._ctrlWindowRef,this._extensionRegistry,this,this._pluginLibraryFactory,hostAdapter,pluginReporter)}async createChildInternalPlugin(pluginNode,parentNode,e2eId,config){const pluginReporter=this._createReporter(pluginNode),pluginAdapter=new InternalPluginAdapter(pluginNode,parentNode,pluginReporter,e2eId);return parentNode.appendChild(pluginNode),new Plugin(this._launcherRPC,this._hostNode,pluginNode,parentNode,config,this._ctrlWindowRef,this._extensionRegistry,this,this._pluginLibraryFactory,pluginAdapter,pluginReporter)}_createReporter(pluginNode){const pluginReporter=new CoreReporter(CoreEntity.Plugin,pluginNode.name);return pluginNode.unsubscribers.push(pluginReporter.onError().subscribe((error=>this._reporter.reportError(error)))),pluginReporter}async _createLauncherPlugin(pluginNode,parentNode,e2eId,shouldUsePreloadPluginIframe){const{id,name}=pluginNode,controllerRPCPlugin=this._createPluginRpc(pluginNode.events$,this._hostNode);return await this._launcherRPC.createPlugin({id,name,e2eId,register:this._hostNode===parentNode,controllerRPCPlugin,shouldUsePreloadPluginIframe})}}class ControllerPluginRegistry extends Map{async clear(){const pluginPromisesToResolve=[];for(const plugin of this.values())pluginPromisesToResolve.push(plugin.close());await Promise.all(pluginPromisesToResolve),super.clear()}}class CookiesService{constructor(rpcCookiesService,rpcLocationService){this.rpcLocationService=rpcLocationService,this._rpcCookiesService=rpcCookiesService}get(key){return this._rpcCookiesService.get(key)}async set(cookie,useBaseDomain=!1){useBaseDomain&&(cookie.domain=await this.getBaseDomain());const cookieString=this.serialize(cookie);return this._rpcCookiesService.set(cookieString)}async getBaseDomain(){const hostname=await this.rpcLocationService.getHostname(),parts=hostname.split("."),tld=parts.pop(),domain=parts.pop();return domain&&tld?`.${domain}.${tld}`:hostname}serialize(cookie){const{name,path="/",sameSite,secure,value,partitioned,domain}=cookie;let{expires}=cookie;if(!expires){const date=new Date;date.setTime(date.getTime()+31536e6),expires=date}let str=`${name}=${value};expires=${expires.toUTCString()};path=${path}`;return domain&&(str+=`;domain=${domain}`),secure&&(str+=";secure"),sameSite&&(str+=`;samesite=${sameSite}`),partitioned&&(str+=";partitioned"),str}}class Controller{constructor(connection,_hostNode,_rpcLauncher,_pluginFactory,_pluginRegistry,_coreReporter,_sessionTransferProxy){this.connection=connection,this._hostNode=_hostNode,this._rpcLauncher=_rpcLauncher,this._pluginFactory=_pluginFactory,this._pluginRegistry=_pluginRegistry,this._coreReporter=_coreReporter,this._sessionTransferProxy=_sessionTransferProxy}async createPlugin({name,config,e2eId,shouldUsePreloadPluginIframe}){const id=randomString(),pluginNode=createPluginNode(id,name),plugin=await this._pluginFactory.createRootPlugin(pluginNode,this._hostNode,null!=e2eId?e2eId:"",shouldUsePreloadPluginIframe,config);return this._pluginRegistry.set(id,plugin),plugin}isPluginIframePreloaded(pluginName){return this._pluginFactory.getPreloadedPluginNames().has(pluginName)}getPreloadedPluginNames(){return this._pluginFactory.getPreloadedPluginNames()}removePreloadedPluginIframe(pluginName){this._pluginFactory.removePreloadedPluginIframe(pluginName)}async getLauncherWindow(){if(!this._launcherWindow){const rpcWindow=await this._rpcLauncher.getWindow();retain(rpcWindow),this._launcherWindow=function(rpcWindow){return{cookies:new CookiesService(rpcWindow.cookies,rpcWindow.location),localStorageService:rpcWindow.localStorage,sessionStorageService:rpcWindow.sessionStorage,locationService:rpcWindow.location,launcherPerformanceService:rpcWindow.performance}}(rpcWindow)}return this._launcherWindow}async getElementBoundingRect(id){return await this._rpcLauncher.getElementBoundingRect(id)}async getElementCoverage(id,requiredCoverage){return await this._rpcLauncher.getElementCoverage(id,requiredCoverage)}async getRoktDomainRecognisers(){return this._sessionTransferProxy.getRoktRecognisers()}async setRoktDomainRecognisers(recognisers){await this._sessionTransferProxy.setRoktRecognisers(recognisers)}async useExtension(_name){throw new Error("to be implemented")}onError(){return this._coreReporter.onError()}async terminate(){await this._pluginRegistry.clear(),await this._rpcLauncher.terminate()}}const shared_PORT_EXCHANGE_MESSAGE="CORE::PORT_EXCHANGE",shared_READY_MESSAGE="CORE::READY",shared_PORT_REQUEST="CORE::WAITING_FOR_PORT";var shared_ConnectionStatus;function rpc_proxy_isArray(result){return Array.isArray(result)}function createRPCProxyFactory({qualifier,handler}){return function createRPCProxy(target){return result=target,Object(result)!==result?target:rpc_proxy_isArray(target)?target.map((element=>createRPCProxy(element))):new Proxy(target,{get(target,property){const value=target[property];return qualifier(value)?handler(value):function(result){return null!==result&&"object"==typeof result&&!rpc_proxy_isArray(result)}(value)?createRPCProxy(value):function(result){return"function"==typeof result}(value)?(...args)=>{const result=value(...args);return function(result){return result instanceof Promise}(result)?result.then((newResult=>createRPCProxy(newResult))):createRPCProxy(result)}:value}});var result}}!function(ConnectionStatus){ConnectionStatus[ConnectionStatus.WAITING=0]="WAITING",ConnectionStatus[ConnectionStatus.CONNECTING=1]="CONNECTING",ConnectionStatus[ConnectionStatus.TRANSFERRING=2]="TRANSFERRING",ConnectionStatus[ConnectionStatus.CONNECTED=3]="CONNECTED",ConnectionStatus[ConnectionStatus.READY=4]="READY",ConnectionStatus[ConnectionStatus.FAILED_UNDEFINED_SOURCE=5]="FAILED_UNDEFINED_SOURCE"}(shared_ConnectionStatus||(shared_ConnectionStatus={}));class RPCMessageHandler{qualifier(value){return null!=value&&"object"==typeof value&&"$rpc"in value}handler(message){switch(message.$rpc){case"HtmlElement":return function(message){return document.querySelector(message.selector)}(message);case"PromiseProperty":return function(message){return message.getValue()}(message);case"Subscriber":return proxy=message,(...args)=>{const subject=new Subject,originUnsubscriber=proxy.getSubscriber(...args).then((subscriber=>subscriber.subscribe({next:value=>subject.next(value),error:err=>subject.error(err),complete:()=>subject.complete()})));return{subscribe:(callback,error,complete)=>{const observer=normaliseToObserver(callback,error,complete),unsubscriber=subject.subscribe(observer);return{unsubscribe:()=>{unsubscriber.unsubscribe(),originUnsubscriber.then((({unsubscribe})=>unsubscribe()))}}}}};case"Listener":return function(proxy){return async(eventName,callback)=>await proxy.setEventListener({eventName,callback:async(...args)=>await callback(...args)})}(message)}var proxy}}async function createController({windowRef,createLauncherExtension=()=>Promise.resolve(void 0),pluginLibraryFactory=plugin=>plugin,debug=!1,domainTransferOrigin,createSelectionServiceExtension=()=>Promise.resolve(void 0)}){const controllerReporter=new CoreReporter(CoreEntity.Controller),connectionEndpoint=function(windowRef,reporter){windowRef.addEventListener("message",(function onPortExchangeMessage(event){if(!isLauncherEvent(event,shared_PORT_EXCHANGE_MESSAGE))return;connection.status=shared_ConnectionStatus.TRANSFERRING;const port=event.ports[0];port.start(),portResolvablePromise.resolve(port),windowRef.removeEventListener("message",onPortExchangeMessage),connection.status=shared_ConnectionStatus.CONNECTED})),windowRef.addEventListener("message",(function onReadyMessage(event){isLauncherEvent(event,shared_READY_MESSAGE)&&(windowRef.removeEventListener("message",onReadyMessage),readyResolvablePromise.resolve(),connection.status=shared_ConnectionStatus.READY)}));const readyResolvablePromise=new resolvable_promise_ResolvablePromise,portResolvablePromise=new resolvable_promise_ResolvablePromise,connection={postMessage:async(message,transferables)=>{try{(await portResolvablePromise.promise).postMessage(message,transferables)}catch(err){reporter.throw(core_controller_error_library_CoreControllerError.POST_MESSAGE_CONNECTION_ERROR,[err,message,transferables].map((elem=>JSON.stringify(elem))).join("-"))}},addEventListener:async(event,listener)=>{(await portResolvablePromise.promise).addEventListener(event,listener)},removeEventListener:async(event,listener)=>{(await portResolvablePromise.promise).removeEventListener(event,listener)},terminate:async()=>{(await portResolvablePromise.promise).close()},status:shared_ConnectionStatus.WAITING,ready:async()=>{windowRef.parent.postMessage(shared_READY_MESSAGE,"*")},onReady:()=>readyResolvablePromise.promise};return windowRef.parent.postMessage(shared_PORT_REQUEST,"*"),connection;function isLauncherEvent(event,messageKey){return event&&"string"==typeof event.data&&event.data===messageKey&&event.source===windowRef.parent}}(windowRef,controllerReporter),sessionTransferEndpoint=function(windowRef,origin){windowRef.addEventListener("message",(function onPortRequestMessage(event){isSessionTransferEvent(event,shared_PORT_REQUEST)&&(connection.status=shared_ConnectionStatus.TRANSFERRING,windowRef.removeEventListener("message",onPortRequestMessage),event.source?(event.source.postMessage(shared_PORT_EXCHANGE_MESSAGE,{targetOrigin:origin,transfer:[port2]}),port1.start(),connection.status=shared_ConnectionStatus.CONNECTED):connection.status=shared_ConnectionStatus.FAILED_UNDEFINED_SOURCE)})),windowRef.addEventListener("message",(function onReadyMessage(event){isSessionTransferEvent(event,shared_READY_MESSAGE)&&(windowRef.removeEventListener("message",onReadyMessage),readyResolvablePromise.resolve(),connection.status=shared_ConnectionStatus.READY)}));const readyResolvablePromise=new resolvable_promise_ResolvablePromise,{port1,port2}=new windowRef.MessageChannel,connection=Object.assign(Object.assign({},(messagePort=port1,{postMessage:(...args)=>messagePort.postMessage(...args),addEventListener:(...args)=>messagePort.addEventListener(...args),removeEventListener:(...args)=>messagePort.removeEventListener(...args),terminate(){messagePort.close()}})),{status:shared_ConnectionStatus.WAITING,ready:async()=>{windowRef.parent.postMessage(shared_READY_MESSAGE,"*")},onReady:()=>readyResolvablePromise.promise});var messagePort;return connection;function isSessionTransferEvent(event,messageKey){return event&&"string"==typeof event.data&&event.data===messageKey&&event.origin===origin}}(windowRef,domainTransferOrigin);try{const hostNode=createHostNode(),controllerPluginRegistry=new ControllerPluginRegistry,extensionRegistry=new ExtensionRegistry,createRPCProxy=createRPCProxyFactory(new RPCMessageHandler),endpoint=createEndpoint(connectionEndpoint),rpcLauncher=createRPCProxy(endpoint.call),sessionTransferProxy=createRPCProxy(createEndpoint(sessionTransferEndpoint).call),pluginFactory=new PluginFactory(windowRef,hostNode,rpcLauncher,controllerReporter,extensionRegistry,createPluginRPC,pluginLibraryFactory),rpcControllerProxy=function(windowRef,createLauncherExtensionFunc,extensionRegistry,pluginFactory,hostNode,controllerReporter,createSelectionServiceExtensionFunc){return{async createPlugin(name,config,e2eId,shouldUsePreloadPluginIframe){const id=randomString(),pluginNode=createPluginNode(id,name);return(await pluginFactory.createRootPlugin(pluginNode,hostNode,e2eId,shouldUsePreloadPluginIframe,config)).id},registerPreloadedPluginIframe(pluginName){pluginFactory.registerPreloadedPluginIframe(pluginName)},async useExtension(name){const[,extensionContext]=await loadExtension(hostNode,windowRef,extensionRegistry,name,controllerReporter);return extensionContext.getLauncherInterface()},async getLauncherExtension(...args){const launcherExtension=createLauncherExtensionFunc(...args);return launcherExtension||controllerReporter.throw(core_controller_error_library_CoreControllerError.LAUNCHER_EXTENSION_UNDEFINED),launcherExtension},getSelectionServiceExtension:async()=>createSelectionServiceExtensionFunc(),async reportError(error){controllerReporter.reportError(error)},async onConnected(){}}}(windowRef,createLauncherExtension,extensionRegistry,pluginFactory,hostNode,controllerReporter,createSelectionServiceExtension),controller=new Controller(connectionEndpoint,hostNode,rpcLauncher,pluginFactory,controllerPluginRegistry,controllerReporter,sessionTransferProxy);return endpoint.expose(rpcControllerProxy),connectionEndpoint.ready(),debug&&(windowRef.CoreDebug={hostNode,extensionRegistry,CoreNode}),controller}catch(e){throw e.message=`${e.message}; Connection status ${connectionEndpoint.status}`,e}}const TargetSections_ThankYou="ThankYou",TargetSections_Confirmation="None",StageToSectionMap={[S.ThankYouPageStages.ThankYouPage]:TargetSections_ThankYou,[S.ThankYouPageStages.ConfirmationPage]:TargetSections_Confirmation,[S.ThankYouPageStages.Waiting]:""};class ThankYouPageSelectPlacementMiddleware{constructor(){this._placementsGroupedByTargetSection={},this._hasThankYouPageStage=new resolvable_promise_ResolvablePromise,this.updateSelectionData=_selectionData=>{},this.splitSelectionData=selectionData=>{if(!this._selectionDataStream){const firstPromise=new Promise(((resolve,reject)=>{selectionData.then((selectionModel=>{var _a;this._context=selectionModel.context,this._placementsGroupedByTargetSection=selectionModel.placements.reduce(((groups,placement)=>{const targetSection=placement.targetSection||TargetSections_Confirmation;return(groups[targetSection]||(groups[targetSection]=[])).push(placement),groups}),{}),resolve({context:selectionModel.context,placements:[]}),this._hasThankYouPageStage.resolve(!!(null===(_a=this._placementsGroupedByTargetSection.ThankYou)||void 0===_a?void 0:_a.length))})).catch(reject)}));this._selectionDataStream=new BehaviorSubject(firstPromise)}return this._selectionDataStream.asObservable()}}hasThankYouPageStage(){return this._hasThankYouPageStage.promise}nextSelectionData(stage){const targetSection=StageToSectionMap[stage];this._sendSelectionDataWithPlacements(this._placementsGroupedByTargetSection[targetSection]),this._placementsGroupedByTargetSection[targetSection]=[]}flush(){const placements=Object.values(this._placementsGroupedByTargetSection).flat();this._sendSelectionDataWithPlacements(placements),this.complete()}complete(){var _a;null===(_a=this._selectionDataStream)||void 0===_a||_a.complete(),this._hasThankYouPageStage.isPending()&&this._hasThankYouPageStage.reject("Middleware forced to complete")}_sendSelectionDataWithPlacements(placements=[]){var _a;const selectionData=Promise.resolve({context:this._context,placements});null===(_a=this._selectionDataStream)||void 0===_a||_a.next(selectionData)}}function cancelableTimeoutPromise(timeout,...promises){let resolveCallback=noop;const race=Promise.race([...promises,new Promise(((resolve,reject)=>{resolveCallback=resolve,setTimeout((()=>{reject(`Timeout after ${timeout} milliseconds`)}),timeout)}))]);return Object.defineProperty(race,"cancel",{value:value=>{resolveCallback(value)}}),race}class ThankYouPageJourneyObserver{constructor(middleWare,journeyManagerService){this._stageChangeCallbacks={},this.next=stage=>{if(stage!==S.ThankYouPageStages.ThankYouPage&&stage!==S.ThankYouPageStages.ConfirmationPage)return;const partnerCallback=this._stageChangeCallbacks[stage];if(!partnerCallback)return this._timeout=cancelableTimeoutPromise(500),void this._timeout.then(void 0,(()=>{this._middleWare.flush()}));partnerCallback().then((result=>{var _a;result?null===(_a=this._middleWare)||void 0===_a||_a.nextSelectionData(stage):this._journeyManagerService.setNextStage()}))},this.error=error=>{throw this._middleWare.flush(),error},this.complete=()=>this._middleWare.complete(),this.onStageChange=(stageName,partnerCallback,currentStageName)=>{var _a;this._stageChangeCallbacks[stageName]||(this._stageChangeCallbacks[stageName]=partnerCallback,stageName===currentStageName&&(null===(_a=this._timeout)||void 0===_a||_a.cancel(),this.next(stageName)))},this._middleWare=middleWare,this._journeyManagerService=journeyManagerService}}class ThankYouPageExtensionManager{constructor({errorService,selectionService,journeyManagerService,selectionMiddlewareService}){this._listenerProxyMessage=function(){const retained=[];return{createListenerProxyMessage:listener=>({$rpc:"Listener",setEventListener:async({eventName,callback})=>(retain(callback),retained.push(callback),await listener(eventName,callback))}),release:()=>retained.forEach((callback=>release(callback)))}}(),this._onStageChange=async(stageName,partnerCallback)=>{var _a;return null===(_a=this._journeyObserver)||void 0===_a?void 0:_a.onStageChange(stageName,partnerCallback,this._journeyManagerService.getCurrentStage())},this._selectionOnEventComplete=()=>{var _a;null===(_a=this._selectionOnEventSubscription)||void 0===_a||_a.unsubscribe()},this._onSelectionChange=selection=>{var _a;this._currentSelection=selection,null===(_a=this._selectionOnEventSubscription)||void 0===_a||_a.unsubscribe(),this._timeout=cancelableTimeoutPromise(2e3,selection.ready()),this._timeout.then(void 0,this._onSelectionError).catch(this._onSelectionError),this._selectionOnEventSubscription=merge(selection.on(a_OFFER_ENGAGEMENT),selection.on(a_PLACEMENT_CLOSED)).subscribe({next:this._nextStage,complete:this._selectionOnEventComplete,error:this._onSelectionError})},this._nextStage=()=>{var _a;null===(_a=this._timeout)||void 0===_a||_a.cancel(),this._journeyManagerService.setNextStage(),this._selectionOnEventComplete()},this._onSelectionError=message=>{const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.EXTENSION_SELECTION_ERROR,severity:wsdk_error_WSDKErrorSeverity.ERROR,message:`ThankYouPage extension - ${message||"unknown error"}`});this._errorService.report(contextError),this._nextStage()},this._selectionService=selectionService,this._journeyManagerService=journeyManagerService,this._selectionMiddlewareService=selectionMiddlewareService,this._errorService=errorService,this._selectionServiceSubscription=this._selectionService.onSelection().subscribe({next:this._onSelectionChange,complete:this._selectionOnEventComplete})}terminate(){var _a,_b;this._listenerProxyMessage.release(),null===(_a=this._selectionServiceSubscription)||void 0===_a||_a.unsubscribe(),this._selectionOnEventComplete(),this._journeyManagerService.cancel(),null===(_b=this._journeySubscription)||void 0===_b||_b.unsubscribe(),this._middleWare&&this._selectionMiddlewareService.unregisterMiddleware(this._middleWare)}async init(){if(this._middleWare){this.terminate();const contextError=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.EXTENSION_INITIALIZATION,severity:wsdk_error_WSDKErrorSeverity.WARNING,message:"ThankYouPage extension multiple attempts to init"});this._errorService.report(contextError)}return this._middleWare=new ThankYouPageSelectPlacementMiddleware,this._journeyObserver=new ThankYouPageJourneyObserver(this._middleWare,this._journeyManagerService),this._journeyManagerService.init({_firstStage:S.ThankYouPageStages.Waiting,stages:{[S.ThankYouPageStages.Waiting]:[S.ThankYouPageStages.ThankYouPage,S.ThankYouPageStages.ConfirmationPage],[S.ThankYouPageStages.ThankYouPage]:[S.ThankYouPageStages.ConfirmationPage],[S.ThankYouPageStages.ConfirmationPage]:[BasicStages_COMPLETE]}}),this._journeySubscription=this._journeyManagerService.onChange().subscribe(this._journeyObserver),this._selectionMiddlewareService.registerMiddleware(this._middleWare),this._middleWare.hasThankYouPageStage().then((has=>{has?this._journeyManagerService.setNextStage(S.ThankYouPageStages.ThankYouPage):this._journeyManagerService.setNextStage(S.ThankYouPageStages.ConfirmationPage)})),{changeToStage:async stageName=>this._journeyManagerService.setNextStage(stageName),onStageChange:this._listenerProxyMessage.createListenerProxyMessage(this._onStageChange),getCurrentSelection:()=>this.getCurrentSelection(),getNextSelection:()=>this.getNextSelection()}}getCurrentSelection(){return this._currentSelection}getNextSelection(){return observable=this._selectionService.onSelection(),new Promise(((resolve,reject)=>{const subscription=observable.subscribe(((...value)=>{resolve(...value),subscription.unsubscribe()}),reject,reject)}));var observable}}class UserActionExtensionManager{constructor({errorService,signalMiddlewareService}){this._errorService=errorService,this._signalMiddlewareService=signalMiddlewareService}async init(){return Promise.resolve({send:this.send.bind(this)})}terminate(){}send(event){try{const{option}=event;this._signalMiddlewareService.capturePartnerEvent(option)}catch(error){const contextError=create_contextual_error_createContextualError(error,{code:error_codes_ErrorCodes.EXTERNAL_EVENT_ERROR,severity:wsdk_error_WSDKErrorSeverity.ERROR});this._errorService.report(contextError)}}}const partnerPlacements=new Map,registerPartnerPlacement=(id,placement)=>{partnerPlacements.set(id,placement)},getPartnerPlacement=id=>partnerPlacements.get(id),removePartnerPlacement=id=>{partnerPlacements.delete(id)};function _mapPartnerPlacementEvent(eventName,eventData,partnerPlacement){return"*"===eventName?{event:eventData.eventName,body:eventData.data,placement:partnerPlacement}:{event:eventName,body:eventData,placement:partnerPlacement}}const errors_wsdk_error_WSDKErrorSeverity={ERROR:"ERROR",INFO:"INFO",WARNING:"WARNING"};class contextual_error_ContextualError extends Error{constructor(context){var _a,_b;super(context.code),this.name=null!==(_a=context.name)&&void 0!==_a?_a:this.name,this.message=context.message||context.code||"",this.code=context.code,this.additionalInformation=context.additionalInformation,this.handled=null!==(_b=context.handled)&&void 0!==_b&&_b,this.severity=context.severity||errors_wsdk_error_WSDKErrorSeverity.ERROR,this.integration=context.integration,this.reporter=context.reporter,context.stack&&(this.stack=context.stack)}}const create_contextual_error_fallbackErrorContext={code:"UNKNOWN_ERROR",severity:errors_wsdk_error_WSDKErrorSeverity.ERROR};const controller_constants_error_codes_ErrorCodes={CONTROLLER_FRAME_LOAD:"CONTROLLER_FRAME_LOAD",ETAG_REQUEST:"ETAG_REQUEST",INVALID_NEXT_JOURNEY_STAGE:"INVALID_NEXT_JOURNEY_STAGE",JOURNEY_NOT_INITIALISED:"JOURNEY_NOT_INITIALISED",METHOD_SELECTION_UNSUBSCRIBE:"METHOD_SELECTION_UNSUBSCRIBE",PLACEMENT_NOT_FOUND:"PLACEMENT_NOT_FOUND",PUT_STYLES:"PUT_STYLES",REQUEST_ERROR:"REQUEST_ERROR",RESIZE_DETECTION:"RESIZE_DETECTION",SANDBOX_ATTRIBUTES:"SANDBOX_ATTRIBUTES",SET_TITLE:"SET_TITLE",V1_METRIC_FAILURE:"V1_METRIC_FAILURE",URL_CHILD_PLUGIN_CREATED:"URL_CHILD_PLUGIN_CREATED",ONS_EVENTS_WARNING_THRESHOLD_EXCEEDED:"ONS_EVENTS_WARNING_THRESHOLD_EXCEEDED",ONS_SHUT_DOWN_TRIGGERED:"ONS_SHUT_DOWN_TRIGGERED",INVALID_CONTROLLER_REMOTE_CALL:"INVALID_CONTROLLER_REMOTE_CALL"};function createPartnerSelection(selection,errorService){const placements=new Promise((resolve=>{selection.getPlacements().then((placements=>{resolve(placements.map((placement=>function(placement){const existingPlacement=getPartnerPlacement(placement.id);let earlyEventCache=[];if(existingPlacement)return existingPlacement;const partnerPlacement={id:placement.placementId,element:createHtmlElementMessage(placement.cssSelector),close:async()=>{await placement.close()},on:createSubscriberMethodProxyMessage((event=>(earlyEventSubscription&&(earlyEventSubscription.unsubscribe(),earlyEventSubscription=null),new Observable((subscriber=>{earlyEventCache=earlyEventCache.filter((cachedEvent=>{const shouldProcess=cachedEvent.event===event||"*"===event;return shouldProcess&&subscriber.next(cachedEvent),!shouldProcess})),pipe_pipe(placement.controllerToPluginCommunication.on(event))(map_map((eventData=>_mapPartnerPlacementEvent(event,eventData,partnerPlacement)))).subscribe(subscriber)}))))),ready:async()=>{await placement.ready()},send:async(event,data)=>placement.controllerToPluginCommunication.send(event,data),onClose:async()=>placement.onClose()};registerPartnerPlacement(placement.id,partnerPlacement);let earlyEventSubscription=pipe_pipe(placement.controllerToPluginCommunication.on("*"))(map_map((event=>{earlyEventCache.push(_mapPartnerPlacementEvent(event.eventName,event,partnerPlacement))}))).subscribe();return placement.onClose().then((()=>{removePartnerPlacement(placement.id),earlyEventCache.length=0})),partnerPlacement}(placement))))}))}));return{context:(selectionContext=selection.context,{pageId:createPromisePropertyMessage(Promise.resolve(selectionContext.getPageId())),pageInstanceGuid:createPromisePropertyMessage(Promise.resolve(selectionContext.getPageInstanceGuid())),pageVariantName:createPromisePropertyMessage(Promise.resolve(selectionContext.getPageVariantName())),sessionId:createPromisePropertyMessage(Promise.resolve(selectionContext.getSessionId()))}),async close(){const placements=await selection.getPlacements();await Promise.all(placements.map((placement=>placement.close())))},getPlacements:async()=>placements,on:createSubscriberMethodProxyMessage((eventName=>pipe_pipe(selection.on(eventName))(map_map((({eventName,data,placementId})=>({event:eventName,body:data,placement:getPartnerPlacement(placementId)})))))),async ready(){await selection.ready()},send:async(event,data)=>(await selection.ready(),selection.send(event,data)),async setAttributes(attributes){selection.setAttributes(attributes)},unsubscribe(){errorService.report(function(error,defaultContext={}){const context=Object.assign(Object.assign({},create_contextual_error_fallbackErrorContext),defaultContext);if((unknownObj=error)&&"object"==typeof unknownObj){const wsdkError=error;wsdkError.name&&(context.name=wsdkError.name),wsdkError.message&&(context.message=wsdkError.message),wsdkError.stack&&(context.stack=wsdkError.stack),wsdkError.code&&(context.code=wsdkError.code),wsdkError.reporter&&(context.reporter=wsdkError.reporter),wsdkError.integration&&(context.integration=wsdkError.integration),wsdkError.severity&&(context.severity=wsdkError.severity),void 0!==wsdkError.handled&&(context.handled=wsdkError.handled),wsdkError.additionalInformation&&(context.additionalInformation=Object.assign(Object.assign({},context.additionalInformation),wsdkError.additionalInformation))}var unknownObj;return new contextual_error_ContextualError(context)}({code:controller_constants_error_codes_ErrorCodes.METHOD_SELECTION_UNSUBSCRIBE,severity:errors_wsdk_error_WSDKErrorSeverity.INFO}))}};var selectionContext}var create_partner_public_launcher_rest=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t};function createPartnerPublicLauncher(services,coreControllerPromise,version){const{attributesService,errorService,selectionService}=services,_a=function(contextContainer){const{partnerValidationService}=contextContainer,getValidationStatus=partnerValidationService.getValidationStatus.bind(partnerValidationService),activatePartnerValidation=partnerValidationService.activatePartnerValidation.bind(partnerValidationService);let extensionAPICache={},extensionsRefCache=[];const getExtensionFromCache=extensionName=>(extensionAPICache[extensionName]||(extensionAPICache[extensionName]=new resolvable_promise_ResolvablePromise),extensionAPICache[extensionName]);return{use:extensionName=>{const fromCache=getExtensionFromCache(extensionName);if(!fromCache.isPending())return fromCache.promise;if(extensionName===t.Extension.PartnerValidation){activatePartnerValidation();const partnerExtensionAPI={getValidationStatus};return fromCache.resolve(partnerExtensionAPI),fromCache.promise}if(extensionName===t.Extension.ThankYouPageJourney){const extension=new ThankYouPageExtensionManager(contextContainer);return extensionsRefCache.push(extension),extension.init().then((value=>{fromCache.isPending()&&fromCache.resolve(value)})).catch(fromCache.reject),fromCache.promise}if(extensionName===t.Extension.UserAction){const extension=new UserActionExtensionManager(contextContainer);return extensionsRefCache.push(extension),extension.init().then((value=>{fromCache.isPending()&&fromCache.resolve(value)})).catch(fromCache.reject),fromCache.promise}throw new Error("Unknown extension name")},getExtension:async extensionName=>getExtensionFromCache(extensionName).promise,terminateExtensions:async()=>{Object.values(extensionAPICache).forEach((resolvablePromise=>{resolvablePromise.isPending()&&resolvablePromise.reject()})),extensionAPICache={},await Promise.all(extensionsRefCache.map((extension=>extension.terminate()))),extensionsRefCache=[]}}}(services),{terminateExtensions}=_a,extensionAPIs=create_partner_public_launcher_rest(_a,["terminateExtensions"]);return Object.assign({get version(){return version},async captureConversion(captureConversionOptions,partnerSelectionTimestamp){const selection=await selectionService.selectPlacements(captureConversionOptions,partnerSelectionTimestamp),placements=await selection.getPlacements();placements&&placements.length>0&&errorService.report(create_contextual_error_createContextualError({code:error_codes_ErrorCodes.SELECTION_MADE_FOR_CONVERSION,severity:wsdk_error_WSDKErrorSeverity.WARNING}))},hashAttributes:async attributes=>attributesService.hash(attributes),selectPlacements:async(options,selectTiming)=>createPartnerSelection(await selectionService.selectPlacements(Object.assign({},options),selectTiming),errorService),async terminate(){try{terminateExtensions();const coreController=await coreControllerPromise;await coreController.terminate()}catch(error){const contextualError=create_contextual_error_createContextualError(error,{code:error_codes_ErrorCodes.TERMINATE_FAILED,severity:wsdk_error_WSDKErrorSeverity.ERROR});errorService.report(contextualError)}}},extensionAPIs)}const LOG_SEND_TIMEOUT=1e3;function createRoktLauncherFactory(services,coreControllerPromise){return async function(options){const{environmentConfigService,integrationConfigurationService,loggingService,partnerConfigService,rdnMetricEventService,recogniserService,referralService,globalSessionService,eventDataService}=services,{customHeaders,doNotShareOrSell,integration,integrationStart,noDeviceId,noFunctional,noTargeting,pageStart,sandbox,sessionId,version,roktCookies,roktLocalStorage,launcherInstanceGuid,proxySubPath,isPreparativeIframe,optedInExtensions=[],integrationUrl,overrideLinkNavigation,deepLinkingPattern,initLoggingEnabled}=options;!0===sandbox&&services.window.console.warn("ROKT: 'sandbox' mode enabled. ROKT Placements shown will not generate revenue. If this is not intended then please omit the 'sandbox' flag when initializing ROKT's SDK.");const tagId=String(options.accountId),partnerId=tagId.indexOf("_")>=0?tagId.substring(0,tagId.indexOf("_")):tagId;partnerConfigService.setTagId(tagId),partnerConfigService.setPartnerId(partnerId),partnerConfigService.setRoktFirstTouch(integrationStart),integrationConfigurationService.setIntegration(integration||""),setIntegration$(integration),setActiveExtensions$(optedInExtensions),setIntegrationUrl(integrationUrl||""),integrationConfigurationService.setVersion(null!=version?version:""),integrationConfigurationService.setLauncherInstanceGuid(null!=launcherInstanceGuid?launcherInstanceGuid:""),partnerConfigService.setDoNotShareOrSell(!0===doNotShareOrSell);const isNoDeviceIdPartner=environmentConfigService.isNoDeviceIdPartner(partnerId);environmentConfigService.setIsInitLogEnabled(initLoggingEnabled);const useNoDeviceId=noDeviceId||isNoDeviceIdPartner;partnerConfigService.setNoFunctional(useNoDeviceId||!0===noFunctional),partnerConfigService.setNoTargeting(useNoDeviceId||!0===noTargeting),partnerConfigService.setSandbox(!0===sandbox),partnerConfigService.setProxySubPath(null!=proxySubPath?proxySubPath:""),partnerConfigService.setOverrideLinkNavigation(null!=overrideLinkNavigation&&overrideLinkNavigation),partnerConfigService.setDeepLinkingPattern(null!=deepLinkingPattern?deepLinkingPattern:""),integrationConfigurationService.setCustomHeaders(customHeaders||{}),recogniserService.setFirstPartyRecognisers(null!=roktLocalStorage?roktLocalStorage:{},null!=roktCookies?roktCookies:{}),recogniserService.initialiseRecognisers(),referralService.setReferralId(null!=roktLocalStorage?roktLocalStorage:{},null!=roktCookies?roktCookies:{}),globalSessionService.initSession(sessionId||"",roktCookies||{}),eventDataService.loadEventData(),rdnMetricEventService.triggerPageMetricEvent({type:IRdnMetricEventType.ROKT_START,clientTimestamp:integrationStart}),rdnMetricEventService.triggerPageMetricEvent({type:IRdnMetricEventType.PAGE_START,clientTimestamp:pageStart});const launcherExtensionPrivate=function({errorService,loggingService,launcherEventsService}){return{async raiseError(error){const contextualError=create_contextual_error_createContextualError(error);await errorService.report(contextualError)},on:createSubscriberMethodProxyMessage((event=>pipe_pipe(launcherEventsService.on(event))(map_map((eventData=>({event:eventData.event,body:eventData.body})))))),async log(entry){await loggingService.log(entry)}}}(services),launcherExtensionPublic=createPartnerPublicLauncher(services,coreControllerPromise,version);if(isPreparativeIframe)return{public:launcherExtensionPublic,private:launcherExtensionPrivate};const launcherInitData=first_value_from_firstValueFrom(getLauncherInitData$());return Promise.race([launcherInitData,sleep_sleep(LOG_SEND_TIMEOUT)]).then((data=>{let fromCache,href;if(null==data?void 0:data.result){const{downloadDuration,partnerPageHref}=data.result;href=partnerPageHref,void 0!==downloadDuration&&(fromCache=String(downloadDuration<10))}initLoggingEnabled&&loggingService.log({code:error_codes_ErrorCodes.LAUNCHER_VERSION,additionalInformation:{fromCache:String(fromCache),partnerPageHref:String(href),optedInExtensions:String(optedInExtensions)}}).catch((_error=>{}))})),{public:launcherExtensionPublic,private:launcherExtensionPrivate}}}const launcher_initialization_LOG_SEND_TIMEOUT=1e3;function createSelectionServiceFactory(serviceContainer){const{selectionService,errorService,loggingService}=serviceContainer;return()=>({selectPlacements:async(launcherOptions,options,partnerSelectionTimestamp)=>(function(options,serviceContainer){const{customHeaders,doNotShareOrSell,accountId,integration,integrationStart,noDeviceId,noFunctional,noTargeting,pageStart,sandbox,sessionId,version,roktCookies,roktLocalStorage,launcherInstanceGuid,proxySubPath,integrationUrl,overrideLinkNavigation,deepLinkingPattern,optedInExtensions=[],initLoggingEnabled}=options||{},{environmentConfigService,partnerConfigService,recogniserService,referralService,globalSessionService,integrationConfigurationService,rdnMetricEventService,eventDataService}=serviceContainer,tagId=String(accountId),partnerId=tagId.indexOf("_")>=0?tagId.substring(0,tagId.indexOf("_")):tagId;partnerConfigService.setTagId(tagId),partnerConfigService.setPartnerId(partnerId),partnerConfigService.setRoktFirstTouch(integrationStart||0),integrationConfigurationService.setIntegration(integration||""),setIntegration$(integration||""),setActiveExtensions$(optedInExtensions),setIntegrationUrl(integrationUrl||""),integrationConfigurationService.setVersion(null!=version?version:""),integrationConfigurationService.setLauncherInstanceGuid(null!=launcherInstanceGuid?launcherInstanceGuid:""),partnerConfigService.setDoNotShareOrSell(!0===doNotShareOrSell);const isNoDeviceIdPartner=environmentConfigService.isNoDeviceIdPartner(partnerId);environmentConfigService.setIsInitLogEnabled(initLoggingEnabled||!1);const useNoDeviceId=noDeviceId||isNoDeviceIdPartner;partnerConfigService.setNoFunctional(useNoDeviceId||!0===noFunctional),partnerConfigService.setNoTargeting(useNoDeviceId||!0===noTargeting),partnerConfigService.setSandbox(!0===sandbox),partnerConfigService.setProxySubPath(null!=proxySubPath?proxySubPath:""),partnerConfigService.setOverrideLinkNavigation(null!=overrideLinkNavigation&&overrideLinkNavigation),partnerConfigService.setDeepLinkingPattern(null!=deepLinkingPattern?deepLinkingPattern:""),integrationConfigurationService.setCustomHeaders(customHeaders||{}),recogniserService.setFirstPartyRecognisers(null!=roktLocalStorage?roktLocalStorage:{},null!=roktCookies?roktCookies:{}),recogniserService.initialiseRecognisers(),referralService.setReferralId(null!=roktLocalStorage?roktLocalStorage:{},null!=roktCookies?roktCookies:{}),globalSessionService.initSession(sessionId||"",roktCookies||{}),eventDataService.loadEventData(),rdnMetricEventService.triggerPageMetricEvent({type:IRdnMetricEventType.ROKT_START,clientTimestamp:integrationStart||0}),rdnMetricEventService.triggerPageMetricEvent({type:IRdnMetricEventType.PAGE_START,clientTimestamp:pageStart||0})}(launcherOptions,serviceContainer),function(launcherOptions,loggingService){const launcherInitData=first_value_from_firstValueFrom(getLauncherInitData$());Promise.race([launcherInitData,sleep_sleep(launcher_initialization_LOG_SEND_TIMEOUT)]).then((data=>{let fromCache,href;if(null==data?void 0:data.result){const{downloadDuration,partnerPageHref}=data.result;href=partnerPageHref,void 0!==downloadDuration&&(fromCache=String(downloadDuration<10))}launcherOptions.initLoggingEnabled&&loggingService.log({code:error_codes_ErrorCodes.LAUNCHER_VERSION,additionalInformation:{fromCache:String(fromCache),partnerPageHref:String(href),optedInExtensions:String(launcherOptions.optedInExtensions)}}).catch((_error=>{}))}))}(launcherOptions,loggingService),createPartnerSelection(await selectionService.selectPlacements(options,partnerSelectionTimestamp),errorService))})}class LauncherWindowService{constructor(_coreControllerPromise,errorServicePromise){this._coreControllerPromise=_coreControllerPromise,this._launcherWindowPromise=new resolvable_promise_ResolvablePromise,this._coreControllerPromise.then((async coreController=>{try{const launcherWindow=await coreController.getLauncherWindow();this._launcherWindowPromise.resolve(launcherWindow)}catch(e){const errorService=await errorServicePromise,contextualError=create_contextual_error_createContextualError(e,{code:"LAUNCHER_WINDOW_SERVICE_ERROR"});errorService.report(contextualError),this._launcherWindowPromise.reject(contextualError)}}))}async getCookiesService(){return this._launcherWindowPromise.promise.then((launcherWindow=>launcherWindow.cookies))}async getLocalStorageService(){return this._launcherWindowPromise.promise.then((launcherWindow=>launcherWindow.localStorageService))}async getSessionStorageService(){return this._launcherWindowPromise.promise.then((launcherWindow=>launcherWindow.sessionStorageService))}async getLocationService(){return this._launcherWindowPromise.promise.then((launcherWindow=>launcherWindow.locationService))}async getLauncherPerformanceService(){return this._launcherWindowPromise.promise.then((launcherWindow=>launcherWindow.launcherPerformanceService))}}function reportCoreControllerError(error,integrationUrl){const errReport=createErrorReport(error.message,error.name,error_codes_ErrorCodes.UNKNOWN_ERROR,wsdk_error_WSDKErrorSeverity.ERROR,error.stack);(0,integration.reportError)(errReport,integrationUrl)}const createErrorReport=(message,name,code,severity,stack)=>Object.assign({message,name,code,severity,tagId:""},stack&&{additionalInformation:{stack}});class child_plugin_ChildPlugin{constructor(_plugin){this._plugin=_plugin,_plugin.then((childPlugin=>{childPlugin.appendToHostSelector("body")}))}async close(){const childPlugin=await this._plugin;await childPlugin.close()}async onClose(){const childPlugin=await this._plugin;await childPlugin.onClose()}async putConfig(config){const childPlugin=await this._plugin;await childPlugin.putConfig(config)}async send(eventName,body){const childPlugin=await this._plugin;await childPlugin.send(eventName,body)}onEvent(eventName){const eventsSubject=new Subject;return this._plugin.then((childPlugin=>{childPlugin.on(eventName).subscribe((event=>{eventsSubject.next(event)}))})),eventsSubject.asObservable()}}class ChildPluginFactory{constructor(_placement){this._placement=_placement}create(options){const{url,name,config,targetElementSelector}=options;let pluginName=name;url&&!name&&(pluginName=(href=>{try{return href.split("/plugins/")[1].split("/")[0]}catch(error){return"[no-alias]"+href}})(url),this._logUrlChildPlugin(url));const coreChildPlugin=this._placement.createChildPlugin(pluginName,config,{targetElementSelector});return new child_plugin_ChildPlugin(coreChildPlugin)}_logUrlChildPlugin(url){this._placement.loggingService.log({code:constants_error_codes_ErrorCodes_URL_CHILD_PLUGIN_CREATED,additionalInformation:{url}})}}class Theme{constructor(configurablesSubject,fontsSubject){this.configurables=configurablesSubject.asObservable(),this.fonts=fontsSubject.asObservable()}}class display_Display{constructor(_placement){this._placement=_placement,this.settings=_placement.display.placementDisplay,this.setDisplaySettings=this.setDisplaySettings.bind(this)}async setDisplaySettings(settings){this._placement.display.setDisplaySettings(settings),this._placement.isInteractiveResolvable.resolve(),setTimeout((()=>{this._placement.pluginToControllerCommunication.send(a_PLACEMENT_READY,{})}),20)}}var error_rest=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t};class PluginErrorService{constructor(_errorService,_pluginAlias){this._errorService=_errorService,this._pluginAlias=_pluginAlias}async raise(options){const{additionalInformation,message,level}=options,otherOptions=error_rest(options,["additionalInformation","message","level"]);this._errorService.report(Object.assign(Object.assign({name:"PluginError",reporter:"PLUGIN",integration:this._pluginAlias,message:message||"Plugin error raised.",severity:level},otherOptions),{additionalInformation}))}}class ParentInteraction{constructor(_placement){this._placement=_placement}async send(eventName,body){this._placement.parent.send(eventName,body)}onEvent(eventName){return this._placement.parent.onEvent(eventName)}}class PartnerInteraction{constructor(_placement){this._placement=_placement}async send(eventName,body){this._placement.pluginToControllerCommunication.send(eventName,body)}onEvent(event){return this._placement.pluginToControllerCommunication.on(event)}}class PluginContext{constructor(_placement,_sessionService,_contextService,_advertiserPageService,_configurationService,_partnerConfigService){this._placement=_placement,this._sessionService=_sessionService,this._contextService=_contextService,this._advertiserPageService=_advertiserPageService,this._configurationService=_configurationService,this._partnerConfigService=_partnerConfigService}getRuntimeInitTime(){return Promise.resolve(this._placement.runtimeInitTime)}getRoktAccountId(){return Promise.resolve(this._placement.partnerConfigService.getAccountId())}getParentInstanceId(){return Promise.resolve(this._placement.parentId)}getRoktPageInstanceGuid(){return this._placement.contextService.getPageInstanceGuid()}getAlias(){return Promise.resolve(this._placement.alias)}getLauncherInstanceId(){return Promise.resolve(this._contextService.getLauncherInstanceId())}getPluginInstanceId(){return Promise.resolve(this._placement.id)}getRoktTagId(){return Promise.resolve(this._placement.partnerConfigService.getTagId())}getRoktSessionId(){return Promise.resolve(this._sessionService.getSessionId())}getLanguage(){return Promise.resolve(this._contextService.getLanguage())}isSandboxed(){return Promise.resolve(this._placement.partnerConfigService.isSandbox())}isChildPlugin(){return this._placement.isChildPlugin()}isPlugin(){return Promise.resolve(!0)}close(){return Promise.resolve(this._placement.close.call(this._placement))}addAdvertiserWindowRef(windowRef,parentGuid){this._advertiserPageService.addActivePage(windowRef,parentGuid)}getApiUrl(){return Promise.resolve(this._configurationService.getApiUrl(this._placement.partnerConfigService.isSandbox()))}getOverrideLinkNavigation(){return this._partnerConfigService.getOverrideLinkNavigation()}}class PluginMetrics{constructor(_placement){this._placement=_placement,this._pluginMetricCode="PLUGING_METRICS_LOG_CALL",this.getFrameStart=async()=>new Date(this._placement.window.performance.timing.navigationStart)}async notifyInteractive(){if(void 0===this._placement.parentId){const recordedTime=Date.now();setInteractiveTime(recordedTime,this._placement.id),this._placement.pushMetric({origin:MetricOrigin_Plugin,name:MetricTimestampKey_PluginInteractive,recordedTime})}}async log(metricName,duration){this._placement.logMetric(this._pluginMetricCode,metricName,duration)}}class RDN{constructor(_rdnEventService,_contextService,_signalMiddlewareService){this._rdnEventService=_rdnEventService,this._contextService=_contextService,this._signalMiddlewareService=_signalMiddlewareService,this._contextService.getPageInstanceGuid().then((pageInstanceGuid=>{this._pageInstanceGuidForSync=pageInstanceGuid}))}async issueSignal(eventType,parentGuid,options={}){const{overrideTimestamp,transformedTrafficURL}=options,data={clientTimeStamp:overrideTimestamp?new Date(overrideTimestamp.toISOString()):void 0,transformedTrafficURL},event=this._buildRdnEvent(eventType,parentGuid,options),pageInstanceGuid=await this._contextService.getPageInstanceGuid();pageInstanceGuid&&(event.pageInstanceGuid=pageInstanceGuid),this._rdnEventService.triggerEvent(event,data)}async issueSignalSync(eventType,parentGuid,options={}){const{overrideTimestamp,transformedTrafficURL}=options,data={clientTimeStamp:overrideTimestamp?new Date(overrideTimestamp.toISOString()):void 0,transformedTrafficURL},event=this._buildRdnEvent(eventType,parentGuid,options);this._pageInstanceGuidForSync&&(event.pageInstanceGuid=this._pageInstanceGuidForSync),this._rdnEventService.triggerEvent(event,data)}async prepareExternalSignal(sendOnEvent,eventType,parentGuid,options={}){this._signalMiddlewareService.queueSignal(sendOnEvent,this.issueSignalSync.bind(this),eventType,parentGuid,options)}_buildRdnEvent(eventType,parentGuid,options){const{instanceGuid,attributes,metadata,objectData}=options;return{eventType,parentGuid,instanceGuid,attributes,metadata,objectData}}}class RoktPlugin{constructor(placement,sessionService,contextService,{attributesService,advertiserPageService,environmentConfigService,signalMiddlewareService,partnerConfigService}){if(void 0===placement.parentId){const recordedTime=Date.now();placement.pushMetric({origin:MetricOrigin_Plugin,name:MetricTimestampKey_PluginBootstrapEnd,recordedTime}),setPlacementTiming({name:TimingMetrics_pluginBootstrapEnd,value:recordedTime},placement.id)}this.config=pipe_pipe(placement.config)(map_map((newConfig=>newConfig))),this.display=new display_Display(placement),this.context=new PluginContext(placement,sessionService,contextService,advertiserPageService,environmentConfigService,partnerConfigService),this.childPlugin=new ChildPluginFactory(placement),this.parentInteraction=new ParentInteraction(placement),this.partnerInteraction=new PartnerInteraction(placement),this.rdn=new RDN(placement.rdnEventService,placement.contextService,signalMiddlewareService),this.metrics=new PluginMetrics(placement),this.error=new PluginErrorService(placement.errorService,placement.alias),this.theme=new Theme(placement.configurables,placement.fonts),this.attributes=attributesService.onChange(placement.selectionId)}}class DomainTransferService{constructor(_coreControllerPromise,_webapi,_envConfigService,_partnerConfigService,_contextService,_errorService){this._coreControllerPromise=_coreControllerPromise,this._webapi=_webapi,this._envConfigService=_envConfigService,this._partnerConfigService=_partnerConfigService,this._contextService=_contextService,this._errorService=_errorService}async transferDomain(selectionContext){try{const coreController=await this._coreControllerPromise;if(!this._envConfigService.isDomainProxied()||this._partnerConfigService.getDoNotTrack())return;const{cookies,localStorage}=await coreController.getRoktDomainRecognisers(),headers=Object.assign(Object.assign(Object.assign({},cookies[RECOGNISER_KEY]&&"undefined"!==cookies[RECOGNISER_KEY]?{[HeaderKey_ROKT_SESSION_THIRD_PARTY_COOKIE_HEADER_KEY]:cookies[RECOGNISER_KEY]}:{}),localStorage[RECOGNISER_KEY]&&"undefined"!==localStorage[RECOGNISER_KEY]?{[HeaderKey_ROKT_SESSION_THIRD_PARTY_LOCAL_STORAGE_HEADER_KEY]:localStorage[RECOGNISER_KEY]}:{}),{[HeaderKey_ROKT_PAGE_INSTANCE_GUID]:selectionContext.getPageInstanceGuid(),[HeaderKey_ROKT_PAGE_URL_HEADER_KEY]:this._contextService.getPartnerUrl()});"undefined"!==cookies[RECOGNISER_KEY]&&"undefined"!==localStorage[RECOGNISER_KEY]||this._errorService.report(create_contextual_error_createContextualError(new Error("Undefined recogniser"),{additionalInformation:{localStorage:localStorage[RECOGNISER_KEY],cookie:cookies[RECOGNISER_KEY]},code:error_codes_ErrorCodes.DOMAIN_TRANSFER,severity:wsdk_error_WSDKErrorSeverity.WARNING}));const response=await this._webapi.get(Endpoint_DOMAIN_TRANSFER,headers);localStorage[RECOGNISER_KEY]||response.headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_LOCAL_STORAGE_HEADER_KEY]||this._errorService.report(create_contextual_error_createContextualError(new Error("Local storage failed"),{additionalInformation:{localStorage:localStorage[RECOGNISER_KEY],newLocalStorage:response.headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_LOCAL_STORAGE_HEADER_KEY]},code:error_codes_ErrorCodes.DOMAIN_TRANSFER,severity:wsdk_error_WSDKErrorSeverity.WARNING})),cookies[RECOGNISER_KEY]||response.headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_COOKIE_HEADER_KEY]||this._errorService.report(create_contextual_error_createContextualError(new Error("Cookies failed"),{additionalInformation:{cookie:cookies[RECOGNISER_KEY],newCookie:response.headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_COOKIE_HEADER_KEY]},code:error_codes_ErrorCodes.DOMAIN_TRANSFER,severity:wsdk_error_WSDKErrorSeverity.WARNING}));const newCookie={[RECOGNISER_KEY]:response.headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_COOKIE_HEADER_KEY]},newLocalStorage={[RECOGNISER_KEY]:response.headers[HeaderKey_ROKT_SESSION_THIRD_PARTY_LOCAL_STORAGE_HEADER_KEY]};await coreController.setRoktDomainRecognisers({cookies:newCookie,localStorage:newLocalStorage})}catch(error){this._errorService.report(create_contextual_error_createContextualError(error,{code:error_codes_ErrorCodes.DOMAIN_TRANSFER,severity:wsdk_error_WSDKErrorSeverity.WARNING}))}}}class ServiceContainer{constructor(coreControllerPromise){this.window=getWindow(),this.errorServicePromise=new resolvable_promise_ResolvablePromise,this.localStorageService=new LocalStorageService(this.window),this.sessionStorageService=new SessionStorageService(this.window),this.cookieService=new CookieService(this.window),this.thirdPartyRecogniserAccessor=new ThirdPartyRecogniserAccessor(this.cookieService,this.localStorageService),this.contextService=new ContextService(this.window),this.partnerConfigService=new PartnerConfigurationService,this.environmentConfigService=new EnvironmentConfigurationService(this.window),this.integrationConfigurationService=new IntegrationConfigurationService,this.performanceService=new PerformanceService(this.window),this.httpClient=new HttpClientService(this.window),this.journeyManagerService=new JourneyManagerService,this.placementsRegister=new PlacementRegister,this.launcherEventsService=new LauncherEventsService,this.blockDetectionService=new BlockDetectionService(this.window),this.coreControllerPromise=coreControllerPromise,this.launcherWindowService=new LauncherWindowService(this.coreControllerPromise,this.errorServicePromise.promise),this.firstPartyRecogniserAccessor=new FirstPartyRecogniserAccessor(this.launcherWindowService.getCookiesService(),this.launcherWindowService.getLocalStorageService()),this.referralService=new ReferralService,this.signalMiddlewareService=new SignalMiddlewareService,this.sessionCookieService=new SessionCookieService(this.launcherWindowService.getCookiesService(),this.launcherEventsService),this.globalSessionAccessor=new GlobalSessionAccessor(this.sessionStorageService,this.sessionCookieService,this.partnerConfigService,this.environmentConfigService),this.globalSessionService=new GlobalSessionService(this.partnerConfigService,this.globalSessionAccessor,this.errorServicePromise.promise),this.webApiService=new WebAPIService({httpClient:this.httpClient,sessionService:this.globalSessionService,envConfig:this.environmentConfigService,partnerService:this.partnerConfigService,contextService:this.contextService,integrationConfigurationService:this.integrationConfigurationService}),this.errorService=new ErrorService(this.webApiService,this.environmentConfigService,this.integrationConfigurationService,this.contextService),this.loggingService=new LoggingService(this.errorService,this.webApiService,this.integrationConfigurationService,this.environmentConfigService),this.attributesService=new AttributesService(this.errorService),this.eventDataService=new EventDataService(this.localStorageService,this.errorService,this.globalSessionService),this.rdnMetricEventService=new RdnMetricEventService(this.webApiService,this.globalSessionService,this.contextService,this.loggingService,this.errorService,this.blockDetectionService),this.rdnEventService=new RdnEventService(this.webApiService,this.globalSessionService,this.errorService,this.contextService,this.blockDetectionService,this.eventDataService),this.locationChangeTrackService=new LocationChangeTrackService,this.pageFireTrackingService=new PageFireTrackingService(this.environmentConfigService,this.errorService),this.domainTransferService=new DomainTransferService(this.coreControllerPromise,this.webApiService,this.environmentConfigService,this.partnerConfigService,this.contextService,this.errorService),this.recogniserService=new RecogniserService(this.partnerConfigService,this.firstPartyRecogniserAccessor,this.thirdPartyRecogniserAccessor),this.advertiserPageService=new AdvertiserPageService(this.rdnEventService,this.partnerConfigService),this.roktPluginFactory=function(serviceContainer){const{errorService,placementsRegister}=serviceContainer;return async function(corePlugin){let placement;placement=corePlugin.parent?getPlacement(corePlugin.parent.id).createChildPlacement(corePlugin):getPlacement(corePlugin.id);const{sessionService:selectionSessionService,contextService:selectionContextService}=placement;return new RoktPlugin(placement,selectionSessionService,selectionContextService,serviceContainer)};function getPlacement(id){const placement=placementsRegister.get(id);if(!placement){const error=new ContextualError({code:constants_error_codes_ErrorCodes_PLACEMENT_NOT_FOUND,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{placementId:id}});errorService.throw(error)}return placement}}(this),this.selectionContainerFactory=async context=>{const coreController=await coreControllerPromise;return new SelectionServiceContainer(this,coreController,context)},this.selectionMiddlewareService=new SelectionMiddlewareService,this.selectionService=new SelectionService({environmentConfigService:this.environmentConfigService,errorService:this.errorService,launcherWindowService:this.launcherWindowService,partnerConfigService:this.partnerConfigService,recogniserService:this.recogniserService,referralService:this.referralService,globalSessionService:this.globalSessionService,selectionContainerFactory:this.selectionContainerFactory,selectionMiddlewareService:this.selectionMiddlewareService,webApiService:this.webApiService,performanceService:this.performanceService,contextService:this.contextService,attributesService:this.attributesService,launcherEventsService:this.launcherEventsService,domainTransferService:this.domainTransferService,blockDetectionService:this.blockDetectionService,loggingService:this.loggingService,eventDataService:this.eventDataService}),this.partnerValidationService=new PartnerValidationService(this.selectionService),this.signalManagementService=new SignalManagementService(this.rdnEventService,this.partnerConfigService,this.selectionService,this.errorService),this.placementMonitoringService=new PlacementMonitoringService(new PlacementMissizeService(coreControllerPromise,this.errorService),new PlacementCoveredService(coreControllerPromise,this.errorService),new PlacementResizeService)}}async function createRoktController(windowRef){const integrationUrl=getIntegrationUrl(new URL(windowRef.location.href));if(windowRef===windowRef.top)return;const coreControllerResolvablePromise=new resolvable_promise_ResolvablePromise,services=new ServiceContainer(coreControllerResolvablePromise.promise);registerServices(services);const createLauncherExtension=createRoktLauncherFactory(services,coreControllerResolvablePromise.promise),createSelectionExtension=createSelectionServiceFactory(services),coreControllerPromise=createController({windowRef,createLauncherExtension,pluginLibraryFactory:services.roktPluginFactory,domainTransferOrigin:"https://apps.rokt.com",createSelectionServiceExtension:createSelectionExtension});Promise.race([coreControllerPromise.then((async coreController=>(await coreController.connection.onReady(),coreController))),sleep(13e3)]).then((result=>async function(coreController,coreControllerPromise,integrationUrl){if(!coreController){!function(integrationUrl){const errReport=createErrorReport("",error_codes_ErrorCodes.CONTROLLER_CONNECTION_TIMEOUT,error_codes_ErrorCodes.CONTROLLER_CONNECTION_TIMEOUT,wsdk_error_WSDKErrorSeverity.INFO);(0,integration.reportError)(errReport,integrationUrl)}(integrationUrl);const coreController=await coreControllerPromise;await coreController.connection.onReady(),function(integrationUrl){const errReport=createErrorReport("",error_codes_ErrorCodes.LATE_CONTROLLER_CONNECTION,error_codes_ErrorCodes.LATE_CONTROLLER_CONNECTION,wsdk_error_WSDKErrorSeverity.INFO);(0,integration.reportError)(errReport,integrationUrl)}(integrationUrl)}}(result,coreControllerPromise,integrationUrl))).catch((error=>reportCoreControllerError(error,integrationUrl)));try{const coreController=await coreControllerPromise;await coreController.connection.onReady(),coreControllerResolvablePromise.resolve(coreController),coreController.onError().subscribe((error=>{const contextError=create_contextual_error_createContextualError(error);services.errorService.report(contextError)}))}catch(e){reportCoreControllerError(e,integrationUrl)}!async function(services){try{const locationService=await services.launcherWindowService.getLocationService(),href=await locationService.getHref(),url=new URL(href).origin;services.contextService.setPartnerUrl(url)}catch(e){}}(services),function(windowRef,errorService){var _a;const controllerWindow=windowRef;null===(_a=controllerWindow.roktReporter)||void 0===_a||_a.set(errorService.report.bind(errorService))}(windowRef,services.errorService)}function initialiseSessionTransfer(){if("https://apps.rokt.com"!==window.location.origin&&!isBrowserExtension(window.location.origin)){const iframe=document.createElement("iframe"),canaryPath="";iframe.src=`https://apps.rokt.com/wsdk/${canaryPath}session-transfer/index.2.6685.0.html`,iframe.name=window.location.origin,iframe.style.display="none",document.body.appendChild(iframe)}}(()=>{const unsubscribe=controllerEventDispatcherPipe.subscribe();(()=>{var _a;port1.start();const event=createRoktQueryEvent(event_types_event_type_EventType.Launcher,event_type_TopicType.Launcher_ControllerNotification_Ready,{});try{null===(_a=null===window||void 0===window?void 0:window.parent)||void 0===_a||_a.postMessage(event,"*",[port2])}catch(e){const error=e;reportWSDKError({name:"Observable Notification: can not share port to launcher",message:null==error?void 0:error.message,stack:null==error?void 0:error.stack})}})(),preloadTimingMetrics()})(),(async()=>{initializePluginEventListening();const activeControllerExtensions=await getControllerExtensions(),integrationUrl=await extension_vnext_service_getIntegrationUrl(),extensionAPI=(reportError=>new ExtensionVNextAPI(reportError))(reportWSDKError);for(const extensionName of activeControllerExtensions){const url=`${integrationUrl}/wsdk/extensions/${extensionName}/index.mjs`;let module;try{module=await dynamicImport(url)}catch(importError){const error=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.EXTENSION_LOAD_ERROR,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{extensionName,url,error:importError instanceof Error?importError.message:String(importError)}});reportWSDKError(error);continue}try{(0,module.default)({extensionSubjects:extensionSubject$}),extensionAPI.registerExtension(extensionName)}catch(setupError){const error=create_contextual_error_createContextualError({code:error_codes_ErrorCodes.EXTENSION_INITIALIZATION_ERROR,severity:wsdk_error_WSDKErrorSeverity.ERROR,additionalInformation:{extensionName,error:setupError instanceof Error?setupError.message:String(setupError)}});reportWSDKError(error)}}extensionAPI.setExtensionData.bind(extensionAPI)})(),function(){global_reporter_main(),initialiseSessionTransfer();createRoktController(getWindow())}()})()})();
//# sourceMappingURL=https://sourcemaps-wsdk.roktinternal.com/controller/controller.2.6685.0.js.map</script>

</body></html>